# 正常还款 vs 清算流程完整对比

## 📋 **概述**

本文档详细对比了RWA借贷平台中正常还款和清算两种场景的完整流程，包括资金流向、积分变化和系统调用。

## 🔄 **正常还款流程（已接入积分：借款锁定、按期释放/提前或逾期扣罚）**

### **完整流程（订单型路径）**

```
用户主动还款 → 计算是否按期且足额
            ↓
调用 LendingEngine.repay(orderId, repayAmount)
            ↓
账本与转账：计提手续费→路由、贷方收款
            ↓
触发 RewardManager.onLoanEvent(user, amount, duration=0, isOnTimeAndFullyRepaid)
            ↓
按规则释放借款时锁定的积分，或执行提前/逾期扣罚（不足记入欠分账本）
```

关键代码（还款后触发积分入口，duration=0，是否按期且足额由引擎计算）：

```solidity
// contracts/core/LendingEngine.sol
address rewardManager = IRegistry(_registryAddr).getModuleOrRevert(ModuleKeys.KEY_RM);
try IRewardManager(rewardManager).onLoanEvent(ord.borrower, _repayAmount, 0, isOnTimeAndFullyRepaid) { } catch { }
```

说明：RewardManager 的还款事件由订单引擎路径统一触发，Vault 账本模块（`VaultLendingEngine`）不再直接触发，避免重复计分。

### **积分处理规则（当前实现）**

- 借款（duration > 0）：不立即发放积分，先“锁定积分”并记录到期时间；
- 还款（duration = 0）：
  - 按期且足额：释放锁定积分，先抵扣历史欠分，再为用户实际铸分；
  - 提前或逾期：作废锁定并扣罚（按配置 BPS）。若余额不足，记入“欠分账本”。

### **资金流向（示例）**

以“本金 95USDC、抵押物市值 100USDC”的简单示例说明（具体以合约计算为准）：
- 用户 → 平台：还款金额（含手续费部分给 FeeRouter）
- 平台 → 贷方：净还款金额
- 积分：按上述规则释放/扣罚

## ⚡ **清算流程（已完整实现）**

### **完整流程**

```
用户违约 → 健康因子低于105%
         ↓
Keeper触发清算
         ↓
扣押抵押物 + 减少债务
         ↓
计算残值并分配
         ↓
✅ 执行积分惩罚（已实现）
```

### **详细步骤**

#### **1. 风险检测与触发**
- 由风控/视图模块计算健康因子并与阈值对比（如 105%/110% 可配置）；
- Keeper 或自动化服务在满足条件时触发清算。

#### **2. 执行清算**
统一由清算编排（业务逻辑）模块发起调用，保证原子性与可观测性。

#### **3. 扣押抵押物**
抵押管理模块完成抵押物的扣押，失败即回滚整笔清算。

#### **4. 减少债务**
账本模块（或其清算专用接口）减少用户债务，保持仓位一致性。

#### **5. 残值分配**
```solidity
// 计算残值：100USDC - 95USDC = 5USDC
ResidualAllocation allocation = VaultMath.calculateResidualAllocation(100, 95);

// 分配残值：
// - 平台收入：5 * 3% = 0.15USDC
// - 风险准备金：5 * 2% = 0.1USDC  
// - 出借人补偿：5 * 17% = 0.85USDC
// - 清算人奖励：5 * 78% = 3.9USDC
```

#### **6. 保证金与积分处理（已实现）**
- 清算关联的扣罚优先通过“保证金模块”执行（没收锁定保证金）；
- 如需对用户直接扣分或登记欠分，由具备权限的模块调用奖励系统扣罚入口（不足则记入欠分账本）。

### **资金流向**
```
用户钱包: -100USDC RWAToken（抵押物被扣押）
合约: +100USDC RWAToken - 95USDC = +5USDC RWAToken残值
清算人: +3.9USDC RWAToken奖励
平台: +0.15USDC RWAToken收入
风险池: +0.1USDC RWAToken
出借人: +95USDC + 0.85USDC RWAToken = +95.85USDC
```

## 📊 **关键差异对比**

### **1. 触发条件**
| 场景 | 触发条件 | 健康因子 |
|------|----------|----------|
| 正常还款 | 用户主动还款 | 正常（>1.05） |
| 清算 | 系统自动触发 | 异常（<1.05） |

### **2. 积分变化**
| 场景 | 积分变化 | 实现状态 |
|------|----------|----------|
| 正常还款 | 借款锁定 → 按期释放；提前/逾期扣罚（不足记欠分） | ✅ 已实现（LE→RM→RMCore） |
| 清算 | 没收保证金为主；可选积分扣罚（按权限入口） | ✅ 已实现（GF/RM 扣罚） |

### **3. 资金流向**
| 场景 | 用户收益 | 系统收益 |
|------|----------|----------|
| 正常还款 | +5USDC RWAToken | -5USDC RWAToken |
| 清算 | -100USDC RWAToken | +5USDC RWAToken |

### **4. 系统调用**
| 场景 | 主要调用 | 积分调用 |
|------|----------|----------|
| 正常还款 | LendingEngine.repay(orderId, amount) | ✅ LendingEngine → RewardManager.onLoanEvent |
| 清算 | 业务编排 liquidate(...) | ✅ 保证金没收；必要时调用扣罚入口 |

## ✅ **当前状态与注意事项**

1) 奖励触发路径统一：订单引擎（LendingEngine）在还款完成后触发积分入口；Vault 账本侧不重复触发，避免双计。  
2) 借款对应积分采用“锁定-释放/扣罚”机制，释放前先抵扣历史欠分，防止累积风险。  
3) 清算侧以“保证金没收”为主，如需积分层面的惩罚/追责，需通过具备权限的模块调用扣罚入口。

## ✅ **建议与配套**

1) 在前端与测试文档中明确：还款积分事件来自 LendingEngine，Vault 账本仅做仓位/统计更新；  
2) 为清算流程补充“是否需要积分扣罚”的可配置项，并通过 Registry 管理调用权限；  
3) 在 RewardView 增加“欠分账本/锁定积分”只读接口的示例用法说明，便于运营核对；  
4) 在监控告警中加入积分释放/扣罚异常的可观测事件，辅助运维排障。

## 🎯 **完整流程对比总结**

### **正常还款（需要修复）**
1. ✅ 资金转移正确
2. ✅ 债务记录正确
3. ✅ 抵押物返还正确
4. ❌ 积分奖励缺失

### **清算（已完整实现）**
1. ✅ 违约检测正确
2. ✅ 抵押物扣押正确
3. ✅ 债务减少正确
4. ✅ 残值分配正确
5. ✅ 积分惩罚正确

## 🚀 **下一步行动**

1. **修复正常还款积分奖励**
   - 在VaultLendingEngine.repay()中添加RewardManager调用
   - 实现_notifyRewardManager()函数

2. **完善积分计算逻辑**
   - 区分借款和还款的积分计算
   - 添加健康因子奖励机制

3. **测试验证**
   - 测试正常还款积分奖励
   - 测试清算积分惩罚
   - 验证积分债务抵扣机制

---

*本文档详细对比了正常还款和清算的完整流程，识别了当前缺失的积分奖励机制，并提供了具体的修复建议。* 