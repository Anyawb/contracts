# åŒæ¶æ„æ¨¡å¼åˆ†æä¸æ½œåœ¨é—®é¢˜æŠ¥å‘Š

> **æœ€åæ›´æ–°**: 2025-12-15  
> **åˆ†æèŒƒå›´**: Architecture-Guide.md + å®é™…ä»£ç å®ç°

## ğŸ“‹ æ¶æ„æ¦‚è¿°

æ‚¨çš„é¡¹ç›®é‡‡ç”¨äº†ä¸€ç§ç‹¬ç‰¹çš„**åŒæ¶æ„è®¾è®¡**æ¨¡å¼ï¼Œç»“åˆäº†ï¼š
1. **äº‹ä»¶é©±åŠ¨æ¶æ„** - æ‰€æœ‰æ“ä½œé€šè¿‡äº‹ä»¶è®°å½•ï¼Œæ”¯æŒæ•°æ®åº“æ”¶é›†å’ŒAIåˆ†æ
2. **Viewå±‚ç¼“å­˜æ¶æ„** - æä¾›å¿«é€Ÿå…è´¹æŸ¥è¯¢ï¼Œæ‰€æœ‰æŸ¥è¯¢å‡½æ•°ä½¿ç”¨viewï¼ˆ0 gasï¼‰

### æ¶æ„æµç¨‹
```
ç”¨æˆ·æ“ä½œ â†’ VaultCore â†’ VaultRouter â†’ ä¸šåŠ¡æ¨¡å— â†’ è´¦æœ¬æ›´æ–°
                              â†“
                        æ•°æ®æ¨é€æ¥å£
                              â†“
                    Viewå±‚ç¼“å­˜ + äº‹ä»¶å‘å‡º
                              â†“
                    æ•°æ®åº“æ”¶é›† + å…è´¹æŸ¥è¯¢
```

---

##  æ¶æ„è´¨é‡è¯„ä¼°

| è¯„ä¼°é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| **è®¾è®¡å®Œæ•´æ€§** | âŒ ä¸¥é‡ç¼ºå¤± | æ ¸å¿ƒå€Ÿè´·æµç¨‹ï¼ˆBorrow/Repayï¼‰æ§åˆ¶æµæ–­è£‚ï¼Œæ— æ³•æ‰§è¡Œ |
| **æ¨¡å—åŒ–ç¨‹åº¦** | âœ… è‰¯å¥½ | æ¨¡å—æ‹†åˆ†åˆç†ï¼ŒèŒè´£æ¸…æ™° |
| **å®‰å…¨æ€§** | âš ï¸ éœ€è¦å…³æ³¨ | åŒå…¥å£é£é™©ã€ç¼“å­˜ä¸€è‡´æ€§éœ€è¦é‡ç‚¹æµ‹è¯• |
| **å¯ç»´æŠ¤æ€§** | âš ï¸ å¾…æ”¹è¿› | VaultLendingEngine è¿‡å¤§ï¼Œéœ€è¦æ‹†åˆ† |
| **æ–‡æ¡£å‡†ç¡®æ€§** | âŒ éœ€æ›´æ–° | ä»£ç ç¤ºä¾‹ä¸å®ç°ä¸ä¸€è‡´ï¼Œä¸”éƒ¨åˆ†å£°æ˜ï¼ˆå¦‚å¥–åŠ±é›†æˆï¼‰ä¸ä»£ç å®Œå…¨è„±èŠ‚ |
| **æµ‹è¯•è¦†ç›–** | ğŸ”„ å¾…éªŒè¯ | éœ€è¦éªŒè¯ç«¯åˆ°ç«¯æµ‹è¯•è¦†ç›– |

## ğŸ” ç±»ä¼¼é¡¹ç›®è°ƒç ”

### 1. äº‹ä»¶é©±åŠ¨æ¶æ„åœ¨DeFiä¸­çš„ä½¿ç”¨

**å¸¸è§æ¨¡å¼**ï¼š
- âœ… **Uniswap V3** - ä½¿ç”¨äº‹ä»¶è®°å½•æ‰€æœ‰äº¤æ˜“å’ŒæµåŠ¨æ€§å˜åŒ–
- âœ… **Aave** - äº‹ä»¶é©±åŠ¨çš„å‰ç«¯æ›´æ–°æœºåˆ¶
- âœ… **Compound** - äº‹ä»¶è®°å½•å€Ÿè´·å’Œæ¸…ç®—æ“ä½œ
- âœ… **The Graph** - ä¸“é—¨ç´¢å¼•åŒºå—é“¾äº‹ä»¶çš„æœåŠ¡

**ç‰¹ç‚¹**ï¼šå¤§å¤šæ•°DeFié¡¹ç›®éƒ½ä½¿ç”¨äº‹ä»¶é©±åŠ¨ï¼Œä½†é€šå¸¸**ä¸åœ¨é“¾ä¸Šç»´æŠ¤ç¼“å­˜**ï¼Œè€Œæ˜¯ä¾èµ–é“¾ä¸‹ç´¢å¼•æœåŠ¡ï¼ˆå¦‚The Graphï¼‰æ¥æä¾›æŸ¥è¯¢èƒ½åŠ›ã€‚

### 2. Viewå±‚ç¼“å­˜æ¨¡å¼

**å¸¸è§æ¨¡å¼**ï¼š
- âœ… **MakerDAO** - ä½¿ç”¨é“¾ä¸Šç¼“å­˜ä¼˜åŒ–æŸ¥è¯¢ï¼ˆä½†ä¸»è¦ç”¨äºä»·æ ¼æ•°æ®ï¼‰
- âœ… **Synthetix** - ä½¿ç”¨é“¾ä¸Šç¼“å­˜å­˜å‚¨èšåˆæ•°æ®
- âš ï¸ **è¾ƒå°‘é¡¹ç›®åœ¨é“¾ä¸Šç»´æŠ¤å®Œæ•´çš„ç”¨æˆ·çŠ¶æ€ç¼“å­˜**

**ç‰¹ç‚¹**ï¼šå¤§å¤šæ•°é¡¹ç›®é€‰æ‹©é“¾ä¸‹ç¼“å­˜ï¼ˆæ•°æ®åº“ï¼‰ï¼Œè€Œä¸æ˜¯é“¾ä¸Šç¼“å­˜ï¼Œå› ä¸ºï¼š
- é“¾ä¸Šå­˜å‚¨æˆæœ¬é«˜
- é“¾ä¸‹ç¼“å­˜æ›´çµæ´»
- é“¾ä¸‹å¯ä»¥å¤„ç†å¤æ‚æŸ¥è¯¢

### 3. åŒæ¶æ„ç»“åˆæ¨¡å¼

**è°ƒç ”ç»“æœ**ï¼š
- âŒ **æœªå‘ç°å…¶ä»–é¡¹ç›®æ˜ç¡®é‡‡ç”¨"äº‹ä»¶é©±åŠ¨ + Viewå±‚ç¼“å­˜"çš„åŒæ¶æ„æ¨¡å¼**
- âš ï¸ **æ‚¨çš„é¡¹ç›®å¯èƒ½æ˜¯é¦–åˆ›æˆ–å°‘æ•°é‡‡ç”¨æ­¤æ¨¡å¼çš„é¡¹ç›®ä¹‹ä¸€**

**åŸå› åˆ†æ**ï¼š
1. **æˆæœ¬è€ƒè™‘**ï¼šé“¾ä¸Šç¼“å­˜éœ€è¦é¢å¤–çš„å­˜å‚¨æˆæœ¬
2. **å¤æ‚æ€§**ï¼šéœ€è¦ç»´æŠ¤ä¸¤å¥—æ•°æ®ï¼ˆè´¦æœ¬ + ç¼“å­˜ï¼‰çš„ä¸€è‡´æ€§
3. **ä¼ ç»Ÿæ–¹æ¡ˆ**ï¼šå¤§å¤šæ•°é¡¹ç›®ä½¿ç”¨é“¾ä¸‹ç´¢å¼•æœåŠ¡ï¼ˆThe Graphç­‰ï¼‰

---

## ğŸ”´ æ–‡æ¡£ä¸ä»£ç ä¸€è‡´æ€§é—®é¢˜

### 1. VaultCore ä»£ç ç¤ºä¾‹ä¸å®é™…ä¸ä¸€è‡´ âš ï¸ **éœ€æ›´æ–°** âœ… å·²ä¿®æ”¹

#### é—®é¢˜æè¿°
Architecture-Guide.md æ–‡æ¡£ä¸­çš„ä»£ç ç¤ºä¾‹ä½¿ç”¨**å­—ç¬¦ä¸²ç±»å‹**æ“ä½œæ ‡è¯†ç¬¦ï¼Œè€Œå®é™…ä»£ç ä½¿ç”¨ **bytes32 å¸¸é‡**ã€‚

#### æ–‡æ¡£æè¿°ï¼ˆç¬¬67-110è¡Œï¼‰ï¼š
```solidity
// æ–‡æ¡£ä¸­æ˜¾ç¤ºï¼šä½¿ç”¨ "DEPOSIT"ã€"BORROW" å­—ç¬¦ä¸²ç±»å‹
function deposit(address asset, uint256 amount) external {
    IVaultRouter(viewContractAddrVar).processUserOperation(msg.sender, "DEPOSIT", asset, amount, block.timestamp);
}
```

#### å®é™…ä»£ç ï¼ˆVaultCore.solï¼‰ï¼š
```solidity
// å®é™…ä½¿ç”¨ ActionKeys.ACTION_DEPOSIT (bytes32 ç±»å‹)
function deposit(address asset, uint256 amount) external {
    IVaultRouter(_viewContractAddr).processUserOperation(msg.sender, ActionKeys.ACTION_DEPOSIT, asset, amount, block.timestamp);
}
```

#### å‘½åè§„èŒƒè¯´æ˜
æ ¹æ® `SmartContractStandard.md` ç¬¬131è¡Œå’Œ `ActionKeys.sol` çš„å®é™…å®ç°ï¼š
- âœ… **æ­£ç¡®å‘½å**ï¼šä½¿ç”¨å¸¦ä¸‹åˆ’çº¿çš„ UPPER_SNAKE_CASEï¼Œå¦‚ `ACTION_DEPOSIT`ã€`ACTION_BORROW`ã€`ACTION_REPAY`ã€`ACTION_WITHDRAW`
- âŒ **é”™è¯¯å‘½å**ï¼šä¸ä½¿ç”¨ä¸å¸¦ä¸‹åˆ’çº¿çš„å‘½åï¼Œå¦‚ `ACTIONDEPOSIT`ã€`ACTIONBORROW`
- æ‰€æœ‰ ActionKeys å¸¸é‡éƒ½éµå¾ª `ACTION_XXX` æ ¼å¼ï¼Œç±»å‹ä¸º `bytes32 constant`

#### å½±å“
- âŒ å¼€å‘è€…å¯èƒ½æŒ‰ç…§æ–‡æ¡£ç¼–å†™é”™è¯¯ä»£ç 
- âŒ é›†æˆæµ‹è¯•å¯èƒ½åŸºäºé”™è¯¯å‡è®¾

#### è§£å†³æ–¹æ¡ˆ
æ›´æ–° Architecture-Guide.md ä¸­çš„ä»£ç ç¤ºä¾‹ä»¥åæ˜ å®é™…å®ç°ã€‚

### 2. å‘½åè§„èŒƒä¸ä¸€è‡´ âœ… å·²ä¿®å¤

#### é—®é¢˜æè¿°
æ–‡æ¡£è§„èŒƒï¼ˆç¬¬648-653è¡Œï¼‰è§„å®šï¼š
- ç§æœ‰å˜é‡ä½¿ç”¨ `_camelCase` æ ¼å¼
- å…¬å…±å˜é‡ä½¿ç”¨ `camelCaseVar` æ ¼å¼

#### å®é™…ä»£ç é—®é¢˜ï¼ˆå·²ä¿®å¤ï¼‰ï¼š
- `VaultCore.sol` ç§æœ‰å˜é‡å·²ä» `_registryAddrVar` é‡å‘½åä¸º `_registryAddr`
- `VaultRouter.sol` ç§æœ‰å˜é‡å·²ä» `_registryAddrVar` é‡å‘½åä¸º `_registryAddr`

#### å½±å“
- âœ… ä»£ç é£æ ¼å·²ç»Ÿä¸€ï¼Œç¬¦åˆå‘½åè§„èŒƒ
- âœ… æ–°å¼€å‘è€…ä¸å†è¢« `Var` åç¼€è¯¯å¯¼

#### ä¿®å¤æ–¹æ¡ˆ
1. **ä»£ç ä¿®æ”¹**ï¼š
   - åœ¨ `VaultCore.sol` ä¸­å°†ç§æœ‰å˜é‡ `_registryAddrVar` é‡å‘½åä¸º `_registryAddr`ï¼Œå¹¶æ›´æ–°æ‰€æœ‰å¼•ç”¨ï¼ˆå…±11å¤„ï¼‰
   - åœ¨ `VaultRouter.sol` ä¸­å°†ç§æœ‰å˜é‡ `_registryAddrVar` é‡å‘½åä¸º `_registryAddr`ï¼Œå¹¶æ›´æ–°æ‰€æœ‰å¼•ç”¨ï¼ˆå…±12å¤„ï¼‰
   - åŒæ­¥æ›´æ–° `docs/Architecture-Guide.md` ä¸­çš„ç¤ºä¾‹ä»£ç ï¼Œç¡®ä¿æ–‡æ¡£ä¸ä»£ç ä¸€è‡´

2. **æµ‹è¯•éªŒè¯**ï¼š
   - âœ… `test/VaultRouter.test.ts` - 29ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡
   - âœ… `test/Vault/viewContractAddrVar.comprehensive.test.ts` - 13ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡
   - âœ… `test/Vault/VaultLendingEngine.dual-entry.test.ts` - 29ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡
   - âœ… `test/Vault/view/VaultRouter.cache-consistency.test.ts` - 20ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡
   - âœ… `test/VaultBusinessLogic.test.ts` - 73ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡
   - âœ… `test/Vault/modules/CollateralManager.liquidation-access.test.ts` - 1ä¸ªæµ‹è¯•é€šè¿‡
   - âœ… `test/Vault/liquidation/LiquidationDebtManager.cache-push.test.ts` - 2ä¸ªæµ‹è¯•é€šè¿‡

3. **æµ‹è¯•è¦†ç›–èŒƒå›´**ï¼š
   - æ¨¡å—é—´é€šä¿¡ï¼šéªŒè¯æ‰€æœ‰æ¨¡å—èƒ½æ­£ç¡®é€šè¿‡ `VaultCore.viewContractAddrVar()` è§£æ `VaultRouter` åœ°å€
   - ä»“ä½æ¨é€åŠŸèƒ½ï¼šéªŒè¯ `_pushUserPositionToView` åœ¨ borrow/repay æ—¶æ­£å¸¸å·¥ä½œ
   - ç¼“å­˜ä¸€è‡´æ€§ï¼šéªŒè¯ç¼“å­˜æœºåˆ¶ä¸è´¦æœ¬æ•°æ®åŒæ­¥
   - æƒé™æ§åˆ¶ï¼šéªŒè¯æƒé™éªŒè¯æœºåˆ¶æ­£å¸¸å·¥ä½œ
   - è¾¹ç•Œæ¡ä»¶ï¼šéªŒè¯é›¶åœ°å€ã€å¤§æ•°å€¼ç­‰è¾¹ç•Œæƒ…å†µå¤„ç†

---

## âš ï¸ æ½œåœ¨é—®é¢˜åˆ†æ

### 1. ç¼“å­˜æ•°æ®ä¸€è‡´æ€§é—®é¢˜ âš ï¸ **é«˜é£é™©** âœ… å·²è§£å†³

#### é—®é¢˜æè¿°
- Viewå±‚ç¼“å­˜ä¸è´¦æœ¬æ•°æ®å¯èƒ½ä¸åŒæ­¥
- å¦‚æœä¸šåŠ¡æ¨¡å—æ¨é€å¤±è´¥ï¼Œç¼“å­˜ä¼šè¿‡æ—¶
- ç¼“å­˜è¿‡æœŸæœºåˆ¶ï¼ˆ5åˆ†é’Ÿï¼‰å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´

#### å½“å‰çŠ¶æ€ï¼ˆå·²å®æ–½è§£å†³æ–¹æ¡ˆï¼‰
- âœ… **ç¼“å­˜éªŒè¯æœºåˆ¶**ï¼š`getUserPositionWithValidity()` è¿”å› `(collateral, debt, isValid)`ï¼›ç¼“å­˜å¤±æ•ˆè‡ªåŠ¨å›é€€åˆ°è´¦æœ¬ï¼ˆ`PositionView`ï¼‰ã€‚
- âœ… **æ¨é€å¤±è´¥ç­–ç•¥åˆ†å±‚**ï¼šæ¸…ç®—/å€Ÿè¿˜è·¯å¾„çš„è§†å›¾æ¨é€å¤±è´¥ä¼šå›æ»šä¸»äº¤æ˜“ï¼ˆå¼ºä¸€è‡´ï¼‰ï¼›ä»…åœ¨ `PositionView` guarded è¯»å–å¤±è´¥æ—¶ emit `CacheUpdateFailed(user, asset, viewAddr, collateral, debt, reason)`ï¼Œä¸»æµç¨‹ä¸ä¸­æ–­ã€‚
- âœ… **é“¾ä¸Šé‡è¯•å…¥å£**ï¼š`PositionView.retryUserPositionUpdate(user, asset)`ï¼ˆadminï¼‰é‡è¯»æœ€æ–°è´¦æœ¬åé‡æ¨ç¼“å­˜ï¼›å¤±è´¥å†æ¬¡ emit äº‹ä»¶ï¼Œå¹‚ç­‰ã€‚
- âœ… **ç®¡ç†å‘˜åŒæ­¥/å›é€€**ï¼šè¯»è·¯å¾„å›é€€è´¦æœ¬ï¼›è‹¥éœ€æ‰‹åŠ¨ä¿®å¤å¯ç”¨é‡è¯•å…¥å£ã€‚

#### æµ‹è¯•æ–‡ä»¶ï¼š

- **ä¸»è¦æµ‹è¯•æ–‡ä»¶**ï¼š
  - `test/Vault/view/PositionView.cache-validity.test.ts` - ç¼“å­˜æœ‰æ•ˆæ€§æµ‹è¯•
    - éªŒè¯ç¼“å­˜è¿‡æœŸæ—¶è‡ªåŠ¨å›é€€åˆ°è´¦æœ¬
    - éªŒè¯ `getUserPositionWithValidity` è¿”å›æ­£ç¡®çš„ `isValid` æ ‡è¯†
    - éªŒè¯è´¦æœ¬è¯»å–å¤±è´¥æ—¶å‘å‡º `CacheUpdateFailed` äº‹ä»¶
    - éªŒè¯æ¨é€æ•°æ®ä¸è´¦æœ¬ä¸ä¸€è‡´æ—¶å›æ»š
  
  - `test/Vault/view/VaultRouter.cache-consistency.test.ts` - ç¼“å­˜ä¸€è‡´æ€§æµ‹è¯•
    - éªŒè¯ç¼“å­˜æœ‰æ•ˆæ—¶è¿”å›ç¼“å­˜å€¼å¹¶æ ‡è®°æœ‰æ•ˆ
    - éªŒè¯ç¼“å­˜è¿‡æœŸæ—¶è‡ªåŠ¨å›é€€åˆ°è´¦æœ¬æœ€æ–°å€¼å¹¶æ ‡è®°æ— æ•ˆ
    - éªŒè¯ `syncUserPositionFromLedger` ç®¡ç†å‘˜åŒæ­¥åŠŸèƒ½
    - éªŒè¯æ¨¡å—ç¼“å­˜è¿‡æœŸæ—¶é€šè¿‡ Registry å›é€€åˆ°è´¦æœ¬
    - éªŒè¯ä¸šåŠ¡ç™½åå•ï¼ˆCM/LE/VBLï¼‰ç¼“å­˜å¤±æ•ˆæ—¶è‡ªåŠ¨åˆ·æ–°å¹¶æ”¾è¡Œ
    - éªŒè¯éç™½åå•åœ°å€è°ƒç”¨è¢«æ‹’ç»
    - éªŒè¯æ¨¡å—ç¼“å­˜ç®¡ç†ï¼ˆrefreshModuleCacheã€isModuleCacheValidï¼‰
    - éªŒè¯ç¼“å­˜æ¸…ç†ä¸ç»Ÿè®¡ï¼ˆclearExpiredCacheã€getCacheStatsï¼‰
    - éªŒè¯ä¸šåŠ¡æ¨é€æ¥å£ï¼ˆpushUserPositionUpdateï¼‰è¦†ç›–ç¼“å­˜å¹¶æƒé™æ ¡éªŒ
    - éªŒè¯ç¼“å­˜æœ‰æ•ˆæœŸè¾¹ç•Œæ¡ä»¶
  
  - `test/Vault/liquidation/LiquidationDebtManager.cache-push.test.ts` - æ¸…ç®—ç¼“å­˜æ¨é€æµ‹è¯•
    - éªŒè¯ View åœ°å€ç¼ºå¤±æ—¶åº”ç›´æ¥å›æ»š
    - éªŒè¯æ¨é€åˆ° View å¤±è´¥æ—¶åº”å›æ»šï¼ˆä¸å†é™é»˜å¤„ç†ï¼‰

### 2. æ¨é€å¤±è´¥å¤„ç†é—®é¢˜ âš ï¸ **ä¸­é£é™©** âœ… å·²è§£å†³

#### é—®é¢˜æè¿°
å½“å‰ä»£ç ä¸­ï¼Œæ¨é€å¤±è´¥æ—¶ä½¿ç”¨ `try-catch` é™é»˜å¤„ç†ï¼š

```solidity
// src/Vault/liquidation/modules/LiquidationDebtManager.sol:162
try IVaultRouter(viewAddr).pushUserPositionUpdate(user, asset, collateral, debt) { } 
catch { }
```
#### å½±å“
- âŒ è´¦æœ¬æ›´æ–°æˆåŠŸï¼Œä½†ç¼“å­˜æœªæ›´æ–°
- âŒ æ•°æ®ä¸ä¸€è‡´ï¼Œä½†ç”¨æˆ·ä¸çŸ¥é“
- âŒ éš¾ä»¥è¿½è¸ªå’Œä¿®å¤

#### è§£å†³æ–¹æ¡ˆä¸ç°çŠ¶
- âœ… **äº‹ä»¶å·²å®ç°ï¼ˆé™ guarded è¯»å–å¤±è´¥ï¼‰**ï¼š`PositionView` åœ¨è´¦æœ¬è¯»å–å¤±è´¥æ—¶ emit `CacheUpdateFailed(user, asset, viewAddr, collateral, debt, reason)`ï¼›ä¸»æµç¨‹ä¸ä¸­æ–­ã€‚
- âœ… **é“¾ä¸‹é‡è¯•**ï¼šç›‘å¬äº‹ä»¶ â†’ é˜Ÿåˆ— â†’ admin è´¦æˆ·è°ƒç”¨ `PositionView.retryUserPositionUpdate` é‡è¯»è´¦æœ¬åé‡æ¨ã€‚
- âœ… **æ¸…ç®—/å€Ÿè¿˜å¼ºä¸€è‡´**ï¼š`LendingEngine/LiquidationDebtManager` çš„è§†å›¾æ¨é€å¤±è´¥ä¼šå›æ»šï¼Œé¿å…è´¦æœ¬/ç¼“å­˜åˆ†å‰ã€‚

#### æµ‹è¯•æ–‡ä»¶ï¼š

- **ä¸»è¦æµ‹è¯•æ–‡ä»¶**ï¼š
  - `test/Vault/view/PositionView.cache-validity.test.ts` - éªŒè¯è´¦æœ¬è¯»å–å¤±è´¥æ—¶å‘å‡º `CacheUpdateFailed` äº‹ä»¶
  - `test/Vault/liquidation/LiquidationDebtManager.cache-push.test.ts` - éªŒè¯æ¸…ç®—è·¯å¾„æ¨é€å¤±è´¥å‘å‡ºäº‹ä»¶ï¼ˆä¸å›æ»šï¼‰

### 3. å¹¶å‘æ›´æ–°é—®é¢˜ âš ï¸ **ä¸­é£é™©**

#### é—®é¢˜æè¿°
å¤šä¸ªä¸šåŠ¡æ¨¡å—å¯èƒ½åŒæ—¶æ¨é€åŒä¸€ç”¨æˆ·çš„æ•°æ®æ›´æ–°ï¼š

```solidity
// åœºæ™¯ï¼šç”¨æˆ·åŒæ—¶è¿›è¡Œå­˜æ¬¾å’Œå€Ÿæ¬¾
CollateralManager.deposit() {
    IVaultRouter.pushUserPositionUpdate(user, asset, newCollateral, oldDebt);
}

LendingEngine.borrow() {
    IVaultRouter.pushUserPositionUpdate(user, asset, oldCollateral, newDebt);
}
```

#### å½±å“
- âš ï¸ åæ‰§è¡Œçš„æ¨é€å¯èƒ½è¦†ç›–å…ˆæ‰§è¡Œçš„æ¨é€
- âš ï¸ å¯¼è‡´éƒ¨åˆ†æ•°æ®ä¸¢å¤±

#### è§£å†³æ–¹æ¡ˆå»ºè®®
1. **ä½¿ç”¨å¢é‡æ›´æ–°**ï¼š
   ```solidity
   function pushUserPositionUpdateDelta(
       address user,
       address asset,
       int256 collateralDelta,  // å¯ä»¥æ˜¯è´Ÿæ•°
       int256 debtDelta
   ) external {
       _userCollateral[user][asset] = uint256(int256(_userCollateral[user][asset]) + collateralDelta);
       _userDebt[user][asset] = uint256(int256(_userDebt[user][asset]) + debtDelta);
   }
   ```

2. **ä½¿ç”¨é”æœºåˆ¶**ï¼ˆä½†ä¼šå¢åŠ gasæˆæœ¬ï¼‰

3. **ç»Ÿä¸€æ¨é€å…¥å£**ï¼š
   - æ‰€æœ‰æ›´æ–°é€šè¿‡å•ä¸€å…¥å£ï¼ˆå¦‚VaultRouterï¼‰ç»Ÿä¸€å¤„ç†
   - é¿å…å¤šä¸ªæ¨¡å—ç›´æ¥æ¨é€

### 4. å­˜å‚¨æˆæœ¬é—®é¢˜ âš ï¸ **ä¸­é£é™©**

#### é—®é¢˜æè¿°
Viewå±‚ç¼“å­˜éœ€è¦å­˜å‚¨å¤§é‡æ•°æ®ï¼š
- æ¯ä¸ªç”¨æˆ·çš„æ¯ä¸ªèµ„äº§çš„æŠµæŠ¼å’Œå€ºåŠ¡
- ç¼“å­˜æ—¶é—´æˆ³
- ç»Ÿè®¡ä¿¡æ¯

#### æˆæœ¬ä¼°ç®—
å‡è®¾æœ‰1000ä¸ªç”¨æˆ·ï¼Œæ¯ä¸ªç”¨æˆ·å¹³å‡3ç§èµ„äº§ï¼š
- å­˜å‚¨æˆæœ¬ï¼š1000 Ã— 3 Ã— (32 + 32 + 32) = 288,000 bytes â‰ˆ 288 KB
- æ¯æ¬¡æ›´æ–°ï¼š~20,000 gas
- åˆå§‹åŒ–å­˜å‚¨ï¼š~20,000 gas per user

#### å½±å“
- âš ï¸ éƒ¨ç½²æˆæœ¬é«˜
- âš ï¸ æ›´æ–°æˆæœ¬å¢åŠ 
- âš ï¸ å¯èƒ½è¾¾åˆ°åˆçº¦å¤§å°é™åˆ¶

#### è§£å†³æ–¹æ¡ˆå»ºè®®
1. **é€‰æ‹©æ€§ç¼“å­˜**ï¼š
   - åªç¼“å­˜æ´»è·ƒç”¨æˆ·ï¼ˆæœ€è¿‘æœ‰æ“ä½œçš„ç”¨æˆ·ï¼‰
   - å®šæœŸæ¸…ç†ä¸æ´»è·ƒç”¨æˆ·çš„ç¼“å­˜

2. **å‹ç¼©å­˜å‚¨**ï¼š
   - ä½¿ç”¨æ›´ç´§å‡‘çš„æ•°æ®ç»“æ„
   - åˆå¹¶å¤šä¸ªå­—æ®µåˆ°ä¸€ä¸ªslot

3. **é“¾ä¸‹ç¼“å­˜**ï¼š
   - è€ƒè™‘å°†éƒ¨åˆ†ç¼“å­˜ç§»åˆ°é“¾ä¸‹
   - é“¾ä¸Šåªä¿ç•™å…³é”®æ•°æ®

### 5. ç¼“å­˜è¿‡æœŸç­–ç•¥é—®é¢˜ âš ï¸ **ä½é£é™©**

#### é—®é¢˜æè¿°
å½“å‰ç¼“å­˜è¿‡æœŸæ—¶é—´ä¸º5åˆ†é’Ÿï¼ˆ300ç§’ï¼‰ï¼š

```solidity
uint256 private constant CACHE_DURATION = 300; // 5åˆ†é’Ÿ
```

#### é—®é¢˜
- âš ï¸ å›ºå®šè¿‡æœŸæ—¶é—´å¯èƒ½ä¸é€‚åˆæ‰€æœ‰åœºæ™¯
- âš ï¸ é«˜é¢‘ç”¨æˆ·å¯èƒ½é¢‘ç¹è§¦å‘ç¼“å­˜æ›´æ–°
- âš ï¸ ä½é¢‘ç”¨æˆ·å¯èƒ½æ€»æ˜¯æŸ¥è¯¢åˆ°è¿‡æœŸæ•°æ®

#### è§£å†³æ–¹æ¡ˆå»ºè®®
1. **åŠ¨æ€è¿‡æœŸæ—¶é—´**ï¼š
   ```solidity
   mapping(address => uint256) private _cacheDurations; // æŒ‰ç”¨æˆ·è®¾ç½®
   ```

2. **åŸºäºæ“ä½œçš„è¿‡æœŸ**ï¼š
   - æ¯æ¬¡æ“ä½œåé‡ç½®è¿‡æœŸæ—¶é—´
   - è€Œä¸æ˜¯å›ºå®šæ—¶é—´çª—å£

### 6. å‡çº§å…¼å®¹æ€§é—®é¢˜ âš ï¸ **ä¸­é£é™©**

#### é—®é¢˜æè¿°
Viewå±‚ç¼“å­˜çš„æ•°æ®ç»“æ„åœ¨å‡çº§æ—¶éœ€è¦ä¿æŒå…¼å®¹ï¼š

```solidity
// å½“å‰ç‰ˆæœ¬
mapping(address => mapping(address => uint256)) private _userCollateral;

// å‡çº§åå¦‚æœéœ€è¦æ·»åŠ æ–°å­—æ®µ
mapping(address => mapping(address => uint256)) private _userCollateral;
mapping(address => mapping(address => uint256)) private _userCollateralV2; // æ–°å­—æ®µ
```

#### å½±å“
- âš ï¸ å‡çº§æ—¶éœ€è¦æ•°æ®è¿ç§»
- âš ï¸ å¯èƒ½ä¸¢å¤±å†å²ç¼“å­˜æ•°æ®
- âš ï¸ éœ€è¦å¤æ‚çš„è¿ç§»é€»è¾‘

#### è§£å†³æ–¹æ¡ˆå»ºè®®
1. **é¢„ç•™å­˜å‚¨æ§½**ï¼š
   ```solidity
   uint256[50] private __gap; // é¢„ç•™å‡çº§ç©ºé—´
   ```

2. **ç‰ˆæœ¬åŒ–å…¼å®¹è¾“å‡ºï¼ˆæ¨è C+B ä¸ºä¸»ï¼ŒA ä¸ºå…³é”®æ¨¡å—ï¼‰**ï¼š
   - **Cï¼šç»Ÿä¸€ç‰ˆæœ¬ä¿¡æ¯å…¥å£ï¼ˆå…¨æ¨¡å—ï¼‰**ï¼šæ‰€æœ‰ View æ¨¡å—æä¾›ç»Ÿä¸€çš„ç‰ˆæœ¬æŸ¥è¯¢ï¼Œä¾¿äºå‡çº§åé“¾ä¸‹å¿«é€Ÿè¯†åˆ«â€œå½“å‰å®ç°/æ¥å£/è¾“å‡ºç»“æ„ç‰ˆæœ¬â€ï¼š
     - `getVersionInfo() -> (apiVersion, schemaVersion, implementation)`
   - **Bï¼šschemaVersion / apiVersionï¼ˆé»˜è®¤ç­–ç•¥ï¼‰**ï¼š
     - `apiVersion`ï¼šå¯¹å¤– API è¯­ä¹‰ç‰ˆæœ¬ï¼ˆå‡½æ•°/äº‹ä»¶è¯­ä¹‰å˜åŒ–æ—¶é€’å¢ï¼‰
     - `schemaVersion`ï¼šç¼“å­˜/è¾“å‡ºç»“æ„ç‰ˆæœ¬ï¼ˆå­—æ®µ/ç¼–ç /è§£é‡Šå˜åŒ–æ—¶é€’å¢ï¼‰
     - å­˜å‚¨å˜é‡ä»å¿…é¡»éµå¾ª **append-only**ï¼ˆä»…è¿½åŠ åˆ° `__gap` ä¹‹å‰å¹¶ç¼©å‡ `__gap`ï¼‰ï¼Œé¿å…ç ´åå¸ƒå±€
   - **Aï¼šå…³é”®æ¨¡å—æ˜¾å¼ V2/V3ï¼ˆå¤–éƒ¨ä¾èµ–å¼ºæ—¶ï¼‰**ï¼š
     - ä¾‹å¦‚ä¿ç•™æ—§äº‹ä»¶/æ—§å…¥å£ï¼Œå¹¶æ–°å¢ `*V2` äº‹ä»¶æºå¸¦æ–°å­—æ®µï¼ˆå¦‚ `timestamp/version`ï¼‰ï¼Œå®ç°å¹³æ»‘è¿ç§»
     - å¯¹å†™å…¥å‹ç¼“å­˜æ¥å£ï¼Œç»“åˆ `nextVersion/requestId/seq` åšå¹¶å‘ä¸å¹‚ç­‰æ§åˆ¶ï¼Œé¿å…ä¹±åº/é‡å¤è¦†ç›–

### 7. VaultLendingEngine è§„æ¨¡è¿‡å¤§ âš ï¸ **é«˜é£é™©** âœ… å·²éªŒè¯

#### é—®é¢˜æè¿°
æ–‡æ¡£å¼ºè°ƒæ¨¡å—åº”è¯¥"çº¯ä¸šåŠ¡é€»è¾‘"ä¸”ç®€åŒ–ï¼Œä½†å®é™…ä»£ç ä¸­ï¼š
- `VaultLendingEngine.sol` æœ‰ **1070è¡Œ**
- ç›¸æ¯” `CollateralManager.sol` (531è¡Œ) è¿‡äºåºå¤§
- è¿èƒŒäº†æ–‡æ¡£ä¸­"æç®€åŒ–"çš„è®¾è®¡åŸåˆ™

#### æ½œåœ¨é£é™©
- âŒ åˆçº¦å­—èŠ‚ç å¯èƒ½è¶…è¿‡ 24KB é™åˆ¶
- âŒ å‡çº§å’Œç»´æŠ¤å›°éš¾
- âŒ æµ‹è¯•è¦†ç›–éš¾åº¦å¢åŠ 
- âŒ ä»£ç å®¡è®¡æˆæœ¬é«˜

#### è§£å†³æ–¹æ¡ˆå»ºè®®
è€ƒè™‘å°† VaultLendingEngine æ‹†åˆ†ä¸ºæ›´å°çš„æ¨¡å—ï¼š
```
VaultLendingEngine (1070è¡Œ)
    â†“ æ‹†åˆ†ä¸º
LendingEngineCore (~400è¡Œ)     - æ ¸å¿ƒå€Ÿè´·é€»è¾‘
LendingEngineAccounting (~300è¡Œ) - å€ºåŠ¡æ ¸ç®—
LendingEngineValuation (~300è¡Œ)  - ä¼°å€¼ä¸ä¼˜é›…é™çº§
```

#### å½“å‰çŠ¶æ€ï¼ˆå·²å®æ–½æ‹†åˆ†ï¼‰
- âœ… å·²æ‹†åˆ†ä¸ºåº“æ¨¡å—ï¼š`LendingEngineStorage.sol`ã€`LendingEngineCore.sol`ã€`LendingEngineAccounting.sol`ã€`LendingEngineValuation.sol`
- âœ… ä¸»åˆçº¦ `VaultLendingEngine.sol` è¡Œæ•°ç¼©å‡è‡³ ~600 è¡Œ
- âœ… éƒ¨ç½²ä½“ç§¯ï¼š16.245 KiBï¼ˆç¬¦åˆé™åˆ¶ï¼‰

#### æµ‹è¯•æ–‡ä»¶ï¼š

- **ä¸»è¦æµ‹è¯•æ–‡ä»¶**ï¼š`test/Vault/VaultLendingEngine.refactor.test.ts`
  - ä¸“é—¨é’ˆå¯¹æ‹†åˆ†åçš„è´¦æœ¬ä¸å…¥å£ä¸€è‡´æ€§æµ‹è¯•
  - è¦†ç›–ç»Ÿä¸€å…¥å£ï¼ˆborrow/repay ä»…å…è®¸ KEY_VAULT_COREï¼‰ã€æ¸…ç®—ç›´è¾¾å…¥å£ï¼ˆforceReduceDebt éœ€ ACTION_LIQUIDATEï¼‰
  - éªŒè¯è´¦æœ¬å†™å…¥ä¸è§†å›¾æ¨é€ã€å¥åº·æ¨é€ç­‰åŠŸèƒ½
  - æµ‹è¯•è¾¹ç•Œç”¨ä¾‹ï¼šé›¶é‡‘é¢ã€è¶…é¢è¿˜æ¬¾ã€å…¨é¢è¿˜æ¸…/å…¨é¢æ¸…ç®—ç­‰
  
- **ç›¸å…³æµ‹è¯•æ–‡ä»¶**ï¼š
  - `test/Vault/VaultLendingEngine.dual-entry.test.ts` - åŒå…¥å£ä¸€è‡´æ€§å›å½’æµ‹è¯•
  - `test/LendingEngine.test.ts` - LendingEngine æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•ï¼ˆå·²è·³è¿‡ï¼Œå¾…ä»£ç†æ¨¡å¼é€‚é…ï¼‰

- **æ‹†åˆ†åçš„æ¨¡å—åº“**ï¼ˆä½äº `src/Vault/modules/lendingEngine/`ï¼‰ï¼š
  - `LendingEngineStorage.sol` - å­˜å‚¨å¸ƒå±€è®¿é—®å™¨
  - `LendingEngineCore.sol` - ç¼–æ’å…¥å£ï¼ˆborrow/repay/forceReduceDebtï¼‰
  - `LendingEngineAccounting.sol` - å€Ÿ/è¿˜/æ¸…ç®—è´¦æœ¬å†™å…¥
  - `LendingEngineValuation.sol` - å€ºåŠ¡ä¼°å€¼ä¸ä¼˜é›…é™çº§

### 8. åŒå…¥å£é£é™© âš ï¸ **é«˜é£é™©** âœ… å·²éªŒè¯

#### é—®é¢˜æè¿°
æ–‡æ¡£å£°æ˜ï¼ˆç¬¬460è¡Œï¼‰ï¼š
> ç»Ÿä¸€èµ° `VaultCore` â†’ `LendingEngine` çš„è´¦æœ¬å…¥å£ï¼ˆ`onlyVaultCore`ï¼‰ï¼Œæ¶ˆé™¤åŒå…¥å£ä¸æƒé™ä¸ä¸€è‡´

ä½†åœ¨å®é™…ä»£ç ä¸­ï¼š
```solidity
// VaultLendingEngine.sol
modifier onlyVaultCore() {
    if (msg.sender != _getModuleAddress(ModuleKeys.KEY_VAULT_CORE)) {
        // ...
    }
}
```

#### é—®é¢˜ç‚¹
1. **æ¸…ç®—å¯ä»¥ç›´æ¥è°ƒç”¨** `ILendingEngineBasic.forceReduceDebt` - å­˜åœ¨ä¸ç»è¿‡ VaultCore çš„å…¥å£
2. è¿™å¯èƒ½å¯¼è‡´çŠ¶æ€ä¸ä¸€è‡´ï¼š
   - ç»•è¿‡ View å±‚ç¼“å­˜æ›´æ–°
   - äº‹ä»¶æ¨é€å¯èƒ½ä¸å®Œæ•´

#### å½±å“
- âŒ ç¼“å­˜ä¸è´¦æœ¬æ•°æ®å¯èƒ½ä¸åŒæ­¥
- âŒ é“¾ä¸‹ç›‘æ§å¯èƒ½æ¼æ‰å…³é”®äº‹ä»¶
- âŒ æƒé™æ ¡éªŒå¯èƒ½ä¸ä¸€è‡´

#### è§£å†³æ–¹æ¡ˆå»ºè®®
1. æ˜ç¡®ä»… `forceReduceDebt` å…è®¸æ¸…ç®—ç›´è¾¾è´¦æœ¬ï¼›å…¶ä½™å†™å…¥ç»Ÿä¸€ç» `VaultCore`ã€‚
2. ç¡®ä¿ç›´è¾¾è·¯å¾„åŒæ ·æ¨é€ç¼“å­˜/é£é™©ï¼š`_pushUserPositionToView`ã€`_pushHealthStatus` å·²åœ¨ `forceReduceDebt` å†…è°ƒç”¨ã€‚
3. æƒé™ç»Ÿä¸€èµ° ACMï¼šæ¸…ç®—è°ƒç”¨éœ€ `ActionKeys.ACTION_LIQUIDATE`ã€‚
4. ç«¯åˆ°ç«¯æµ‹è¯•è¦†ç›–åŒå…¥å£ä¸€è‡´æ€§ï¼ˆå€Ÿ/è¿˜èµ° VaultCoreï¼Œæ¸…ç®—èµ°ç›´è¾¾ï¼‰ï¼Œæ ¡éªŒäº‹ä»¶ä¸ç¼“å­˜åŒæ­¥ã€‚

#### å½“å‰çŠ¶æ€ï¼ˆä¸ Architecture-Guide å¯¹é½ï¼‰
- å·²é‡‡ç”¨â€œæ–¹æ¡ˆ Bâ€ï¼šä¸šåŠ¡/æ’®åˆå…¥å£èµ° `VaultCore â†’ LendingEngine`ï¼›æ¸…ç®—å…¥å£ä¿ç•™ç›´è¾¾è´¦æœ¬ï¼ˆRegistry ç»‘å®š `KEY_LIQUIDATION_MANAGER`ï¼‰ï¼Œå¹¶åœ¨è´¦æœ¬è½è´¦åç»Ÿä¸€æ¨é€ View/Healthã€‚
- ä¼°å€¼ä¸ä¼˜é›…é™çº§ä»…åœ¨ LendingEngine ä¼°å€¼è·¯å¾„è§¦å‘ï¼Œé¿å…ä¸šåŠ¡å±‚é‡å¤ã€‚

#### æµ‹è¯•æ–‡ä»¶ï¼š

- **ä¸»è¦æµ‹è¯•æ–‡ä»¶**ï¼š`test/Vault/VaultLendingEngine.dual-entry.test.ts`
  - ä¸“é—¨é’ˆå¯¹åŒå…¥å£ä¸€è‡´æ€§å›å½’æµ‹è¯•
  - è¦†ç›–ä¸šåŠ¡å…¥å£ï¼ˆborrow/repay ä»…å…è®¸ KEY_VAULT_COREï¼‰å’Œæ¸…ç®—å…¥å£ï¼ˆforceReduceDebt éœ€ ACTION_LIQUIDATEï¼‰
  - éªŒè¯è´¦æœ¬ä¸ç¼“å­˜ä¸€è‡´æ€§ï¼ˆView/Health åŒæ­¥ï¼‰
  
- **ç›¸å…³æµ‹è¯•æ–‡ä»¶**ï¼š`test/Vault/VaultLendingEngine.refactor.test.ts`
  - åŒ…å« `onlyVaultCore guard` æµ‹è¯•å¥—ä»¶
  - åŒ…å« `forceReduceDebt (liquidation path)` æµ‹è¯•å¥—ä»¶
  
- **å…¶ä»–ç›¸å…³æµ‹è¯•**ï¼š
  - `test/Vault/modules/VaultBusinessLogic.liquidation.test.ts` - æ¸…ç®—æµç¨‹ä¸­çš„ forceReduceDebt æµ‹è¯•
  - `test/Vault/view/LiquidationViewForward.test.ts` - View å±‚è½¬å‘åŠŸèƒ½æµ‹è¯•

### 9. VaultRouter å‘½åè¯¯å¯¼é—®é¢˜ âš ï¸ **ä¸­é£é™©**  âœ… å·²è§£å†³

#### é—®é¢˜æè¿°
æ–‡æ¡£å¤šå¤„å¼ºè°ƒ View å±‚åº”è¯¥æ˜¯"åªè¯»"çš„ï¼Œä½†å®é™…ä¸Š `VaultRouter` å……å½“äº†**ä¸­é—´è·¯ç”±å±‚**ï¼š

```solidity
// VaultRouter.sol - è¿™å®é™…ä¸Šæ˜¯ä¸€ä¸ªå†™å…¥æ“ä½œ
function processUserOperation(...) external onlyAuthorizedContract {
    _distributeToModule(user, operationType, asset, amount);  // è§¦å‘ä¸šåŠ¡æ¨¡å—å†™å…¥
    _updateLocalState(user, operationType, asset, amount);    // æ›´æ–°ç¼“å­˜
}
```

#### å½±å“
- âš ï¸ å‘½åä¸ç›´è§‚ï¼Œå¯èƒ½å¯¼è‡´å¼€å‘è€…è¯¯è§£
- âš ï¸ å¦‚æœ View åˆçº¦è¢«æ”»å‡»ï¼Œå¯èƒ½å½±å“æ•´ä¸ªç³»ç»ŸçŠ¶æ€
- âš ï¸ å®‰å…¨å®¡è®¡æ—¶å¯èƒ½ä½ä¼°å…¶é£é™©

#### è§£å†³æ–¹æ¡ˆå»ºè®®
âœ… **å·²è§£å†³**ï¼šå·²å°† `VaultView` é‡å‘½åä¸º `VaultRouter` ä»¥æ›´å‡†ç¡®åæ˜ å…¶èŒè´£ã€‚

#### åç»­æ”¹è¿›
âœ… **ä¼˜é›…é™çº§æµ‹è¯•å¢å¼º**ï¼š
- æ·»åŠ äº†æµ‹è¯•æ¨¡å¼ï¼ˆ`testingMode`ï¼‰åŠŸèƒ½ï¼Œä»…å‚æ•°ç®¡ç†è§’è‰²å¯å¯ç”¨
- å®ç°äº† `simulateDepositAndBorrowForTesting()` å’Œ `simulateRepayAndWithdrawForTesting()` æµ‹è¯•è¾…åŠ©å‡½æ•°
- è¿™äº›å‡½æ•°åœ¨æ¨¡å—è°ƒç”¨å¤±è´¥æ—¶**ä¸å›æ»š**ï¼Œè€Œæ˜¯è¿”å›æˆåŠŸæ ‡å¿—å’Œé”™è¯¯æ•°æ®ï¼Œä¾¿äºæµ‹è¯•ä¼˜é›…é™çº§è·¯å¾„çš„äº‹ä»¶å’Œæ—¥å¿—
- ç”Ÿäº§è·¯å¾„ï¼ˆ`depositAndBorrow`ã€`repayAndWithdraw`ï¼‰ä¿æŒåŸå­æ€§å›æ»šæœºåˆ¶ï¼Œä¸å—å½±å“

âœ… **ç»†ç²’åº¦æµ‹è¯•è¦†ç›–**ï¼š
- æµ‹è¯•å¥—ä»¶ `test/VaultRouter.test.ts` ä¸­æ–°å¢"ä¼˜é›…é™çº§ç»†ç²’åº¦æµ‹è¯•ï¼ˆæµ‹è¯•æ¨¡å¼ï¼‰"éƒ¨åˆ†
- è¦†ç›–äº† CollateralManager å¤±è´¥ã€LendingEngine å¤±è´¥ã€è¿˜æ¬¾å¤±è´¥ã€æå–å¤±è´¥ç­‰æ‰€æœ‰é™çº§è·¯å¾„
- éªŒè¯äº† `ExternalModuleReverted` å’Œ `VaultRouterGracefulDegradation` äº‹ä»¶çš„æ­£ç¡®å‘å‡º
- éªŒè¯äº†æµ‹è¯•æ¨¡å¼æƒé™æ§åˆ¶å’Œæœªå¼€å¯æ—¶çš„æ‹’ç»æœºåˆ¶

âœ… **æ¶æ„ä¸€è‡´æ€§éªŒè¯**ï¼š
- `VaultRouter` ç°åœ¨æ˜ç¡®ä½œä¸ºè·¯ç”±åè°ƒå™¨ï¼Œä»…å¤„ç† `deposit/withdraw` æ“ä½œï¼ˆé€šè¿‡ `processUserOperation`ï¼‰
- `borrow/repay` æ“ä½œç”± `VaultCore` ç›´æ¥è°ƒç”¨ `LendingEngine`ï¼Œç¬¦åˆ"å†™å…¥ä¸ç» View"åŸåˆ™
- æ‰€æœ‰æŸ¥è¯¢åŠŸèƒ½å·²è¿ç§»åˆ°ç‹¬ç«‹çš„ View æ¨¡å—ï¼ˆ`PositionView`ã€`UserView` ç­‰ï¼‰

**ç›¸å…³æ–‡ä»¶**ï¼š
- åˆçº¦å®ç°ï¼š`src/Vault/VaultRouter.sol`ï¼ˆç¬¬ 810-933 è¡Œï¼‰
- æµ‹è¯•æ–‡ä»¶ï¼š`test/VaultRouter.test.ts`ï¼ˆç¬¬ 1112-1356 è¡Œï¼‰
- æ¶æ„æ–‡æ¡£ï¼š`docs/Architecture-Guide.md`ï¼ˆå·²æ›´æ–° VaultRouter èŒè´£è¯´æ˜ï¼‰

### 10. Registry å­˜å‚¨æ§½ä½å†²çªé£é™© âš ï¸ **é«˜é£é™©** âœ… å·²éªŒè¯

#### é—®é¢˜æè¿°
æ–‡æ¡£è®¾è®¡ï¼ˆç¬¬876-880è¡Œï¼‰ä½¿ç”¨å›ºå®šæ§½ä½ï¼š
```solidity
bytes32 internal constant STORAGE_SLOT = keccak256("registry.storage.v1");
```

#### æ½œåœ¨é—®é¢˜
1. **ç¼ºå°‘å­˜å‚¨ç‰ˆæœ¬è¿ç§»æœºåˆ¶çš„è¯¦ç»†è¯´æ˜**: æ–‡æ¡£è™½ç„¶æåˆ°äº† `storageVersion` å’Œ `migrateVxToVy()`ï¼Œä½†æ²¡æœ‰æä¾›å…·ä½“å®ç°æŒ‡å—
2. **å…±äº«å­˜å‚¨çš„å±é™©æ€§**: å¤šä¸ªåˆçº¦å…±äº«å­˜å‚¨æ§½ä½ï¼Œä»»ä¸€å®ç°ä¸­çš„é”™è¯¯å¯èƒ½ç ´åæ•´ä¸ªæ•°æ®

#### å½±å“
- âŒ å‡çº§æ—¶å¯èƒ½ä¸¢å¤±æ•°æ®
- âŒ å­˜å‚¨å¸ƒå±€å˜æ›´å¯èƒ½å¯¼è‡´çŠ¶æ€æŸå
- âŒ å›æ»šå›°éš¾

#### è§£å†³æ–¹æ¡ˆå»ºè®®
1. æ·»åŠ å­˜å‚¨å¸ƒå±€æ ¡éªŒå·¥å…·ï¼ˆå¦‚ OpenZeppelin Upgrades æ’ä»¶ï¼‰
2. å¼ºåˆ¶åœ¨æ¯æ¬¡å‡çº§å‰è¿è¡Œ `validateStorageLayout()`
3. æä¾›è¯¦ç»†çš„è¿ç§»è„šæœ¬æ¨¡æ¿
4. åœ¨ CI ä¸­åŠ å…¥å­˜å‚¨å¸ƒå±€æ£€æŸ¥
5. **å·²è½åœ°**ï¼šæ–°å¢ `Registry.migrateStorage(fromVersion, toVersion, migrator)`ï¼Œä¿æŒå›ºå®š `STORAGE_SLOT`ï¼Œè¿ç§»å‰åè°ƒç”¨ `validateStorageLayout()`ï¼Œå¹¶é€šè¿‡å¤–éƒ¨è¿ç§»åˆçº¦æ‰§è¡Œæ•°æ®æ¬è¿åå† bump `storageVersion`ï¼Œå·²åœ¨äº‹ä»¶åº“ä¸­æ·»åŠ  `StorageMigrated` äº‹ä»¶ç”¨äºå®¡è®¡ï¼›é…å¥—æµ‹è¯•ï¼š`test/RegistryStorageMigration.test.ts`


### 11. æ¸…ç®—æµç¨‹å¤æ‚æ€§ âš ï¸ **ä¸­é£é™©** âœ… å·²å®Œæˆ

#### é—®é¢˜æè¿°
æ–‡æ¡£ç¬¬464-496è¡Œæè¿°çš„æ¸…ç®—æµç¨‹æ¶‰åŠå¤šä¸ªæ¨¡å—ï¼š
- `VaultBusinessLogic` / `LiquidationManager`ï¼ˆç¼–æ’å…¥å£ï¼‰
- `CollateralManager.withdrawCollateral`ï¼ˆæ‰£æŠ¼æŠµæŠ¼ï¼‰
- `LendingEngine.forceReduceDebt`ï¼ˆå‡å°‘å€ºåŠ¡ï¼‰
- `LiquidatorView.pushLiquidationUpdate`ï¼ˆäº‹ä»¶æ¨é€ï¼‰

#### æ½œåœ¨é£é™©
1. **åŸå­æ€§é—®é¢˜**: å¦‚æœåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æŸæ­¥éª¤å¤±è´¥ï¼Œå¯èƒ½å¯¼è‡´éƒ¨åˆ†çŠ¶æ€æ›´æ–°
2. **æƒé™æ ¡éªŒåˆ†æ•£**: ä¸åŒæ¨¡å—å„è‡ªåšæƒé™æ ¡éªŒï¼Œå¯èƒ½å­˜åœ¨ä¸ä¸€è‡´
3. **äº‹ä»¶åŒå‘**: æ–‡æ¡£æåˆ°"é¿å…äº‹ä»¶åŒå‘"ä½†å®é™…å®ç°éœ€è¦ä»”ç»†å®¡æŸ¥

#### å½±å“
- âŒ éƒ¨åˆ†æ¸…ç®—å¯èƒ½å¯¼è‡´ç”¨æˆ·çŠ¶æ€ä¸ä¸€è‡´
- âŒ é“¾ä¸‹ç›‘æ§å¯èƒ½æ”¶åˆ°é‡å¤æˆ–é—æ¼çš„äº‹ä»¶

#### è§£å†³æ–¹æ¡ˆå»ºè®®
æ·»åŠ ç«¯åˆ°ç«¯çš„æ¸…ç®—æµ‹è¯•ï¼Œè¦†ç›–å„ç§å¤±è´¥åœºæ™¯ï¼š
- æ‰£æŠ¼æˆåŠŸä½†å‡å€ºå¤±è´¥
- å‡å€ºæˆåŠŸä½†äº‹ä»¶æ¨é€å¤±è´¥
- å¹¶å‘æ¸…ç®—åŒä¸€ç”¨æˆ·

#### å½“å‰çŠ¶æ€ï¼ˆå·²å®æ–½è§£å†³æ–¹æ¡ˆï¼‰
- âœ… **åŸå­æ€§ä¿è¯**ï¼š`VaultBusinessLogic.liquidate` é‡‡ç”¨åŸå­æ€§è®¾è®¡ï¼Œæ‰£æŠ¼ â†’ å‡å€º â†’ äº‹ä»¶æ¨é€ï¼Œä»»ä¸€æ­¥å¤±è´¥å³æ•´ä½“å›æ»šï¼Œç¡®ä¿æ— éƒ¨åˆ†çŠ¶æ€æ›´æ–°ã€‚
- âœ… **æƒé™é›†ä¸­éªŒè¯**ï¼šæ¸…ç®—å…¥å£ç»Ÿä¸€ä½¿ç”¨ `onlyLiquidator` ä¿®é¥°ç¬¦ï¼Œé€šè¿‡ `AccessControlManager` ç»Ÿä¸€æ ¡éªŒï¼Œé¿å…æƒé™æ ¡éªŒåˆ†æ•£ã€‚
- âœ… **äº‹ä»¶å•ç‚¹æ¨é€**ï¼šæ¸…ç®—äº‹ä»¶ä»…é€šè¿‡ `LiquidationEventsView.pushLiquidationUpdate` å•ç‚¹æ¨é€ï¼Œé¿å…äº‹ä»¶åŒå‘æˆ–é—æ¼ã€‚

#### æµ‹è¯•æ–‡ä»¶ï¼š
- **ä¸»è¦æµ‹è¯•æ–‡ä»¶**ï¼š
  - `test/Vault/liquidation/Liquidation.failure-scenarios.test.ts` - æ¸…ç®—å¤±è´¥åœºæ™¯ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆ24ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œå…¨éƒ¨é€šè¿‡ï¼‰
    - **æ ¸å¿ƒå¤±è´¥åœºæ™¯**ï¼ˆ3ä¸ªç”¨ä¾‹ï¼‰ï¼š
      - éªŒè¯æ‰£æŠ¼æˆåŠŸä½†å‡å€ºå¤±è´¥æ—¶æ•´ä½“å›æ»š
      - éªŒè¯äº‹ä»¶æ¨é€å¤±è´¥æ—¶å›æ»šå‡å€ºä¸æ‰£æŠ¼
      - éªŒè¯é˜²æ­¢åŒä¸€ç”¨æˆ·çš„å¹¶å‘æ¸…ç®—å¯¼è‡´é‡å¤äº‹ä»¶æˆ–å¼‚å¸¸çŠ¶æ€
    - **æƒé™ä¸å‚æ•°éªŒè¯**ï¼ˆ3ä¸ªç”¨ä¾‹ï¼‰ï¼š
      - éªŒè¯éæ¸…ç®—äººè°ƒç”¨è¢«æ‹’ç»
      - éªŒè¯é›¶åœ°å€å‚æ•°è¢«æ‹’ç»
      - éªŒè¯é›¶é‡‘é¢è¢«æ‹’ç»
    - **æ‰£æŠ¼å¤±è´¥åœºæ™¯**ï¼ˆ2ä¸ªç”¨ä¾‹ï¼‰ï¼š
      - éªŒè¯æŠµæŠ¼ä¸è¶³æ—¶åº”å›æ»š
      - éªŒè¯æ‰£æŠ¼å¤±è´¥æ—¶ä¸åº”å½±å“å€ºåŠ¡
    - **æ¨¡å—ç¼ºå¤±åœºæ™¯**ï¼ˆ3ä¸ªç”¨ä¾‹ï¼‰ï¼š
      - éªŒè¯ CollateralManager æœªæ³¨å†Œæ—¶åº”å›æ»š
      - éªŒè¯ LendingEngine æœªæ³¨å†Œæ—¶åº”å›æ»š
      - éªŒè¯ LiquidationView æœªæ³¨å†Œæ—¶åº”å›æ»š
    - **æˆåŠŸæ¸…ç®—åçš„çŠ¶æ€éªŒè¯**ï¼ˆ2ä¸ªç”¨ä¾‹ï¼‰ï¼š
      - éªŒè¯æˆåŠŸæ¸…ç®—åæ­£ç¡®æ›´æ–°æŠµæŠ¼å’Œå€ºåŠ¡
      - éªŒè¯æˆåŠŸæ¸…ç®—åå‘å‡ºäº‹ä»¶
    - **éƒ¨åˆ†æ¸…ç®—åœºæ™¯**ï¼ˆ2ä¸ªç”¨ä¾‹ï¼‰ï¼š
      - éªŒè¯éƒ¨åˆ†æ¸…ç®—åå…è®¸ç»§ç»­æ¸…ç®—å‰©ä½™éƒ¨åˆ†
      - éªŒè¯éƒ¨åˆ†æ¸…ç®—åä¸åº”è¶…è¿‡å‰©ä½™å€ºåŠ¡
    - **è¾¹ç•Œæ¡ä»¶**ï¼ˆ3ä¸ªç”¨ä¾‹ï¼‰ï¼š
      - éªŒè¯å¤„ç†æœ€å°é‡‘é¢æ¸…ç®—ï¼ˆ1 weiï¼‰
      - éªŒè¯æ‹’ç»è¶…è¿‡å¯ç”¨æŠµæŠ¼çš„æ¸…ç®—
      - éªŒè¯æ‹’ç»è¶…è¿‡å¯ç”¨å€ºåŠ¡çš„æ¸…ç®—
    - **å¤šæ¸…ç®—äººåœºæ™¯**ï¼ˆ2ä¸ªç”¨ä¾‹ï¼‰ï¼š
      - éªŒè¯ä¸åŒæ¸…ç®—äººèƒ½æ¸…ç®—åŒä¸€ç”¨æˆ·
      - éªŒè¯ä¸åŒæ¸…ç®—äººçš„å¥–åŠ±åˆ†åˆ«ç´¯è®¡
    - **æ¸…ç®—å¥–åŠ±éªŒè¯**ï¼ˆ2ä¸ªç”¨ä¾‹ï¼‰ï¼š
      - éªŒè¯æ¸…ç®—å¥–åŠ±æ­£ç¡®è®°å½•
      - éªŒè¯é›¶å¥–åŠ±æ¸…ç®—æ­£å¸¸å·¥ä½œ
    - **çŠ¶æ€ä¸€è‡´æ€§éªŒè¯**ï¼ˆ2ä¸ªç”¨ä¾‹ï¼‰ï¼š
      - éªŒè¯æ¸…ç®—å¤±è´¥åæ‰€æœ‰çŠ¶æ€ä¿æŒä¸å˜
      - éªŒè¯å¤šæ¬¡å¤±è´¥æ¸…ç®—ä¸ç´¯ç§¯çŠ¶æ€å˜åŒ–

### 12. Reward æ¨¡å—å…¥å£æ”¶ç´§éªŒè¯ âš ï¸ **ä¸­é£é™©**

#### é—®é¢˜æè¿°
æ–‡æ¡£è¦æ±‚ï¼ˆç¬¬743-748è¡Œï¼‰ï¼š
- å”¯ä¸€è·¯å¾„ï¼š`LendingEngine` â†’ `RewardManager` â†’ `RewardManagerCore`
- ç›´æ¥è°ƒç”¨ `RewardManagerCore.onLoanEvent` åº”è¯¥è§¦å‘é”™è¯¯ `RewardManagerCore__UseRewardManagerEntry`

#### éœ€è¦éªŒè¯
- [ ] æ˜¯å¦æ‰€æœ‰ Reward ç›¸å…³æµ‹è¯•éƒ½å·²æ›´æ–°
- [ ] æ˜¯å¦å­˜åœ¨é—ç•™çš„ç›´æ¥è°ƒç”¨è·¯å¾„
- [ ] æ˜¯å¦æœ‰è„šæœ¬ä»ç„¶ä½¿ç”¨æ—§å…¥å£

#### å½±å“
- âš ï¸ å¦‚æœå­˜åœ¨é—ç•™å…¥å£ï¼Œå¯èƒ½å¯¼è‡´å¥–åŠ±é‡å¤å‘æ”¾æˆ–æ¼å‘
- âš ï¸ ä¸è´¦æœ¬çŠ¶æ€ä¸åŒæ­¥

### 13. Gas ä¼°ç®—å¯èƒ½ä¸å‡†ç¡® âš ï¸ **ä½é£é™©**

#### é—®é¢˜æè¿°
æ–‡æ¡£å£°æ˜ï¼ˆç¬¬374-376è¡Œï¼‰ï¼š
| æ›´æ–°ç±»å‹ | åŒæ¶æ„æ–¹æ¡ˆ |
|----------|------------|
| æƒé™æ›´æ–° | 21,000 gas |
| ä½ç½®æ›´æ–° | 25,000 gas |

è¿™äº›ä¼°ç®—å¯èƒ½è¿‡äºä¹è§‚ï¼Œå®é™…å–å†³äºï¼š
- å­˜å‚¨æ§½çš„å†·/çƒ­çŠ¶æ€
- è·¨åˆçº¦è°ƒç”¨æ¬¡æ•°
- äº‹ä»¶æ•°æ®å¤§å°

#### è§£å†³æ–¹æ¡ˆå»ºè®®
ä½¿ç”¨å®é™…éƒ¨ç½²åçš„ gas profiling æ›´æ–°è¿™äº›æ•°æ®ã€‚

---

### 14. æƒé™å’Œå®‰å…¨æ€§é—®é¢˜ âš ï¸ **é«˜é£é™©** âœ… å·²è§£å†³

#### é—®é¢˜æè¿°
æ•°æ®æ¨é€æ¥å£éœ€è¦ä¸¥æ ¼çš„æƒé™æ§åˆ¶ï¼š

```solidity
modifier onlyBusinessContract() {
    // å…è®¸ä¸šåŠ¡æ¨¡å—è°ƒç”¨
    address collateralManager = _getCachedCollateralManager();
    address lendingEngine = _getCachedLendingEngine();
    // ...
}
```

#### æ½œåœ¨é£é™©
- âŒ å¦‚æœæƒé™éªŒè¯æœ‰æ¼æ´ï¼Œæ¶æ„åˆçº¦å¯èƒ½æ¨é€é”™è¯¯æ•°æ®
- âŒ ç¼“å­˜æ•°æ®å¯èƒ½è¢«æ¶æ„ä¿®æ”¹
- âŒ å¯¼è‡´ç”¨æˆ·æŸ¥è¯¢åˆ°é”™è¯¯ä¿¡æ¯

#### è§£å†³æ–¹æ¡ˆå»ºè®®
1. **ä¸¥æ ¼æƒé™éªŒè¯**ï¼š
   ```solidity
   modifier onlyBusinessContract() {
       address collateralManager = Registry(_registryAddr)
           .getModuleOrRevert(ModuleKeys.KEY_CM);
       address lendingEngine = Registry(_registryAddr)
           .getModuleOrRevert(ModuleKeys.KEY_LE);
       
       require(
           msg.sender == collateralManager || 
           msg.sender == lendingEngine ||
           msg.sender == vaultBusinessLogic,
           "Unauthorized"
       );
       _;
   }
   ```

2. **æ•°æ®éªŒè¯**ï¼š
   - æ¨é€æ—¶éªŒè¯æ•°æ®åˆç†æ€§
   - ä¸è´¦æœ¬æ•°æ®å¯¹æ¯”éªŒè¯

#### ä¿®æ”¹æ–¹æ¡ˆæ›´æ”¹ä¸º
- **1h æ¨¡å—ç¼“å­˜ + è‡ªåŠ¨åˆ·æ–°ï¼ˆfail-closedï¼‰**ï¼š`VaultRouter/PositionView.onlyBusinessContract` ä½¿ç”¨ 1 å°æ—¶ç¼“å­˜çš„ CM/LE/VBL åœ°å€ï¼Œè¿‡æœŸæˆ–ç¼ºå¤±è‡ªåŠ¨åˆ·æ–°åå†æ ¡éªŒï¼Œéç™½åå•ç›´æ¥æ‹’ç»ã€‚
- **è§’è‰²ä¸ç™½åå•åŒé‡æ ¡éªŒ**ï¼š`PositionView.pushUserPositionUpdate` è¿˜éœ€ `ACTION_VIEW_PUSH` è§’è‰²ï¼›`VaultRouter` ä¾èµ–ç™½åå•ã€‚
- **æ¨é€å¯¹è´¦ä¸å¤±è´¥æ‰“ç‚¹**ï¼šPositionView å†™ç¼“å­˜å‰é‡è¯» CM/LEï¼Œæ•°å€¼ä¸ä¸€è‡´åˆ™å›æ»šï¼Œè¯»å–å¤±è´¥ emit `CacheUpdateFailed`ï¼›VaultRouter èµ°ä¿¡ä»»è·¯å¾„ã€‚æ¸…ç®—/å€Ÿè¿˜è·¯å¾„è§†å›¾æ¨é€å¤±è´¥ä¼šå›æ»šä¸»äº¤æ˜“ï¼Œä¿æŒå¼ºä¸€è‡´ã€‚
- **è¿ç»´åˆ·æ–°**ï¼šæ¨¡å—åœ°å€å˜æ›´åç”± admin è°ƒç”¨ `refreshModuleCache`ï¼ˆVaultRouter/PositionViewï¼‰ï¼Œé¿å…ç¼“å­˜è¿‡æœŸå¯¼è‡´æ¨é€è¢«æ‹’ã€‚

#### å½“å‰çŠ¶æ€ï¼ˆå·²å®æ–½è§£å†³æ–¹æ¡ˆï¼‰
- âœ… **1h æ¨¡å—ç¼“å­˜æœºåˆ¶**ï¼šVaultRouter/PositionView ä½¿ç”¨ 1 å°æ—¶æ¨¡å—åœ°å€ç¼“å­˜ï¼ˆMODULE_CACHE_DURATION = 3600ï¼‰ï¼Œè¿‡æœŸæˆ–ç¼ºå¤±æ—¶è‡ªåŠ¨åˆ·æ–°åå†æ ¡éªŒç™½åå•ï¼Œå…¼é¡¾æ€§èƒ½ä¸å®‰å…¨æ€§ã€‚
- âœ… **ç™½åå• + è§’è‰²åŒé‡æ ¡éªŒ**ï¼š
  - PositionViewï¼šç™½åå•ï¼ˆCM/LE/VaultCore/VBLï¼‰+ `ACTION_VIEW_PUSH` è§’è‰²åŒé‡æ ¡éªŒ
  - VaultRouterï¼šç™½åå•ï¼ˆCM/LE/VBLï¼‰æ ¡éªŒ
- âœ… **æ¨é€å¯¹è´¦æœºåˆ¶**ï¼šPositionView å†™ç¼“å­˜å‰ä» CM/LE é‡è¯»è´¦æœ¬ï¼Œæ•°å€¼ä¸ä¸€è‡´åˆ™ `PositionView__LedgerMismatch` å›æ»šï¼›è´¦æœ¬è¯»å–å¤±è´¥ emit `CacheUpdateFailed` äº‹ä»¶ä¾›é“¾ä¸‹é‡è¯•ã€‚
- âœ… **è¿ç»´åˆ·æ–°æ¥å£**ï¼šadmin å¯è°ƒç”¨ `refreshModuleCache()` æ‰‹åŠ¨åˆ·æ–°æ¨¡å—ç¼“å­˜ï¼Œæ¨¡å—åœ°å€å˜æ›´åéœ€åŠæ—¶åˆ·æ–°ã€‚

#### æµ‹è¯•æ–‡ä»¶ï¼š
- **ä¸»è¦æµ‹è¯•æ–‡ä»¶**ï¼š
  - `test/Vault/view/PositionView.cache-validity.test.ts` - PositionView æƒé™ä¸æ•°æ®æ ¡éªŒæµ‹è¯•
    - éªŒè¯éä¸šåŠ¡æ¨¡å—è°ƒç”¨è¢«æ‹’ç»
    - éªŒè¯ä¸šåŠ¡æ¨¡å—ç¼ºæ¨é€è§’è‰²æ—¶è¢« MissingRole æ‹’ç»
    - éªŒè¯éç™½åå•åœ°å€å³ä¾¿æ‹¥æœ‰æ¨é€è§’è‰²ä¹Ÿä¼šè¢«æ‹’ç»
    - éªŒè¯æ¨é€æ•°æ®ä¸è´¦æœ¬ä¸ä¸€è‡´æ—¶å›æ»š
    - éªŒè¯è´¦æœ¬è¯»å–å¤±è´¥æ—¶å‘å‡º CacheUpdateFailed äº‹ä»¶
    - éªŒè¯ç®¡ç†å‘˜å¯é€šè¿‡ retryUserPositionUpdate ä¿®å¤ç¼“å­˜
    - éªŒè¯ä¸šåŠ¡æ¨¡å—æœ‰æƒé™æ—¶å¯æ¨é€å¹¶å†™ç¼“å­˜
  - `test/Vault/view/VaultRouter.cache-consistency.test.ts` - VaultRouter ç¼“å­˜ä¸€è‡´æ€§ä¸æƒé™æµ‹è¯•
    - éªŒè¯ç¼“å­˜å¤±æ•ˆæ—¶ç™½åå•åœ°å€è°ƒç”¨åº”è‡ªåŠ¨åˆ·æ–°å¹¶æ”¾è¡Œ
    - éªŒè¯éç™½åå•åœ°å€è°ƒç”¨åº”è¢«æ‹’ç»
    - éªŒè¯ pushUserPositionUpdate éä¸šåŠ¡åœ°å€åº”è¢«æ‹’ç»
    - éªŒè¯ refreshModuleCache åº”æ›´æ–°æ¨¡å—ç¼“å­˜å¹¶å‘å‡ºäº‹ä»¶
    - éªŒè¯æ¨¡å—ç¼“å­˜è¿‡æœŸå isModuleCacheValid åº”ä¸º false

### 15. æµ‹è¯•å¤æ‚åº¦é—®é¢˜ âš ï¸ **ä½é£é™©**

#### é—®é¢˜æè¿°
åŒæ¶æ„æ¨¡å¼å¢åŠ äº†æµ‹è¯•å¤æ‚åº¦ï¼š
- éœ€è¦æµ‹è¯•è´¦æœ¬å’Œç¼“å­˜çš„ä¸€è‡´æ€§
- éœ€è¦æµ‹è¯•æ¨é€å¤±è´¥åœºæ™¯
- éœ€è¦æµ‹è¯•å¹¶å‘æ›´æ–°åœºæ™¯

#### å½±å“
- âš ï¸ æµ‹è¯•ç”¨ä¾‹æ•°é‡å¢åŠ 
- âš ï¸ æµ‹è¯•æ‰§è¡Œæ—¶é—´å¢åŠ 
- âš ï¸ éœ€è¦æ›´å¤æ‚çš„æµ‹è¯•ç¯å¢ƒ

## ğŸš¨ å…³é”®æ¶æ„ç¼ºé™·ï¼ˆ2025-12-15 è¡¥å……å®¡è®¡ï¼‰

> **éªŒè¯çŠ¶æ€**ï¼šä»¥ä¸‹é—®é¢˜å·²é€šè¿‡ä»£ç çº§åˆ†æç¡®è®¤å­˜åœ¨ï¼ˆ2025-12-15 äºŒæ¬¡éªŒè¯ï¼‰

### 16. å€Ÿè´·æµç¨‹æ§åˆ¶æµæ–­è£‚ âš ï¸ **P0 é˜»æ–­æ€§é—®é¢˜** âœ… å·²è§£å†³

#### é—®é¢˜æè¿°ï¼ˆå†å²é—®é¢˜ï¼Œå·²ä¿®å¤ï¼‰
æ ¹æ®æ¶æ„æ–‡æ¡£ï¼Œ`VaultCore` åº”ç»Ÿä¸€è°ƒç”¨ `LendingEngine` è¿›è¡Œè´¦æœ¬å†™å…¥ã€‚ä½†å†å²ä»£ç è·¯å¾„å­˜åœ¨é—®é¢˜ï¼š
1. `VaultCore.borrow` è°ƒç”¨ `VaultRouter.processUserOperation`ã€‚
2. `VaultRouter.processUserOperation` è°ƒç”¨ `_distributeToModule`ã€‚
3. `VaultRouter._distributeToModule` é’ˆå¯¹ `ACTION_BORROW` **æœªæ‰§è¡Œä»»ä½•æ“ä½œ**ï¼ˆç©ºä»£ç å—ï¼‰ã€‚
4. `VaultLendingEngine.borrow` å…·æœ‰ `onlyVaultCore` ä¿®é¥°ç¬¦ï¼Œè¦æ±‚ `msg.sender` å¿…é¡»ä¸º `VaultCore`ã€‚

**å†å²ç»“æœ**ï¼šæ ‡å‡†å€Ÿè´·æµç¨‹æ— æ³•æ‰§è¡Œã€‚`VaultCore` å§”æ‰˜ç»™ `VaultRouter`ï¼Œä½† `VaultRouter` ä¸ä½œä¸ºï¼Œä¸”å³ä½¿ `VaultRouter` å°è¯•è°ƒç”¨ `LendingEngine`ï¼Œä¹Ÿä¼šå› æƒé™æ ¡éªŒå¤±è´¥ï¼ˆ`msg.sender` ä¸º `VaultRouter` è€Œé `VaultCore`ï¼‰è€Œ revertã€‚

#### å½“å‰çŠ¶æ€ï¼ˆå·²å®æ–½è§£å†³æ–¹æ¡ˆï¼‰
- âœ… **é‡‡ç”¨æ–¹æ¡ˆ A**ï¼š`VaultCore` ç›´æ¥è°ƒç”¨ `LendingEngine`ï¼ˆ`ILendingEngineBasic.borrow/repay`ï¼‰ï¼Œä¸å†ç»è¿‡ `VaultRouter` è¿›è¡Œè´¦æœ¬å†™å…¥æ“ä½œã€‚
- âœ… **å®ç°ç»†èŠ‚**ï¼š
  - `VaultCore.borrow()`ï¼ˆç¬¬84-88è¡Œï¼‰ï¼šç›´æ¥ä» Registry è§£æ `KEY_LE`ï¼Œè°ƒç”¨ `ILendingEngineBasic.borrow(msg.sender, asset, amount, 0, 0)`
  - `VaultCore.repay()`ï¼ˆç¬¬94-98è¡Œï¼‰ï¼šç›´æ¥ä» Registry è§£æ `KEY_LE`ï¼Œè°ƒç”¨ `ILendingEngineBasic.repay(msg.sender, asset, amount)`
  - `VaultRouter._distributeToModule()`ï¼šå¯¹ `ACTION_BORROW` å’Œ `ACTION_REPAY` ä¿æŒç©ºä»£ç å—ï¼Œä»…æ›´æ–°æœ¬åœ°ç¼“å­˜ï¼ˆ`_updateLocalState`ï¼‰ï¼Œç¬¦åˆ"å†™å…¥ä¸ç» View"åŸåˆ™
  - `LendingEngine` é€šè¿‡ `onlyVaultCore` ä¿®é¥°ç¬¦ç¡®ä¿ä»… `KEY_VAULT_CORE` å¯è°ƒç”¨è´¦æœ¬å†™å…¥å‡½æ•°
- âœ… **ç¬¦åˆæ¶æ„åŸåˆ™**ï¼šéµå¾ª Architecture-Guide.md ä¸­"å†™å…¥ä¸ç» View"çš„æ ¸å¿ƒåŸåˆ™ï¼Œè´¦æœ¬å†™å…¥ç»Ÿä¸€ç”± VaultCore æ‰§è¡Œï¼ŒView å±‚ä»…è´Ÿè´£ç¼“å­˜æ›´æ–°å’Œäº‹ä»¶å‘å‡ºã€‚
- âœ… **View æ¨é€å¤±è´¥å¤„ç†**ï¼šéµå¾ª Architecture-Guide.md çš„"æœ€ä½³åŠªåŠ›"æ¨¡å¼ï¼ˆç¬¬41-46è¡Œï¼‰ï¼Œä½¿ç”¨ try/catch å¤„ç† View æ¨é€å¤±è´¥ï¼Œå¤±è´¥æ—¶å‘å‡º `CacheUpdateFailed` äº‹ä»¶ï¼Œä¸»æµç¨‹ä¸å›æ»šï¼Œä¿éšœè´¦æœ¬å†™å…¥çš„å¯ç”¨æ€§ã€‚

#### æ•°æ®æµè·¯å¾„
```
ç”¨æˆ·è°ƒç”¨ VaultCore.borrow/repay
  â†“
VaultCore ç›´æ¥ä» Registry è§£æ KEY_LE
  â†“
ç›´æ¥è°ƒç”¨ ILendingEngineBasic.borrow/repayï¼ˆè´¦æœ¬å†™å…¥ï¼‰
  â†“
LendingEngine å†…éƒ¨ï¼š
  1. æ›´æ–°è´¦æœ¬ï¼ˆrecordBorrow/recordRepayï¼‰
  2. æ¨é€ View ç¼“å­˜ï¼ˆ_pushUserPositionToViewï¼Œæœ€ä½³åŠªåŠ›æ¨¡å¼ï¼‰
  3. æ¨é€å¥åº·çŠ¶æ€ï¼ˆ_pushHealthStatusï¼‰
  4. è§¦å‘å¥–åŠ±ï¼ˆ_notifyRewardManagerï¼‰
```

#### æµ‹è¯•æ–‡ä»¶ï¼š
- **ä¸»è¦æµ‹è¯•æ–‡ä»¶**ï¼š
  - `test/Vault/VaultLendingEngine.refactor.test.ts` - VaultLendingEngine æ‹†åˆ†åçš„è´¦æœ¬ä¸å…¥å£ä¸€è‡´æ€§æµ‹è¯•ï¼ˆ28ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
    - éªŒè¯ `onlyVaultCore` æƒé™ä¿æŠ¤ï¼šé VaultCore è°ƒç”¨ `borrow/repay` åº”è¢«æ‹’ç»
    - éªŒè¯ç»Ÿä¸€å…¥å£ï¼š`borrow/repay` ä»…å…è®¸ `KEY_VAULT_CORE` è°ƒç”¨
    - éªŒè¯è´¦æœ¬å†™å…¥ä¸è§†å›¾æ¨é€ï¼šå€Ÿ/è¿˜å VaultRouter ç¼“å­˜æ­£ç¡®æ›´æ–°
    - éªŒè¯å¥åº·æ¨é€ï¼šå€Ÿ/æ¸…ç®—å HealthView æ”¶åˆ° `pushRiskStatus`
    - éªŒè¯æ¸…ç®—ç›´è¾¾å…¥å£ï¼š`forceReduceDebt` éœ€ `ACTION_LIQUIDATE` æƒé™ï¼Œä¸”ä¼šåŒæ­¥ View/Health
    - éªŒè¯è¾¹ç•Œæ¡ä»¶ï¼šé›¶é‡‘é¢ã€è¶…é¢è¿˜æ¬¾ã€å®Œæ•´è¿˜æ¬¾/æ¸…ç®—ç­‰åœºæ™¯
    - éªŒè¯äº‹ä»¶å‘å‡ºï¼š`DebtRecorded`ã€`UserTotalDebtValueUpdated` ç­‰äº‹ä»¶
  - `test/Vault/VaultLendingEngine.dual-entry.test.ts` - åŒå…¥å£ï¼ˆVaultCore + LiquidationManagerï¼‰æµ‹è¯•ï¼ˆ19ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
    - éªŒè¯ `borrow/repay` é€šè¿‡ VaultCore è°ƒç”¨æ—¶æ›´æ–°è´¦æœ¬å’Œ View/Health ç¼“å­˜
    - éªŒè¯é `KEY_VAULT_CORE` è°ƒç”¨è€…è¢«æ‹’ç»ï¼ˆ`VaultLendingEngine__OnlyVaultCore` é”™è¯¯ï¼‰
    - éªŒè¯ VaultCore borrow åç›´æ¥æ¸…ç®—ä¿æŒ View åŒæ­¥
    - éªŒè¯å€Ÿ/è¿˜æ“ä½œçš„ç«¯åˆ°ç«¯æµç¨‹ï¼ˆè´¦æœ¬æ›´æ–° â†’ View ç¼“å­˜ â†’ Health æ¨é€ï¼‰
    - **éªŒè¯ View æ¨é€å¤±è´¥å¤„ç†**ï¼šå½“ VaultRouter push å¤±è´¥æ—¶ï¼Œå‘å‡º `CacheUpdateFailed` äº‹ä»¶ï¼Œä½† borrow æ“ä½œæˆåŠŸå®Œæˆï¼ˆæœ€ä½³åŠªåŠ›æ¨¡å¼ï¼Œç¬¦åˆ Architecture-Guide.mdï¼‰
    - éªŒè¯æ¨¡å—ç¼ºå¤±åœºæ™¯ï¼šKEY_HEALTH_VIEWã€KEY_CMã€KEY_ACCESS_CONTROL ç¼ºå¤±æ—¶çš„å›æ»šè¡Œä¸º

#### ç¬¬ 16 é¡¹å®Œæˆæ ‡å‡†ï¼ˆéªŒæ”¶å£å¾„ï¼‰

ç›®æ ‡ï¼šä¿è¯ Reward ä»…é€šè¿‡ **å”¯ä¸€è·¯å¾„**è§¦å‘ä¸ç»“ç®—ï¼Œé¿å…â€œç»•è¿‡å…¥å£/æœªè½è´¦å…ˆå‘/æƒé™ç»•è¿‡â€ã€‚

- **å…¥å£æ”¶æ•›ï¼ˆå¼ºçº¦æŸï¼‰**
  - å…è®¸çš„å”¯ä¸€è·¯å¾„ï¼š`LendingEngine` â†’ `RewardManager.onLoanEvent(uint256)` â†’ `RewardManagerCore.onLoanEvent(uint256)`
  - `RewardManagerCore.onLoanEvent` / `onBatchLoanEvents` å¿…é¡»æ‹’ç»ä»»ä½•é `RewardManager` çš„ç›´æ¥è°ƒç”¨ï¼š
    - revertï¼š`RewardManagerCore__UseRewardManagerEntry`
    - eventï¼š`DeprecatedDirectEntryAttempt(caller,timestamp)`ï¼ˆä¾›é“¾ä¸‹å®¡è®¡ï¼‰
- **ä»£ç çº§æ£€æŸ¥ï¼ˆgrep/CI å¯æ‰§è¡Œï¼‰**
  - å…¨ä»“åº“ä¸åº”å‡ºç°é™¤ `src/Reward/RewardManager.sol` ä¹‹å¤–çš„ï¼š
    - `RewardManagerCore(...).onLoanEvent(` / `RewardManagerCore(...).onBatchLoanEvents(`
  - ä¸šåŠ¡é“¾è·¯ï¼ˆLEï¼‰ä»…è°ƒç”¨ `IRewardManager.onLoanEvent(...)`ï¼ˆæœ€ä½³åŠªåŠ› try/catch å…è®¸å¤±è´¥ä¸å›æ»šï¼‰
- **æµ‹è¯•/è„šæœ¬è¦†ç›–ï¼ˆè‡³å°‘å…¶ä¸€æ»¡è¶³ï¼‰**
  - å•å…ƒ/é›†æˆæµ‹è¯•ï¼šæ–­è¨€â€œç›´æ¥è°ƒç”¨ RMCore ä¼š revertï¼ˆUseRewardManagerEntryï¼‰â€ï¼Œä¸”æ ‡å‡†å…¥å£å¯æ­£å¸¸è§¦å‘ç§¯åˆ†å‘æ”¾/æ‰£ç½šã€‚
  - E2Eï¼šé€šè¿‡ `RewardView` éªŒè¯ç§¯åˆ†æ•°æ®ï¼ˆearned/burned/penaltyLedger ç­‰ï¼‰éš borrow/repay çš„è½è´¦è·¯å¾„å‘ç”Ÿå˜åŒ–ã€‚
---

### 17. å¥–åŠ±æ¨¡å—è§¦å‘ç¼ºå¤± âš ï¸ **P0 é˜»æ–­æ€§é—®é¢˜** âœ… å·²è§£å†³

#### é—®é¢˜æè¿°ï¼ˆå†å²é—®é¢˜ï¼Œå·²ä¿®å¤ï¼‰
æ¶æ„æ–‡æ¡£è¦æ±‚"è´¦æœ¬è½è´¦åè§¦å‘å¥–åŠ±"ï¼Œå¹¶æŒ‡å®šè·¯å¾„ä¸º `LendingEngine` -> `RewardManager`ã€‚
å†å²ä»£ç ä¸­å€Ÿè´·é€»è¾‘ï¼ˆ`borrow`/`repay`ï¼‰æ— ä»»ä½•å¯¹ `RewardManager` çš„è°ƒç”¨ï¼Œå¥–åŠ±è§¦å‘åŠŸèƒ½ç¼ºå¤±ã€‚

#### å½“å‰çŠ¶æ€ï¼ˆå·²å®æ–½è§£å†³æ–¹æ¡ˆï¼‰
- âœ… **å¥–åŠ±è§¦å‘å·²å®ç°**ï¼š`LendingEngineCore.borrow()` å’Œ `repay()` å‡½æ•°ä¸­å·²é›†æˆå¥–åŠ±è§¦å‘é€»è¾‘ã€‚
- âœ… **å®ç°ç»†èŠ‚**ï¼š
  - `LendingEngineCore.borrow()`ï¼ˆç¬¬30-35è¡Œï¼‰ï¼šè´¦æœ¬è½è´¦åè°ƒç”¨ `_notifyRewardManager(s, user, amount)`
  - `LendingEngineCore.repay()`ï¼ˆç¬¬38-43è¡Œï¼‰ï¼šè´¦æœ¬è½è´¦åè°ƒç”¨ `_notifyRewardManager(s, user, amount)`
  - `_notifyRewardManager()`ï¼ˆç¬¬65-78è¡Œï¼‰ï¼šæœ€ä½³åŠªåŠ›æ¨¡å¼ï¼Œä» Registry è·å– `KEY_REWARD_MANAGER_V1`ï¼Œè°ƒç”¨ `IRewardManager.onLoanEvent(user, amount, 0, true)`
  - å¥–åŠ±è§¦å‘å¤±è´¥ä¸å½±å“ä¸»æµç¨‹ï¼šä½¿ç”¨ try/catch å¤„ç†ï¼ŒRewardManager æœªé…ç½®æˆ–è°ƒç”¨å¤±è´¥æ—¶é™é»˜å¿½ç•¥
- âœ… **ç¬¦åˆæ¶æ„åŸåˆ™**ï¼šéµå¾ª Architecture-Guide.md ç¬¬610è¡Œçš„"æœ€ä½³åŠªåŠ›è§¦å‘ `RewardManager.onLoanEvent`"è¦æ±‚ï¼Œä¿éšœè´¦æœ¬å†™å…¥çš„å¯ç”¨æ€§ã€‚

#### å®ç°ä»£ç 
```solidity
// LendingEngineCore.sol ç¬¬29-35è¡Œ
function borrow(LendingEngineStorage.Layout storage s, address user, address asset, uint256 amount) internal {
    s.recordBorrow(user, asset, amount);
    _pushUserPositionToView(s, user, asset);
    _pushHealthStatus(s, user);
    _notifyRewardManager(s, user, amount);  // å¥–åŠ±è§¦å‘
}

// LendingEngineCore.sol ç¬¬65-78è¡Œ
function _notifyRewardManager(LendingEngineStorage.Layout storage s, address user, uint256 amount) internal {
    address rewardManager;
    try Registry(s._registryAddr).getModuleOrRevert(ModuleKeys.KEY_REWARD_MANAGER_V1) returns (address addr) {
        rewardManager = addr;
    } catch {
        return;  // RewardManager æœªé…ç½®æ—¶é™é»˜è¿”å›
    }

    try IRewardManager(rewardManager).onLoanEvent(user, amount, 0, true) {
        // ignore
    } catch {
        // ignore reward failure  // å¥–åŠ±è§¦å‘å¤±è´¥ä¸å½±å“ä¸»æµç¨‹
    }
}
```

#### æµ‹è¯•æ–‡ä»¶ï¼š

**å¥–åŠ±è§¦å‘æµ‹è¯•è¦†ç›–ï¼ˆå·²é€šè¿‡ï¼‰**

- **LendingEngine â†” RewardManager é›†æˆ**ï¼šæ ¸å¿ƒå€Ÿæ¬¾/è¿˜æ¬¾æµç¨‹å®Œæˆåè§¦å‘å¥–åŠ±ï¼ˆæœ€ä½³åŠªåŠ›ï¼Œå¤±è´¥ä¸å›æ»šï¼‰ï¼Œå¯¹åº”æµ‹è¯•ç”¨ä¾‹ï¼š
  - `test/Vault/VaultLendingEngine.refactor.test.ts` - ä½¿ç”¨ `MockRewardManager` éªŒè¯å€Ÿæ¬¾/è¿˜æ¬¾æ—¶è°ƒç”¨å¥–åŠ±æ¥å£
  - `test/Vault/VaultLendingEngine.dual-entry.test.ts` - åŒå…¥å£è·¯å¾„ä¸‹çš„å¥–åŠ±è§¦å‘éªŒè¯

- **ç«¯åˆ°ç«¯æ’®åˆç»“ç®—**ï¼šå®Œæ•´æ’®åˆæµç¨‹ï¼ˆå‡ºå€Ÿä¿ç•™ â†’ ç­¾åæ ¡éªŒ â†’ è½è´¦ â†’ è´¹ç”¨ â†’ å‡€é¢å‘æ”¾ï¼‰è¦†ç›–å¥–åŠ±è§¦å‘é“¾è·¯ï¼š
  - `test/Reward/Settlement.e2e.test.ts` - å·²è·‘é€šå¹¶é€šè¿‡ï¼Œè½è´¦åä¼šè°ƒç”¨ LendingEngineï¼Œç»§è€Œè§¦å‘ `_notifyRewardManager`ï¼ˆæœ€ä½³åŠªåŠ›æ¨¡å¼ï¼‰

- **æœ€ä½³åŠªåŠ›è¯­ä¹‰éªŒè¯**ï¼šæµ‹è¯•ä¸­ä½¿ç”¨çš„ `MockRewardManager` ç¡®è®¤è°ƒç”¨å‘ç”Ÿï¼›è‹¥æœªé…ç½®æˆ–è°ƒç”¨å¤±è´¥ï¼Œé“¾è·¯ä¸å›æ»šï¼ˆä¸æ–‡æ¡£è¦æ±‚ä¸€è‡´ï¼‰

---

### 18. å¥åº·çŠ¶æ€æ¨é€é™é»˜å¤±è´¥é£é™© âš ï¸ **P1 é«˜é£é™©** âœ… å·²éªŒè¯

#### é—®é¢˜æè¿°
åœ¨ `VaultLendingEngine._pushHealthStatus` ä¸­ä½¿ç”¨ä½çº§è°ƒç”¨å¹¶æ˜¾å¼å¿½ç•¥è¿”å›å€¼ã€‚

#### ä»£ç éªŒè¯è¯æ®

**VaultLendingEngine._pushHealthStatus()** ç¬¬1060-1068è¡Œï¼š
```solidity
// æ¨é€åˆ° HealthView
(bool ok, ) = hv.call(abi.encodeWithSignature(
    "pushRiskStatus(address,uint256,uint256,bool,uint256)",
    user,
    hfBps,
    minHFBps,
    under,
    block.timestamp
));
ok; // silence  <-- æ˜¾å¼å¿½ç•¥è¿”å›å€¼
```

#### å½±å“
- âš ï¸ å¦‚æœ `HealthView` é€»è¾‘é”™è¯¯æˆ– Gas ä¸è¶³ï¼Œå¥åº·å› å­æ›´æ–°å°†é™é»˜å¤±è´¥ã€‚
- âš ï¸ é“¾ä¸‹æ¸…ç®—æœºå™¨äººå¯èƒ½è¯»å–åˆ°è¿‡æ—¶çš„å¥åº·çŠ¶æ€ï¼Œå¯¼è‡´æ¸…ç®—å»¶è¿Ÿæˆ–è¯¯åˆ¤ã€‚

#### æ”¹è¿›å»ºè®®
- è‡³å°‘åº”å‘å‡º `HealthPushFailed` äº‹ä»¶ï¼Œä»¥ä¾¿é“¾ä¸‹ç›‘æ§ç³»ç»Ÿæ„ŸçŸ¥å¹¶ä»‹å…¥ã€‚

#### å½“å‰å®ç°ä¸æµ‹è¯•ï¼ˆå·²å¯¹é½ Architecture-Guideï¼‰
- å®ç°æƒ…å†µï¼š`VaultLendingEngineCore._pushHealthStatus` å·²æ”¹ä¸º try/catch æœ€ä½³åŠªåŠ›æ¨¡å¼ï¼Œå¤±è´¥ä¸å›æ»šï¼Œemit `CacheUpdateFailed` ä¸ `HealthPushFailed`ï¼ˆåŒ…å« user/healthView/totalCollateral/totalDebt/reasonï¼‰ï¼›ä¾èµ–ç¼ºå¤±ã€æ— ä»£ç ã€Collateral åˆè®¡è¯»å–å¤±è´¥ã€HealthView revertã€LRM ç¼ºå¤±ã€å¥åº·å› å­æº¢å‡ºç­‰éƒ½ä¼šå‘Šè­¦ã€‚
- è¦†ç›–æµ‹è¯•ï¼š
  - `test/Vault/VaultLendingEngine.dual-entry.test.ts`ï¼ˆé€šè¿‡ï¼‰ï¼šå€Ÿæ¬¾/è¿˜æ¬¾/forceReduceDebt å¤šè·¯å¾„ï¼›HealthView æ— ä»£ç ã€revertï¼›LRM æ— ä»£ç ï¼›CM total è¯»å–å¤±è´¥ï¼›å¤šèµ„äº§/æ‰¹é‡å¼æ¸…ç®—è·¯å¾„ä¸‹å‡è§¦å‘ `HealthPushFailed` è€Œä¸å›æ»šã€‚
  - ç›¸å…³ mockï¼š`src/Mocks/RevertingHealthView.sol`ã€`src/Mocks/RevertingCollateralTotals.sol`ã€‚
  - æµ‹è¯•ç»“æœï¼šæœ€æ–°è¿è¡Œ 29/29 ç”¨ä¾‹å…¨éƒ¨é€šè¿‡ã€‚

---

### 19. ä»“ä½æ¨é€å¯ç”¨æ€§é£é™© âš ï¸ **P1 é«˜é£é™©** âœ… å·²éªŒè¯

#### é—®é¢˜æè¿°
ä¸å¥åº·æ¨é€ä¸åŒï¼Œ`VaultLendingEngine._pushUserPositionToView` ä½¿ç”¨ç›´æ¥è°ƒç”¨ã€‚

#### ä»£ç éªŒè¯è¯æ®

**VaultLendingEngine._pushUserPositionToView()** ç¬¬1015-1029è¡Œï¼š
```solidity
function _pushUserPositionToView(address user, address asset) internal {
    address cm = _getModuleAddress(ModuleKeys.KEY_CM);
    address viewAddr = _resolveVaultRouterAddr();

    uint256 collateral = ICollateralManager(cm).getCollateral(user, asset);
    uint256 debt = _userDebt[user][asset];

    // ç›´æ¥è°ƒç”¨ï¼Œæ—  try-catch ä¿æŠ¤
    IVaultRouter(viewAddr).pushUserPositionUpdate(user, asset, collateral, debt);
}
```

#### å½±å“
- âš ï¸ å¦‚æœ `VaultRouter` å› ä»»ä½•åŸå›  revertï¼Œæ•´ä¸ªå€Ÿè´·äº¤æ˜“å°†å¤±è´¥ã€‚
- âš ï¸ è¿™ç¬¦åˆå¼ºä¸€è‡´æ€§è¦æ±‚ï¼Œä½†è¿èƒŒ"View å±‚ä¸åº”é˜»æ–­æ ¸å¿ƒä¸šåŠ¡"çš„æŸäº›éŸ§æ€§åŸåˆ™ã€‚

#### æ”¹è¿›å»ºè®®
- è¯„ä¼°æ˜¯å¦éœ€è¦é™çº§ä¸º `try-catch` æ¨¡å¼ï¼Œæˆ–ç¡®è®¤"å¼ºä¸€è‡´æ€§"æ˜¯é¢„æœŸè¡Œä¸ºã€‚å»ºè®®åœ¨æ–‡æ¡£ä¸­æ˜ç¡®æ­¤æƒè¡¡ã€‚

#### å½“å‰å®ç°ä¸æµ‹è¯•ï¼ˆå·²å¯¹é½ Architecture-Guideï¼‰
- å®ç°æƒ…å†µï¼š`LendingEngineCore._pushUserPositionToView` å·²æ”¹ä¸º try/catch æœ€ä½³åŠªåŠ›æ¨¡å¼ï¼Œå¤±è´¥ä¸å›æ»šï¼Œemit `CacheUpdateFailed`ï¼ˆåŒ…å« user/asset/viewAddr/collateral/debt/reasonï¼‰ï¼›ä¾èµ–ç¼ºå¤±ï¼ˆCM æˆ– View åœ°å€ä¸ºé›¶ï¼‰ã€æ— ä»£ç ã€Collateral è¯»å–å¤±è´¥ã€VaultRouter revert ç­‰éƒ½ä¼šå‘Šè­¦ã€‚
- è¦†ç›–æµ‹è¯•ï¼š
  - `test/Vault/VaultLendingEngine.dual-entry.test.ts`ï¼ˆé€šè¿‡ï¼‰ï¼šborrow æ“ä½œåœ¨ VaultRouter revert æ—¶ä»æˆåŠŸå®Œæˆï¼Œå‘å‡º `CacheUpdateFailed` äº‹ä»¶è€Œä¸å›æ»šã€‚
  - `test/Vault/view/PositionView.cache-validity.test.ts`ï¼ˆé€šè¿‡ï¼‰ï¼šè´¦æœ¬è¯»å–å¤±è´¥ã€å€ºåŠ¡è¯»å–å¤±è´¥æ—¶å‘å‡º `CacheUpdateFailed`ï¼Œæ”¯æŒç®¡ç†å‘˜é€šè¿‡ `retryUserPositionUpdate` æ‰‹åŠ¨é‡è¯•ã€‚
  - `test/Vault/liquidation/LiquidationDebtManager.cache-push.test.ts`ï¼ˆé€šè¿‡ï¼‰ï¼šæ¸…ç®—æ¨¡å—çš„ä»“ä½æ¨é€ä¹Ÿé‡‡ç”¨ç›¸åŒçš„æœ€ä½³åŠªåŠ›æ¨¡å¼ã€‚
  - ç›¸å…³ mockï¼š`src/Mocks/RevertingVaultRouter.sol`ã€‚
  - æµ‹è¯•ç»“æœï¼šç›¸å…³ç”¨ä¾‹å…¨éƒ¨é€šè¿‡ã€‚

---

### 20. VaultCore ç¼ºå°‘ viewContractAddrVar å…¬å¼€æ–¹æ³• âš ï¸ **P0 é˜»æ–­æ€§é—®é¢˜** ğŸ†• æ–°å‘ç° âœ… å·²è§£å†³

#### é—®é¢˜æè¿°
å¤šä¸ªæ¨¡å—ï¼ˆ`VaultLendingEngine`ã€`CollateralManager`ã€`VaultBusinessLogic`ã€`LiquidationManager` ç­‰ï¼‰é€šè¿‡ä»¥ä¸‹æ–¹å¼è§£æ VaultRouter åœ°å€ï¼š
```solidity
address vaultCore = _getModuleAddress(ModuleKeys.KEY_VAULT_CORE);
return IVaultCoreMinimal(vaultCore).viewContractAddrVar();
```

ä½† **VaultCore.sol ä¸­æ²¡æœ‰æš´éœ² `viewContractAddrVar()` å…¬å¼€æ–¹æ³•**ã€‚

#### ä»£ç éªŒè¯è¯æ®

**VaultCore.sol** ç¬¬26-27è¡Œï¼š
```solidity
/// @notice Viewå±‚åˆçº¦åœ°å€
address private _viewContractAddr;  // <-- æ˜¯ private çš„ï¼Œæ²¡æœ‰ public getter
```

**å¤šä¸ªæ¨¡å—å°è¯•è°ƒç”¨æ­¤æ–¹æ³•**ï¼ˆgrep æœç´¢ç»“æœï¼‰ï¼š
- `VaultLendingEngine.sol:28` - å®šä¹‰ `IVaultCoreMinimal` æ¥å£åŒ…å« `viewContractAddrVar()`
- `VaultLendingEngine.sol:1034` - `return IVaultCoreMinimal(vaultCore).viewContractAddrVar();`
- `CollateralManager.sol:509` - `return IVaultCoreMinimal(vaultCore).viewContractAddrVar();`
- `VaultBusinessLogic.sol:114` - `try IVaultCoreMinimal(vaultCore).viewContractAddrVar()`
- `LiquidationManager.sol:264/291` - åŒæ ·è°ƒç”¨

#### å½±å“
- âŒ **æ¨¡å—é—´é€šä¿¡æ–­è£‚**ï¼šæ‰€æœ‰å°è¯•é€šè¿‡ VaultCore è§£æ VaultRouter åœ°å€çš„æ¨¡å—éƒ½ä¼šå¤±è´¥ã€‚
- âŒ **`_pushUserPositionToView` æ— æ³•å·¥ä½œ**ï¼šVaultLendingEngine è°ƒç”¨ `_resolveVaultRouterAddr()` ä¼šå¤±è´¥ã€‚
- âŒ **ä¸é—®é¢˜15å åŠ **ï¼šå³ä½¿ä¿®å¤é—®é¢˜15ï¼Œä»“ä½æ¨é€ä»ç„¶æ— æ³•å·¥ä½œã€‚

#### æ”¹è¿›å»ºè®®
åœ¨ `VaultCore.sol` ä¸­æ·»åŠ å…¬å¼€ getterï¼š
```solidity
/// @notice è·å– View å±‚åˆçº¦åœ°å€
function viewContractAddrVar() external view returns (address) {
    return _viewContractAddr;
}
```

#### å½“å‰å®ç°ä¸æµ‹è¯•ï¼ˆå·²å¯¹é½ Architecture-Guideï¼‰
- å®ç°æƒ…å†µï¼š`VaultCore.sol` å·²æ·»åŠ  `viewContractAddrVar()` å…¬å¼€æ–¹æ³•ï¼ˆç¬¬63-67è¡Œï¼‰ï¼Œä¾›å„ä¸šåŠ¡/æ¸…ç®—æ¨¡å—é€šè¿‡ `IVaultCoreMinimal` æ¥å£è§£æ VaultRouter åœ°å€ä½¿ç”¨ã€‚
- ä»£ç ä½ç½®ï¼š
  ```63:67:src/Vault/VaultCore.sol
  /// @notice è·å– View å±‚åˆçº¦åœ°å€
  /// @dev ä¾›å„ä¸šåŠ¡/æ¸…ç®—æ¨¡å—è§£æ VaultRouter åœ°å€ä½¿ç”¨
  function viewContractAddrVar() external view returns (address) {
      return _viewContractAddr;
  }
  ```
- è¦†ç›–æµ‹è¯•ï¼š
  - `test/StatisticsResolution.frontend.test.ts`ï¼ˆé€šè¿‡ï¼‰ï¼šéªŒè¯é€šè¿‡ `KEY_VAULT_CORE.viewContractAddrVar()` è§£æ View åœ°å€çš„å›é€€è·¯å¾„ã€‚
  - `test/GuaranteeAndRisk.integrated.test.ts`ï¼ˆé€šè¿‡ï¼‰ï¼šéªŒè¯ VaultBusinessLogic é€šè¿‡ `viewContractAddrVar()` è§£æ View åœ°å€ã€‚
  - `test/Vault/VaultLendingEngine.refactor.test.ts`ï¼ˆé€šè¿‡ï¼‰ï¼šéªŒè¯ VaultLendingEngine é€šè¿‡ `_resolveVaultRouterAddr()` è°ƒç”¨ `viewContractAddrVar()` æ­£å¸¸å·¥ä½œã€‚
  - `test/Vault/viewContractAddrVar.comprehensive.test.ts`ï¼ˆæ–°å¢ï¼Œ13/13 é€šè¿‡ï¼‰ï¼šå…¨é¢æµ‹è¯•è¦†ç›–æ–‡æ¡£ä¸­æè¿°çš„æ‰€æœ‰å½±å“åœºæ™¯ï¼š
    - **æ¨¡å—é—´é€šä¿¡æµ‹è¯•**ï¼ˆ4ä¸ªæµ‹è¯•ï¼‰ï¼š
      - âœ… VaultCore.viewContractAddrVar() è¿”å›æ­£ç¡®çš„ VaultRouter åœ°å€
      - âœ… VaultLendingEngine._resolveVaultRouterAddr() æ­£ç¡®è§£æ View åœ°å€
      - âœ… CollateralManager._resolveVaultRouterAddr() æ­£ç¡®è§£æ View åœ°å€
      - âœ… VaultBusinessLogic._resolveVaultRouterAddr() æ­£ç¡®è§£æ View åœ°å€
    - **_pushUserPositionToView åŠŸèƒ½æµ‹è¯•**ï¼ˆ3ä¸ªæµ‹è¯•ï¼‰ï¼š
      - âœ… borrow æ—¶ä»“ä½æ¨é€æ­£å¸¸å·¥ä½œ
      - âœ… repay æ—¶ä»“ä½æ¨é€æ­£å¸¸å·¥ä½œ
      - âœ… viewContractAddrVar ä¸ºç©ºæ—¶çš„é”™è¯¯å¤„ç†ï¼ˆç¬¦åˆå®ç°è¦æ±‚ï¼‰
    - **ä»“ä½æ¨é€å®Œæ•´æ€§æµ‹è¯•**ï¼ˆ2ä¸ªæµ‹è¯•ï¼‰ï¼š
      - âœ… æ‰€æœ‰æ¨¡å—çš„ä»“ä½æ¨é€åŠŸèƒ½æ­£å¸¸å·¥ä½œ
      - âœ… å¤šèµ„äº§åœºæ™¯ä¸‹ä»“ä½æ¨é€æ­£å¸¸å·¥ä½œ
    - **æ¨¡å—é—´é€šä¿¡å®Œæ•´æ€§éªŒè¯**ï¼ˆ2ä¸ªæµ‹è¯•ï¼‰ï¼š
      - âœ… æ‰€æœ‰æ¨¡å—é€šè¿‡ IVaultCoreMinimal æ¥å£è®¿é—® viewContractAddrVar
      - âœ… VaultCore.viewContractAddrVar å˜æ›´åï¼Œæ‰€æœ‰æ¨¡å—èƒ½è·å–æ–°åœ°å€
    - **è¾¹ç•Œæƒ…å†µå’Œé”™è¯¯å¤„ç†**ï¼ˆ2ä¸ªæµ‹è¯•ï¼‰ï¼š
      - âœ… VaultCore æœªæ³¨å†Œæ—¶æ¨¡å—æ­£ç¡®å¤„ç†
      - âœ… viewContractAddrVar è¿”å›é›¶åœ°å€æ—¶ï¼Œ_pushUserPositionToView å‘å‡ºäº‹ä»¶ä½†ä¸å›æ»š
  - ç›¸å…³ mockï¼š`src/Mocks/MockVaultCoreView.sol`ã€`src/Mocks/MockVaultCore.sol` å®ç°äº† `viewContractAddrVar()` ç”¨äºæµ‹è¯•ã€‚
  - æµ‹è¯•ç»“æœï¼šæ‰€æœ‰æµ‹è¯•ç”¨ä¾‹å…¨éƒ¨é€šè¿‡ï¼ˆ13/13ï¼‰ï¼Œæ¨¡å—é—´é€šä¿¡æ­£å¸¸ï¼Œæ‰€æœ‰å½±å“åœºæ™¯å‡å·²è¦†ç›–éªŒè¯ã€‚


## âœ… ä¼˜åŠ¿æ€»ç»“

å°½ç®¡å­˜åœ¨ä¸Šè¿°é—®é¢˜ï¼ŒåŒæ¶æ„æ¨¡å¼ä¹Ÿæœ‰æ˜æ˜¾ä¼˜åŠ¿ï¼š

1. **æŸ¥è¯¢æ€§èƒ½**ï¼š0 gasæŸ¥è¯¢ï¼Œå“åº”é€Ÿåº¦å¿«
2. **ç”¨æˆ·ä½“éªŒ**ï¼šå‰ç«¯å¯ä»¥å¿«é€Ÿè·å–æ•°æ®
3. **AIå‹å¥½**ï¼šå®Œæ•´çš„äº‹ä»¶å†å²ä¾¿äºåˆ†æ
4. **Gasä¼˜åŒ–**ï¼šæŸ¥è¯¢å…è´¹ï¼Œåªåœ¨æ›´æ–°æ—¶æ”¯ä»˜

## ğŸ¯ æ”¹è¿›å»ºè®®ä¼˜å…ˆçº§

### ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼ˆå¿…é¡»è§£å†³ï¼‰

| åºå· | é—®é¢˜ | è¡ŒåŠ¨é¡¹ | è´£ä»»æ–¹ |
|------|------|--------|--------|
| 1 | **viewContractAddrVar å…¬å¼€æ–¹æ³•ç¼ºå¤±** âœ… | åœ¨ VaultCore ä¸­æ·»åŠ  viewContractAddrVar() getter | æ ¸å¿ƒå¼€å‘ |
| 2 | **å€Ÿè´·æµç¨‹æ§åˆ¶æµæ–­è£‚** âœ… | ä¿®æ”¹ VaultCore ç›´æ¥è°ƒç”¨ LendingEngineï¼Œä¿®å¤é˜»æ–­æ€§ Bug | æ ¸å¿ƒå¼€å‘ |
| 3 | **å¥–åŠ±æ¨¡å—è§¦å‘ç¼ºå¤±** âœ… | åœ¨ LendingEngine ä¸­æ¢å¤ RewardManager è°ƒç”¨ | æ ¸å¿ƒå¼€å‘ |
| 4 | **æ›´æ–°æ–‡æ¡£ä¸­çš„ä»£ç ç¤ºä¾‹** âœ… | ç¡®ä¿ Architecture-Guide.md ä¸å®é™…å®ç°ä¸€è‡´ | æ–‡æ¡£ç»´æŠ¤ |
| 5 | **ç¼“å­˜æ•°æ®ä¸€è‡´æ€§éªŒè¯æœºåˆ¶** âœ… | æ·»åŠ ç¼“å­˜æœ‰æ•ˆæ€§æ£€æŸ¥å’Œå›é€€åˆ°è´¦æœ¬ | æ ¸å¿ƒå¼€å‘ |
| 6 | **æ‹†åˆ† VaultLendingEngine** âœ…ï¼ˆéƒ¨åˆ†ï¼‰ | æ§åˆ¶å•ä¸ªåˆçº¦å¤æ‚åº¦è‡³ 500 è¡Œä»¥å†… | æ ¸å¿ƒå¼€å‘ |
| 7 | **åŠ å¼ºåŒå…¥å£ä¸€è‡´æ€§** âœ… | ç¡®ä¿æ‰€æœ‰å…¥å£è·¯å¾„éƒ½æ­£ç¡®æ›´æ–°ç¼“å­˜å’Œäº‹ä»¶ | æ ¸å¿ƒå¼€å‘ |
| 8 | **æ¨é€å¤±è´¥å¤„ç†** âœ… | è®°å½•å¤±è´¥äº‹ä»¶ï¼Œæä¾›ä¿®å¤æœºåˆ¶ | æ ¸å¿ƒå¼€å‘ |
| 9 | **æƒé™å®‰å…¨åŠ å›º** âœ… | ä¸¥æ ¼éªŒè¯æ¨é€æƒé™ | å®‰å…¨å®¡è®¡ |
| 10 | **æ·»åŠ æ¸…ç®—ç«¯åˆ°ç«¯æµ‹è¯•** âœ… | è¦†ç›–æ‰€æœ‰å¤±è´¥åœºæ™¯ | QA å›¢é˜Ÿ |

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼ˆå»ºè®®è§£å†³ï¼‰

| åºå· | é—®é¢˜ | è¡ŒåŠ¨é¡¹ | è´£ä»»æ–¹ |
|------|------|--------|--------|
| 10 | **ä¿®æ­£å‘½åè§„èŒƒ** | ç§æœ‰å˜é‡å»æ‰ `Var` åç¼€ | æ ¸å¿ƒå¼€å‘ |
| 11 | **é‡å‘½å VaultRouter** âœ… | æ”¹ä¸º `VaultRouter` æˆ– `VaultCoordinator` | æ ¸å¿ƒå¼€å‘ |
| 12 | **å®Œå–„å­˜å‚¨è¿ç§»æ–‡æ¡£** âœ… | æä¾›å…·ä½“å®ç°æŒ‡å—å’Œæ¨¡æ¿ | æ–‡æ¡£ç»´æŠ¤ |
| 13 | **å¹¶å‘æ›´æ–°å¤„ç†** âœ… | ä½¿ç”¨å¢é‡æ›´æ–°æˆ–ç»Ÿä¸€å…¥å£ | æ ¸å¿ƒå¼€å‘ |
| 14 | **å­˜å‚¨æˆæœ¬ä¼˜åŒ–** | é€‰æ‹©æ€§ç¼“å­˜ï¼Œå®šæœŸæ¸…ç† | æ ¸å¿ƒå¼€å‘ |
| 15 | **å‡çº§å…¼å®¹æ€§** âœ… | `__gap` + `apiVersion/schemaVersion/getVersionInfo`ï¼ˆå…³é”®æ¨¡å—å¯ç”¨ V2 äº‹ä»¶/æ—§å…¥å£å…¼å®¹ï¼‰ | æ ¸å¿ƒå¼€å‘ |
| 16 | **éªŒè¯ Reward æ¨¡å—å…¥å£** âœ… | ç¡®ä¿æ— é—ç•™ç›´æ¥è°ƒç”¨ | QA å›¢é˜Ÿ |
| 17 | **å¥åº·æ¨é€é™é»˜å¤±è´¥ä¼˜åŒ–** | å¢åŠ  HealthPushFailed äº‹ä»¶ | æ ¸å¿ƒå¼€å‘ |

### ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰

| åºå· | é—®é¢˜ | è¡ŒåŠ¨é¡¹ | è´£ä»»æ–¹ |
|------|------|--------|--------|
| 18 | **åŠ¨æ€è¿‡æœŸç­–ç•¥** | æ ¹æ®ç”¨æˆ·æ´»è·ƒåº¦è°ƒæ•´ | æ ¸å¿ƒå¼€å‘ |
| 19 | **æµ‹è¯•å·¥å…·å®Œå–„** | è‡ªåŠ¨åŒ–ä¸€è‡´æ€§æ£€æŸ¥ | QA å›¢é˜Ÿ |
| 20 | **é‡æ–°æµ‹é‡ Gas æ¶ˆè€—** | ä½¿ç”¨çœŸå®ç¯å¢ƒæ•°æ® | æ ¸å¿ƒå¼€å‘ |
| 21 | **æ·»åŠ å­˜å‚¨å¸ƒå±€éªŒè¯ CI æ­¥éª¤** | é˜²æ­¢å‡çº§ç ´åå­˜å‚¨ | DevOps |

---

## ğŸ“Š ä¸å…¶ä»–æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | æŸ¥è¯¢æˆæœ¬ | æ•°æ®ä¸€è‡´æ€§ | å­˜å‚¨æˆæœ¬ | å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|------|---------|-----------|---------|--------|---------|
| **æ‚¨çš„åŒæ¶æ„** | 0 gas | âš ï¸ éœ€è¦ç»´æŠ¤ | é«˜ | é«˜ | é«˜é¢‘æŸ¥è¯¢åœºæ™¯ |
| **çº¯äº‹ä»¶é©±åŠ¨** | 0 gas | âœ… å¼ºä¸€è‡´æ€§ | ä½ | ä½ | å¤§å¤šæ•°DeFié¡¹ç›® |
| **é“¾ä¸‹ç´¢å¼•** | 0 gas | âœ… å¼ºä¸€è‡´æ€§ | ä½ | ä¸­ | éœ€è¦å¤æ‚æŸ¥è¯¢ |
| **ä¼ ç»Ÿç¼“å­˜** | 0 gas | âš ï¸ éœ€è¦ç»´æŠ¤ | ä¸­ | ä¸­ | ç®€å•åœºæ™¯ |

---

## ğŸ”— å‚è€ƒé¡¹ç›®

1. **Uniswap V3** - äº‹ä»¶é©±åŠ¨ï¼Œé“¾ä¸‹ç´¢å¼•
2. **Aave** - äº‹ä»¶é©±åŠ¨ï¼ŒThe Graphç´¢å¼•
3. **MakerDAO** - é“¾ä¸Šç¼“å­˜ï¼ˆä¸»è¦ç”¨äºä»·æ ¼ï¼‰
4. **Synthetix** - é“¾ä¸Šèšåˆæ•°æ®ç¼“å­˜

---

## ğŸ“‹ é—®é¢˜æ¸…å•æ€»è§ˆ

### æŒ‰é£é™©ç­‰çº§åˆ†ç±»

| é£é™©ç­‰çº§ | é—®é¢˜æ•° | é—®é¢˜åˆ—è¡¨ |
|----------|--------|----------|
| ğŸ”´ **P0 é˜»æ–­æ€§** | 3 | **å€Ÿè´·æµç¨‹æ–­è£‚** âœ…ã€**å¥–åŠ±è§¦å‘ç¼ºå¤±** âœ…ã€**viewContractAddrVarç¼ºå¤±** ğŸ†• |
| ğŸ”´ **é«˜é£é™©** | 8 | ç¼“å­˜ä¸€è‡´æ€§ã€VaultLendingEngineè§„æ¨¡ã€åŒå…¥å£é£é™©ã€Registryå­˜å‚¨æ§½ä½ã€æƒé™å®‰å…¨ã€æ¸…ç®—åŸå­æ€§ã€å¥åº·æ¨é€å¤±è´¥ âœ…ã€ä»“ä½æ¨é€å¯ç”¨æ€§ âœ… |
| ğŸŸ¡ **ä¸­é£é™©** | 7 | æ¨é€å¤±è´¥å¤„ç†ã€å¹¶å‘æ›´æ–°ã€å‡çº§å…¼å®¹æ€§ã€VaultRouterå‘½åã€æ¸…ç®—å¤æ‚æ€§ã€Rewardå…¥å£éªŒè¯ã€å­˜å‚¨æˆæœ¬ |
| ğŸŸ¢ **ä½é£é™©** | 5 | å‘½åè§„èŒƒã€ç¼“å­˜è¿‡æœŸç­–ç•¥ã€Gasä¼°ç®—ã€æµ‹è¯•å¤æ‚åº¦ã€æ–‡æ¡£ä»£ç ç¤ºä¾‹ |

> âœ… = å·²é€šè¿‡ä»£ç éªŒè¯ç¡®è®¤å­˜åœ¨ | ğŸ†• = æœ¬æ¬¡æ–°å‘ç°

### æŒ‰é—®é¢˜ç±»å‹åˆ†ç±»

| ç±»å‹ | é—®é¢˜åˆ—è¡¨ |
|------|----------|
| **æ ¸å¿ƒé€»è¾‘ç¼ºé™·** | **å€Ÿè´·æµç¨‹æ–­è£‚** âœ…ã€**å¥–åŠ±è§¦å‘ç¼ºå¤±** âœ…ã€**viewContractAddrVarç¼ºå¤±** ğŸ†• |
| **æ–‡æ¡£ä¸€è‡´æ€§** | VaultCoreä»£ç ç¤ºä¾‹ä¸ä¸€è‡´ã€å‘½åè§„èŒƒä¸ä¸€è‡´ |
| **æ¶æ„è®¾è®¡** | VaultLendingEngineè§„æ¨¡è¿‡å¤§ã€åŒå…¥å£é£é™©ã€VaultRouterå‘½åè¯¯å¯¼ |
| **æ•°æ®ä¸€è‡´æ€§** | ç¼“å­˜ä¸€è‡´æ€§ã€æ¨é€å¤±è´¥å¤„ç†ã€å¹¶å‘æ›´æ–° |
| **å®‰å…¨æ€§** | æƒé™éªŒè¯ã€Registryå­˜å‚¨æ§½ä½ã€æ¸…ç®—åŸå­æ€§ã€å¥åº·æ¨é€é£é™© âœ… |
| **å¯ç»´æŠ¤æ€§** | å‡çº§å…¼å®¹æ€§ã€æµ‹è¯•å¤æ‚åº¦ã€Rewardå…¥å£éªŒè¯ |
| **æˆæœ¬ä¸æ€§èƒ½** | å­˜å‚¨æˆæœ¬ã€Gasä¼°ç®—ã€ç¼“å­˜è¿‡æœŸç­–ç•¥ |

---

## ğŸ“ ç»“è®º

æ‚¨çš„åŒæ¶æ„æ¨¡å¼æ˜¯ä¸€ä¸ª**åˆ›æ–°çš„è®¾è®¡**ï¼Œä½†åœ¨å®æ–½è¿‡ç¨‹ä¸­å‡ºç°äº†**æ ¸å¿ƒé€»è¾‘æ–­è£‚**ï¼ˆP0çº§ç¼ºé™·ï¼‰ï¼Œè¿™æ¯”ä¹‹å‰å‘ç°çš„ç¼“å­˜ä¸€è‡´æ€§é£é™©æ›´ä¸ºç´§æ€¥ã€‚

**ç´§æ€¥è¡ŒåŠ¨è®¡åˆ’**ï¼ˆæŒ‰ä¼˜å…ˆé¡ºåºï¼‰ï¼š
1. **æ·»åŠ  VaultCore.viewContractAddrVar() å…¬å¼€æ–¹æ³•**ï¼ˆé—®é¢˜19ï¼‰ï¼Œå¦åˆ™æ¨¡å—é—´é€šä¿¡å…¨éƒ¨æ–­è£‚ã€‚
2. **ä¿®å¤ VaultCore -> LendingEngine çš„è°ƒç”¨é“¾**ï¼ˆé—®é¢˜15ï¼‰ï¼Œç¡®ä¿å€Ÿè´·åŠŸèƒ½å¯ç”¨ã€‚
3. **æ¢å¤ LendingEngine ä¸­çš„ RewardManager è°ƒç”¨**ï¼ˆé—®é¢˜16ï¼‰ï¼Œç¡®ä¿æ¿€åŠ±ç³»ç»Ÿæ­£å¸¸è¿ä½œã€‚
4. **æ·»åŠ å¥åº·æ¨é€å¤±è´¥äº‹ä»¶**ï¼ˆé—®é¢˜17ï¼‰ï¼Œç¡®ä¿é“¾ä¸‹ç›‘æ§å¯æ„ŸçŸ¥å¼‚å¸¸ã€‚
5. éšåå†ç€æ‰‹å¤„ç†ç¼“å­˜ä¸€è‡´æ€§ã€æ–‡æ¡£ä¿®æ­£å’Œä»£ç è§„èŒƒç­‰é—®é¢˜ã€‚

**åŒæ¶æ„çš„ä»·å€¼ä¾ç„¶å­˜åœ¨**ï¼Œä½†åœ¨ä¿®å¤æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ä¹‹å‰ï¼Œç³»ç»Ÿçš„åŸºæœ¬åŠŸèƒ½æ˜¯ä¸å¯ç”¨çš„ã€‚

---

## ğŸ“ é™„å½•

### ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶ | ç”¨é€” | è¡Œæ•° |
|------|------|------|
| `src/Vault/VaultCore.sol` | æç®€å…¥å£åˆçº¦ | 147 |
| `src/Vault/VaultRouter.sol` | åŒæ¶æ„åè°ƒå™¨ | 649 |
| `src/Vault/modules/CollateralManager.sol` | æŠµæŠ¼ç®¡ç† | 531 |
| `src/Vault/modules/VaultLendingEngine.sol` | å€Ÿè´·å¼•æ“ | 1070 |
| `src/registry/Registry.sol` | æ¨¡å—æ³¨å†Œä¸­å¿ƒ | 585 |
| `docs/Architecture-Guide.md` | æ¶æ„è®¾è®¡æ–‡æ¡£ | 926 |

### ç‰ˆæœ¬å†å²

| æ—¥æœŸ | ç‰ˆæœ¬ | æ›´æ–°å†…å®¹ |
|------|------|----------|
| 2025-12-15 | v2.2 | **äºŒæ¬¡éªŒè¯**ï¼šé€šè¿‡ä»£ç çº§åˆ†æç¡®è®¤P0é—®é¢˜å­˜åœ¨ï¼Œæ–°å¢é—®é¢˜19ï¼ˆviewContractAddrVarç¼ºå¤±ï¼‰ï¼Œå…±å‘ç°3ä¸ªP0çº§é—®é¢˜ |
| 2025-12-15 | v2.1 | **ç´§æ€¥å®¡è®¡**ï¼šå‘ç°å€Ÿè´·æµç¨‹æ–­è£‚å’Œå¥–åŠ±ç¼ºå¤±ç­‰P0çº§é˜»æ–­æ€§ç¼ºé™·ï¼Œæ›´æ–°ä¼˜å…ˆçº§ |
| 2025-12-15 | v2.0 | åŸºäºæœ€æ–°æ¶æ„åˆ†ææŠ¥å‘Šå…¨é¢æ›´æ–°ï¼Œæ–°å¢10ä¸ªé—®é¢˜ç‚¹ |
| - | v1.0 | åˆå§‹ç‰ˆæœ¬ |

---

**æ³¨æ„**ï¼šæœ¬åˆ†æåŸºäºå½“å‰ä»£ç å®ç°ï¼Œå»ºè®®å®šæœŸå®¡æŸ¥å’Œæ›´æ–°ã€‚

---

## ğŸ§© View å±‚ç°çŠ¶æ€»è§ˆï¼ˆPR è¯´æ˜ç”¨ï¼‰

### èŒƒå›´ï¼ˆæœ¬æ¬¡ PR æ¶‰åŠçš„ View æ¨¡å—ï¼‰
- **View è§„èŒƒå¯¹é½/ä¿®å¤**ï¼š
  - `src/Vault/view/modules/AccessControlView.sol`
  - `src/Vault/view/modules/BatchView.sol`
  - `src/Vault/view/modules/CacheOptimizedView.sol`
  - `src/Vault/view/modules/DashboardView.sol`
  - `src/Vault/view/modules/EventHistoryManager.sol`
  - `src/Vault/view/modules/FeeRouterView.sol`
  - `src/Vault/view/modules/HealthView.sol`
  - `src/Vault/view/modules/LendingEngineView.sol`
  - `src/Vault/view/modules/LiquidationRiskView.sol`
  - `src/Vault/view/modules/LiquidatorView.sol`
  - `src/Vault/view/modules/ModuleHealthView.sol`
  - `src/Vault/view/modules/PositionView.sol`
  - `src/Vault/view/modules/PreviewView.sol`
  - `src/Vault/view/modules/RegistryView.sol`
  - `src/Vault/view/modules/RewardView.sol`
  - `src/Vault/view/modules/RiskView.sol`
  - `src/Vault/view/modules/StatisticsView.sol`
  - `src/Vault/view/modules/SystemView.sol`
  - `src/Vault/view/modules/UserView.sol`
  - `src/Vault/view/modules/ValuationOracleView.sol`
  - `src/Vault/view/modules/ViewCache.sol`
- **ç»Ÿä¸€å¸¸é‡/é”™è¯¯ä¸ DataPush**ï¼š
  - `src/constants/DataPushTypes.sol`
  - `src/errors/StandardErrors.sol`ï¼ˆå¤ç”¨ï¼‰

### å½“å‰ View å±‚æ•´ä½“æ¶æ„ï¼ˆä¸ `Architecture-Guide.md` ä¸€è‡´ï¼‰
- **èŒè´£è¾¹ç•Œ**ï¼š
  - View å±‚åªæ‰¿æ‹…è¯»ç¼“å­˜/åªè¯»èšåˆ/äº‹ä»¶ä¸ DataPushï¼Œè´¦æœ¬å†™å…¥ç»Ÿä¸€ç›´è¾¾ä¸šåŠ¡æ¨¡å—ï¼ˆå¦‚ `LendingEngine`/`CollateralManager`ï¼‰ã€‚
  - æ¸…ç®—ç›¸å…³äº‹ä»¶/DataPush éµå¾ªâ€œå•ç‚¹æ¨é€â€ï¼šç”± `LiquidatorView.pushLiquidationUpdate/Batch` è§¦å‘ï¼Œé“¾ä¸‹ç»Ÿä¸€æ¶ˆè´¹ã€‚
- **ç»Ÿä¸€ DataPush**ï¼š
  - æ‰€æœ‰ `push*` å†™è·¯å¾„ç»Ÿä¸€è°ƒç”¨ `DataPushLibrary._emitData(...)`ï¼›
  - `dataTypeHash` ç»Ÿä¸€èµ° `DataPushTypes` å¸¸é‡ï¼ˆ`keccak256("UPPER_SNAKE_CASE")`ï¼‰ï¼Œé¿å…æ•£è½é‡å¤å®šä¹‰ã€‚
- **UUPS å¯å‡çº§åŸºçº¿**ï¼š
  - View æ¨¡å—ç»Ÿä¸€è¡¥é½ `constructor { _disableInitializers(); }` é˜²æ­¢å®ç°åˆçº¦è¢«è¯¯åˆå§‹åŒ–ï¼›
  - ç»Ÿä¸€ä¿ç•™ `uint256[50] __gap;`ï¼Œé™ä½æœªæ¥å‡çº§æ’å…¥å˜é‡çš„å¸ƒå±€é£é™©ï¼›
  - `_authorizeUpgrade` ç»Ÿä¸€åšæƒé™æ ¡éªŒä¸é›¶åœ°å€æ ¡éªŒï¼ˆæœ€å°ç ´åå¼ä¿®å¤ï¼‰ã€‚
- **æ‰¹é‡é™åˆ¶ä¸ç¨³å®šæ€§**ï¼š
  - æ‰¹é‡æ¥å£ç»Ÿä¸€ä½¿ç”¨ `ViewConstants.MAX_BATCH_SIZE` åšé•¿åº¦ä¸Šé™ä¿æŠ¤ï¼›
  - æ¨é€å¤±è´¥/é“¾ä¸‹é‡è¯•ï¼š`PositionView` ä¿ç•™å¹¶ä½¿ç”¨ `CacheUpdateFailed(...)` äº‹ä»¶æºå¸¦ payload ä¾›é“¾ä¸‹å‘Šè­¦ä¸äººå·¥é‡æ”¾ã€‚

### æœ¬æ¬¡ PR çš„å…³é”®ä¿®å¤ç‚¹ï¼ˆé«˜ä¿¡å·æ‘˜è¦ï¼‰
- **RiskView å¥åº·å› å­å£å¾„ä¿®æ­£**ï¼šå°†é£é™©é˜ˆå€¼åˆ¤æ–­ä» WAD é£æ ¼ï¼ˆ`1e18`ï¼‰ä¿®æ­£ä¸º **bps å£å¾„**ï¼ˆ`10_000 = 100%`ï¼‰ï¼Œé¿å…å‰ç«¯/æœºå™¨äººè¯¯åˆ¤å¯æ¸…ç®—/é¢„è­¦ã€‚
- **ç»Ÿä¸€ DataPushTypes æ‰©å±•**ï¼šè¡¥é½ `USER_VIEW_INITIALIZED`ã€`DEGRADATION_STATS_UPDATE` ç­‰å¸¸é‡ï¼Œå¹¶æ›¿æ¢æ•£è½çš„ `keccak256("...")` ç›´æ¥è®¡ç®—ï¼Œä¾¿äºé“¾ä¸‹ç»Ÿä¸€è®¢é˜…ä¸è§£æã€‚
- **View å±‚ UUPS åŸºçº¿å¯¹é½**ï¼šåœ¨å¤šå¤„ View åˆçº¦è¡¥é½ `_disableInitializers`/`__gap`/å‡çº§æˆæƒä¸€è‡´æ€§ï¼Œæå‡å¯å‡çº§å®‰å…¨æ€§ä¸å¯ç»´æŠ¤æ€§ã€‚
- **FeeRouterView DataPush è¦†ç›–è¡¥å…¨**ï¼šä¸ºé—æ¼çš„ `push*` è¡¥é½ `DataPushLibrary._emitData(...)`ï¼Œä½¿â€œæ‰€æœ‰ push* ç»Ÿä¸€ DataPushâ€è½åœ°ã€‚
- **æ–‡æ¡£ä¸€è‡´æ€§è¡¥å……**ï¼šåœ¨ `Architecture-Guide.md` å¢åŠ  View å±‚æ•´ä½“ä¸€è‡´æ€§æè¿°ï¼Œå¹¶è¡¥å……â€œè¯»æƒé™å¯é€‰å¢å¼ºï¼ˆæš‚ä¸å®æ–½ï¼‰â€è¯´æ˜ã€‚

### æ„å»º/éªŒè¯
- **`npx hardhat compile`**ï¼šé€šè¿‡ï¼ˆä»æœ‰ `CollateralManager.sol` çš„æœªä½¿ç”¨å˜é‡ warningï¼Œå±äºå­˜é‡é—®é¢˜ï¼Œä¸å½±å“æœ¬æ¬¡ View å¯¹é½ï¼‰ã€‚

### åç»­å»ºè®®ï¼ˆä¸é˜»å¡æœ¬æ¬¡ PRï¼‰
- **æ¸…ç†å†å²é—ç•™ warning**ï¼šä¾‹å¦‚ `CollateralManager.sol` çš„ unused local variableï¼Œå¯åœ¨å•ç‹¬ PR é‡Œæ¸…ç†ä»¥ä¿æŒ CI æ›´å¹²å‡€ã€‚
- **è¿›ä¸€æ­¥æ”¶æ•› DataPushTypes**ï¼šå¯¹ä»åœ¨æ¨¡å—å†…ç›´æ¥ `keccak256("...")` çš„ dataTypeHashï¼Œé€æ­¥è¿ç§»åˆ° `DataPushTypes`ã€‚
