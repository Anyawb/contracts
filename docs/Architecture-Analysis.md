# åŒæ¶æ„æ¨¡å¼åˆ†æä¸æ½œåœ¨é—®é¢˜æŠ¥å‘Š

> **æœ€åæ›´æ–°**: 2025-12-15  
> **åˆ†æèŒƒå›´**: Architecture-Guide.md + å®é™…ä»£ç å®ç°

## ğŸ“‹ æ¶æ„æ¦‚è¿°

æ‚¨çš„é¡¹ç›®é‡‡ç”¨äº†ä¸€ç§ç‹¬ç‰¹çš„**åŒæ¶æ„è®¾è®¡**æ¨¡å¼ï¼Œç»“åˆäº†ï¼š
1. **äº‹ä»¶é©±åŠ¨æ¶æ„** - æ‰€æœ‰æ“ä½œé€šè¿‡äº‹ä»¶è®°å½•ï¼Œæ”¯æŒæ•°æ®åº“æ”¶é›†å’ŒAIåˆ†æ
2. **Viewå±‚ç¼“å­˜æ¶æ„** - æä¾›å¿«é€Ÿå…è´¹æŸ¥è¯¢ï¼Œæ‰€æœ‰æŸ¥è¯¢å‡½æ•°ä½¿ç”¨viewï¼ˆ0 gasï¼‰

### æ¶æ„æµç¨‹
```
ç”¨æˆ·æ“ä½œ â†’ VaultCore â†’ VaultView â†’ ä¸šåŠ¡æ¨¡å— â†’ è´¦æœ¬æ›´æ–°
                              â†“
                        æ•°æ®æ¨é€æ¥å£
                              â†“
                    Viewå±‚ç¼“å­˜ + äº‹ä»¶å‘å‡º
                              â†“
                    æ•°æ®åº“æ”¶é›† + å…è´¹æŸ¥è¯¢
```

---

##  æ¶æ„è´¨é‡è¯„ä¼°

| è¯„ä¼°é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| **è®¾è®¡å®Œæ•´æ€§** | âŒ ä¸¥é‡ç¼ºå¤± | æ ¸å¿ƒå€Ÿè´·æµç¨‹ï¼ˆBorrow/Repayï¼‰æ§åˆ¶æµæ–­è£‚ï¼Œæ— æ³•æ‰§è¡Œ |
| **æ¨¡å—åŒ–ç¨‹åº¦** | âœ… è‰¯å¥½ | æ¨¡å—æ‹†åˆ†åˆç†ï¼ŒèŒè´£æ¸…æ™° |
| **å®‰å…¨æ€§** | âš ï¸ éœ€è¦å…³æ³¨ | åŒå…¥å£é£é™©ã€ç¼“å­˜ä¸€è‡´æ€§éœ€è¦é‡ç‚¹æµ‹è¯• |
| **å¯ç»´æŠ¤æ€§** | âš ï¸ å¾…æ”¹è¿› | VaultLendingEngine è¿‡å¤§ï¼Œéœ€è¦æ‹†åˆ† |
| **æ–‡æ¡£å‡†ç¡®æ€§** | âŒ éœ€æ›´æ–° | ä»£ç ç¤ºä¾‹ä¸å®ç°ä¸ä¸€è‡´ï¼Œä¸”éƒ¨åˆ†å£°æ˜ï¼ˆå¦‚å¥–åŠ±é›†æˆï¼‰ä¸ä»£ç å®Œå…¨è„±èŠ‚ |
| **æµ‹è¯•è¦†ç›–** | ğŸ”„ å¾…éªŒè¯ | éœ€è¦éªŒè¯ç«¯åˆ°ç«¯æµ‹è¯•è¦†ç›– |

## ğŸ” ç±»ä¼¼é¡¹ç›®è°ƒç ”

### 1. äº‹ä»¶é©±åŠ¨æ¶æ„åœ¨DeFiä¸­çš„ä½¿ç”¨

**å¸¸è§æ¨¡å¼**ï¼š
- âœ… **Uniswap V3** - ä½¿ç”¨äº‹ä»¶è®°å½•æ‰€æœ‰äº¤æ˜“å’ŒæµåŠ¨æ€§å˜åŒ–
- âœ… **Aave** - äº‹ä»¶é©±åŠ¨çš„å‰ç«¯æ›´æ–°æœºåˆ¶
- âœ… **Compound** - äº‹ä»¶è®°å½•å€Ÿè´·å’Œæ¸…ç®—æ“ä½œ
- âœ… **The Graph** - ä¸“é—¨ç´¢å¼•åŒºå—é“¾äº‹ä»¶çš„æœåŠ¡

**ç‰¹ç‚¹**ï¼šå¤§å¤šæ•°DeFié¡¹ç›®éƒ½ä½¿ç”¨äº‹ä»¶é©±åŠ¨ï¼Œä½†é€šå¸¸**ä¸åœ¨é“¾ä¸Šç»´æŠ¤ç¼“å­˜**ï¼Œè€Œæ˜¯ä¾èµ–é“¾ä¸‹ç´¢å¼•æœåŠ¡ï¼ˆå¦‚The Graphï¼‰æ¥æä¾›æŸ¥è¯¢èƒ½åŠ›ã€‚

### 2. Viewå±‚ç¼“å­˜æ¨¡å¼

**å¸¸è§æ¨¡å¼**ï¼š
- âœ… **MakerDAO** - ä½¿ç”¨é“¾ä¸Šç¼“å­˜ä¼˜åŒ–æŸ¥è¯¢ï¼ˆä½†ä¸»è¦ç”¨äºä»·æ ¼æ•°æ®ï¼‰
- âœ… **Synthetix** - ä½¿ç”¨é“¾ä¸Šç¼“å­˜å­˜å‚¨èšåˆæ•°æ®
- âš ï¸ **è¾ƒå°‘é¡¹ç›®åœ¨é“¾ä¸Šç»´æŠ¤å®Œæ•´çš„ç”¨æˆ·çŠ¶æ€ç¼“å­˜**

**ç‰¹ç‚¹**ï¼šå¤§å¤šæ•°é¡¹ç›®é€‰æ‹©é“¾ä¸‹ç¼“å­˜ï¼ˆæ•°æ®åº“ï¼‰ï¼Œè€Œä¸æ˜¯é“¾ä¸Šç¼“å­˜ï¼Œå› ä¸ºï¼š
- é“¾ä¸Šå­˜å‚¨æˆæœ¬é«˜
- é“¾ä¸‹ç¼“å­˜æ›´çµæ´»
- é“¾ä¸‹å¯ä»¥å¤„ç†å¤æ‚æŸ¥è¯¢

### 3. åŒæ¶æ„ç»“åˆæ¨¡å¼

**è°ƒç ”ç»“æœ**ï¼š
- âŒ **æœªå‘ç°å…¶ä»–é¡¹ç›®æ˜ç¡®é‡‡ç”¨"äº‹ä»¶é©±åŠ¨ + Viewå±‚ç¼“å­˜"çš„åŒæ¶æ„æ¨¡å¼**
- âš ï¸ **æ‚¨çš„é¡¹ç›®å¯èƒ½æ˜¯é¦–åˆ›æˆ–å°‘æ•°é‡‡ç”¨æ­¤æ¨¡å¼çš„é¡¹ç›®ä¹‹ä¸€**

**åŸå› åˆ†æ**ï¼š
1. **æˆæœ¬è€ƒè™‘**ï¼šé“¾ä¸Šç¼“å­˜éœ€è¦é¢å¤–çš„å­˜å‚¨æˆæœ¬
2. **å¤æ‚æ€§**ï¼šéœ€è¦ç»´æŠ¤ä¸¤å¥—æ•°æ®ï¼ˆè´¦æœ¬ + ç¼“å­˜ï¼‰çš„ä¸€è‡´æ€§
3. **ä¼ ç»Ÿæ–¹æ¡ˆ**ï¼šå¤§å¤šæ•°é¡¹ç›®ä½¿ç”¨é“¾ä¸‹ç´¢å¼•æœåŠ¡ï¼ˆThe Graphç­‰ï¼‰

---

## ğŸ”´ æ–‡æ¡£ä¸ä»£ç ä¸€è‡´æ€§é—®é¢˜

### 1. VaultCore ä»£ç ç¤ºä¾‹ä¸å®é™…ä¸ä¸€è‡´ âš ï¸ **éœ€æ›´æ–°**

#### é—®é¢˜æè¿°
Architecture-Guide.md æ–‡æ¡£ä¸­çš„ä»£ç ç¤ºä¾‹ä½¿ç”¨**å­—ç¬¦ä¸²ç±»å‹**æ“ä½œæ ‡è¯†ç¬¦ï¼Œè€Œå®é™…ä»£ç ä½¿ç”¨ **bytes32 å¸¸é‡**ã€‚

#### æ–‡æ¡£æè¿°ï¼ˆç¬¬67-110è¡Œï¼‰ï¼š
```solidity
// æ–‡æ¡£ä¸­æ˜¾ç¤ºï¼šä½¿ç”¨ "DEPOSIT"ã€"BORROW" å­—ç¬¦ä¸²ç±»å‹
function deposit(address asset, uint256 amount) external {
    IVaultView(viewContractAddrVar).processUserOperation(msg.sender, "DEPOSIT", asset, amount, block.timestamp);
}
```

#### å®é™…ä»£ç ï¼ˆVaultCore.solï¼‰ï¼š
```solidity
// å®é™…ä½¿ç”¨ ActionKeys.ACTION_DEPOSIT (bytes32 ç±»å‹)
function deposit(address asset, uint256 amount) external {
    IVaultView(_viewContractAddr).processUserOperation(msg.sender, ActionKeys.ACTION_DEPOSIT, asset, amount, block.timestamp);
}
```

#### å½±å“
- âŒ å¼€å‘è€…å¯èƒ½æŒ‰ç…§æ–‡æ¡£ç¼–å†™é”™è¯¯ä»£ç 
- âŒ é›†æˆæµ‹è¯•å¯èƒ½åŸºäºé”™è¯¯å‡è®¾

#### è§£å†³æ–¹æ¡ˆ
æ›´æ–° Architecture-Guide.md ä¸­çš„ä»£ç ç¤ºä¾‹ä»¥åæ˜ å®é™…å®ç°ã€‚

### 2. å‘½åè§„èŒƒä¸ä¸€è‡´ âš ï¸ **éœ€ä¿®æ­£**

#### é—®é¢˜æè¿°
æ–‡æ¡£è§„èŒƒï¼ˆç¬¬648-653è¡Œï¼‰è§„å®šï¼š
- ç§æœ‰å˜é‡ä½¿ç”¨ `_camelCase` æ ¼å¼
- å…¬å…±å˜é‡ä½¿ç”¨ `camelCaseVar` æ ¼å¼

#### å®é™…ä»£ç é—®é¢˜ï¼š
- `VaultCore.sol` ä¸­ä½¿ç”¨ `_registryAddrVar` ä½œä¸º**ç§æœ‰å˜é‡**åç§°ï¼Œä½†æŒ‰ç…§è§„èŒƒåº”è¯¥æ˜¯ `_registryAddr`
- `VaultView.sol` ä¸­ `_registryAddrVar` åŒæ ·æ˜¯ç§æœ‰å˜é‡ï¼Œå‘½åå¸¦æœ‰ `Var` åç¼€ä¸ç¬¦åˆè§„èŒƒ

#### å½±å“
- âš ï¸ ä»£ç é£æ ¼ä¸ç»Ÿä¸€
- âš ï¸ æ–°å¼€å‘è€…å¯èƒ½äº§ç”Ÿå›°æƒ‘

---

## âš ï¸ æ½œåœ¨é—®é¢˜åˆ†æ

### 1. ç¼“å­˜æ•°æ®ä¸€è‡´æ€§é—®é¢˜ âš ï¸ **é«˜é£é™©**

#### é—®é¢˜æè¿°
- Viewå±‚ç¼“å­˜ä¸è´¦æœ¬æ•°æ®å¯èƒ½ä¸åŒæ­¥
- å¦‚æœä¸šåŠ¡æ¨¡å—æ¨é€å¤±è´¥ï¼Œç¼“å­˜ä¼šè¿‡æ—¶
- ç¼“å­˜è¿‡æœŸæœºåˆ¶ï¼ˆ5åˆ†é’Ÿï¼‰å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´

#### å…·ä½“åœºæ™¯
```solidity
// åœºæ™¯1ï¼šæ¨é€å¤±è´¥
LendingEngine.borrow() {
    // è´¦æœ¬æ›´æ–°æˆåŠŸ
    _userDebt[user][asset] += amount;
    
    // æ¨é€å¤±è´¥ï¼ˆgasä¸è¶³ã€revertç­‰ï¼‰
    try IVaultView(viewAddr).pushUserPositionUpdate(...) { } 
    catch { }  // é™é»˜å¤±è´¥ï¼Œç¼“å­˜æœªæ›´æ–°
}

// åœºæ™¯2ï¼šç¼“å­˜è¿‡æœŸ
// ç”¨æˆ·æŸ¥è¯¢æ—¶ï¼Œç¼“å­˜å·²è¿‡æœŸï¼ˆ5åˆ†é’Ÿï¼‰ï¼Œä½†ä¸šåŠ¡é€»è¾‘å¯èƒ½å·²æ›´æ–°
function getUserPosition() {
    if (block.timestamp - _cacheTimestamps[user] > CACHE_DURATION) {
        // ç¼“å­˜è¿‡æœŸï¼Œä½†å¯èƒ½è¿”å›æ—§æ•°æ®
        return (_userCollateral[user][asset], _userDebt[user][asset]);
    }
}
```

#### å½±å“
- âŒ ç”¨æˆ·æŸ¥è¯¢åˆ°è¿‡æ—¶æ•°æ®
- âŒ å‰ç«¯æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
- âŒ å¯èƒ½å¯¼è‡´ç”¨æˆ·åšå‡ºé”™è¯¯å†³ç­–

#### è§£å†³æ–¹æ¡ˆå»ºè®®
1. **æ·»åŠ ç¼“å­˜éªŒè¯æœºåˆ¶**ï¼š
   ```solidity
   function getUserPosition(address user, address asset) external view 
       returns (uint256 collateral, uint256 debt, bool isValid) {
       bool cacheValid = (block.timestamp - _cacheTimestamps[user]) < CACHE_DURATION;
       if (!cacheValid) {
           // ä»è´¦æœ¬è¯»å–çœŸå®æ•°æ®
           collateral = ICollateralManager(_cachedCollateralManager).getCollateral(user, asset);
           debt = ILendingEngine(_cachedLendingEngine).getDebt(user, asset);
           return (collateral, debt, false);
       }
       return (_userCollateral[user][asset], _userDebt[user][asset], true);
   }
   ```

2. **å¼ºåˆ¶æ¨é€æœºåˆ¶**ï¼š
   ```solidity
   // ä¸šåŠ¡æ¨¡å—å¿…é¡»æ¨é€ï¼Œå¤±è´¥åˆ™revert
   function borrow(...) external {
       _processBorrow(...);
       // å¿…é¡»æˆåŠŸï¼Œå¦åˆ™æ•´ä¸ªäº¤æ˜“å¤±è´¥
       IVaultView(viewAddr).pushUserPositionUpdate(...);
   }
   ```

3. **å®šæœŸåŒæ­¥æœºåˆ¶**ï¼š
   - æ·»åŠ ç®¡ç†å‘˜å‡½æ•°ï¼Œå®šæœŸä»è´¦æœ¬åŒæ­¥æ•°æ®åˆ°ç¼“å­˜
   - æˆ–ä½¿ç”¨é“¾ä¸‹æœåŠ¡ç›‘æ§å¹¶ä¿®å¤ä¸ä¸€è‡´

### 2. æ¨é€å¤±è´¥å¤„ç†é—®é¢˜ âš ï¸ **ä¸­é£é™©**

#### é—®é¢˜æè¿°
å½“å‰ä»£ç ä¸­ï¼Œæ¨é€å¤±è´¥æ—¶ä½¿ç”¨ `try-catch` é™é»˜å¤„ç†ï¼š

```solidity
// src/Vault/liquidation/modules/LiquidationDebtManager.sol:162
try IVaultView(viewAddr).pushUserPositionUpdate(user, asset, collateral, debt) { } 
catch { }
```

#### å½±å“
- âŒ è´¦æœ¬æ›´æ–°æˆåŠŸï¼Œä½†ç¼“å­˜æœªæ›´æ–°
- âŒ æ•°æ®ä¸ä¸€è‡´ï¼Œä½†ç”¨æˆ·ä¸çŸ¥é“
- âŒ éš¾ä»¥è¿½è¸ªå’Œä¿®å¤

#### è§£å†³æ–¹æ¡ˆå»ºè®®
1. **è®°å½•æ¨é€å¤±è´¥äº‹ä»¶**ï¼š
   ```solidity
   event CacheUpdateFailed(address indexed user, address indexed asset, bytes reason);
   
   try IVaultView(viewAddr).pushUserPositionUpdate(...) { } 
   catch (bytes memory reason) {
       emit CacheUpdateFailed(user, asset, reason);
       // å¯ä»¥é€‰æ‹©revertæˆ–ç»§ç»­
   }
   ```

2. **é‡è¯•æœºåˆ¶**ï¼š
   - é“¾ä¸‹æœåŠ¡ç›‘å¬å¤±è´¥äº‹ä»¶
   - è‡ªåŠ¨é‡è¯•æ¨é€æ›´æ–°

### 3. å¹¶å‘æ›´æ–°é—®é¢˜ âš ï¸ **ä¸­é£é™©**

#### é—®é¢˜æè¿°
å¤šä¸ªä¸šåŠ¡æ¨¡å—å¯èƒ½åŒæ—¶æ¨é€åŒä¸€ç”¨æˆ·çš„æ•°æ®æ›´æ–°ï¼š

```solidity
// åœºæ™¯ï¼šç”¨æˆ·åŒæ—¶è¿›è¡Œå­˜æ¬¾å’Œå€Ÿæ¬¾
CollateralManager.deposit() {
    IVaultView.pushUserPositionUpdate(user, asset, newCollateral, oldDebt);
}

LendingEngine.borrow() {
    IVaultView.pushUserPositionUpdate(user, asset, oldCollateral, newDebt);
}
```

#### å½±å“
- âš ï¸ åæ‰§è¡Œçš„æ¨é€å¯èƒ½è¦†ç›–å…ˆæ‰§è¡Œçš„æ¨é€
- âš ï¸ å¯¼è‡´éƒ¨åˆ†æ•°æ®ä¸¢å¤±

#### è§£å†³æ–¹æ¡ˆå»ºè®®
1. **ä½¿ç”¨å¢é‡æ›´æ–°**ï¼š
   ```solidity
   function pushUserPositionUpdateDelta(
       address user,
       address asset,
       int256 collateralDelta,  // å¯ä»¥æ˜¯è´Ÿæ•°
       int256 debtDelta
   ) external {
       _userCollateral[user][asset] = uint256(int256(_userCollateral[user][asset]) + collateralDelta);
       _userDebt[user][asset] = uint256(int256(_userDebt[user][asset]) + debtDelta);
   }
   ```

2. **ä½¿ç”¨é”æœºåˆ¶**ï¼ˆä½†ä¼šå¢åŠ gasæˆæœ¬ï¼‰

3. **ç»Ÿä¸€æ¨é€å…¥å£**ï¼š
   - æ‰€æœ‰æ›´æ–°é€šè¿‡å•ä¸€å…¥å£ï¼ˆå¦‚VaultViewï¼‰ç»Ÿä¸€å¤„ç†
   - é¿å…å¤šä¸ªæ¨¡å—ç›´æ¥æ¨é€

### 4. å­˜å‚¨æˆæœ¬é—®é¢˜ âš ï¸ **ä¸­é£é™©**

#### é—®é¢˜æè¿°
Viewå±‚ç¼“å­˜éœ€è¦å­˜å‚¨å¤§é‡æ•°æ®ï¼š
- æ¯ä¸ªç”¨æˆ·çš„æ¯ä¸ªèµ„äº§çš„æŠµæŠ¼å’Œå€ºåŠ¡
- ç¼“å­˜æ—¶é—´æˆ³
- ç»Ÿè®¡ä¿¡æ¯

#### æˆæœ¬ä¼°ç®—
å‡è®¾æœ‰1000ä¸ªç”¨æˆ·ï¼Œæ¯ä¸ªç”¨æˆ·å¹³å‡3ç§èµ„äº§ï¼š
- å­˜å‚¨æˆæœ¬ï¼š1000 Ã— 3 Ã— (32 + 32 + 32) = 288,000 bytes â‰ˆ 288 KB
- æ¯æ¬¡æ›´æ–°ï¼š~20,000 gas
- åˆå§‹åŒ–å­˜å‚¨ï¼š~20,000 gas per user

#### å½±å“
- âš ï¸ éƒ¨ç½²æˆæœ¬é«˜
- âš ï¸ æ›´æ–°æˆæœ¬å¢åŠ 
- âš ï¸ å¯èƒ½è¾¾åˆ°åˆçº¦å¤§å°é™åˆ¶

#### è§£å†³æ–¹æ¡ˆå»ºè®®
1. **é€‰æ‹©æ€§ç¼“å­˜**ï¼š
   - åªç¼“å­˜æ´»è·ƒç”¨æˆ·ï¼ˆæœ€è¿‘æœ‰æ“ä½œçš„ç”¨æˆ·ï¼‰
   - å®šæœŸæ¸…ç†ä¸æ´»è·ƒç”¨æˆ·çš„ç¼“å­˜

2. **å‹ç¼©å­˜å‚¨**ï¼š
   - ä½¿ç”¨æ›´ç´§å‡‘çš„æ•°æ®ç»“æ„
   - åˆå¹¶å¤šä¸ªå­—æ®µåˆ°ä¸€ä¸ªslot

3. **é“¾ä¸‹ç¼“å­˜**ï¼š
   - è€ƒè™‘å°†éƒ¨åˆ†ç¼“å­˜ç§»åˆ°é“¾ä¸‹
   - é“¾ä¸Šåªä¿ç•™å…³é”®æ•°æ®

### 5. ç¼“å­˜è¿‡æœŸç­–ç•¥é—®é¢˜ âš ï¸ **ä½é£é™©**

#### é—®é¢˜æè¿°
å½“å‰ç¼“å­˜è¿‡æœŸæ—¶é—´ä¸º5åˆ†é’Ÿï¼ˆ300ç§’ï¼‰ï¼š

```solidity
uint256 private constant CACHE_DURATION = 300; // 5åˆ†é’Ÿ
```

#### é—®é¢˜
- âš ï¸ å›ºå®šè¿‡æœŸæ—¶é—´å¯èƒ½ä¸é€‚åˆæ‰€æœ‰åœºæ™¯
- âš ï¸ é«˜é¢‘ç”¨æˆ·å¯èƒ½é¢‘ç¹è§¦å‘ç¼“å­˜æ›´æ–°
- âš ï¸ ä½é¢‘ç”¨æˆ·å¯èƒ½æ€»æ˜¯æŸ¥è¯¢åˆ°è¿‡æœŸæ•°æ®

#### è§£å†³æ–¹æ¡ˆå»ºè®®
1. **åŠ¨æ€è¿‡æœŸæ—¶é—´**ï¼š
   ```solidity
   mapping(address => uint256) private _cacheDurations; // æŒ‰ç”¨æˆ·è®¾ç½®
   ```

2. **åŸºäºæ“ä½œçš„è¿‡æœŸ**ï¼š
   - æ¯æ¬¡æ“ä½œåé‡ç½®è¿‡æœŸæ—¶é—´
   - è€Œä¸æ˜¯å›ºå®šæ—¶é—´çª—å£

### 6. å‡çº§å…¼å®¹æ€§é—®é¢˜ âš ï¸ **ä¸­é£é™©**

#### é—®é¢˜æè¿°
Viewå±‚ç¼“å­˜çš„æ•°æ®ç»“æ„åœ¨å‡çº§æ—¶éœ€è¦ä¿æŒå…¼å®¹ï¼š

```solidity
// å½“å‰ç‰ˆæœ¬
mapping(address => mapping(address => uint256)) private _userCollateral;

// å‡çº§åå¦‚æœéœ€è¦æ·»åŠ æ–°å­—æ®µ
mapping(address => mapping(address => uint256)) private _userCollateral;
mapping(address => mapping(address => uint256)) private _userCollateralV2; // æ–°å­—æ®µ
```

#### å½±å“
- âš ï¸ å‡çº§æ—¶éœ€è¦æ•°æ®è¿ç§»
- âš ï¸ å¯èƒ½ä¸¢å¤±å†å²ç¼“å­˜æ•°æ®
- âš ï¸ éœ€è¦å¤æ‚çš„è¿ç§»é€»è¾‘

#### è§£å†³æ–¹æ¡ˆå»ºè®®
1. **é¢„ç•™å­˜å‚¨æ§½**ï¼š
   ```solidity
   uint256[50] private __gap; // é¢„ç•™å‡çº§ç©ºé—´
   ```

2. **ç‰ˆæœ¬åŒ–æ•°æ®ç»“æ„**ï¼š
   ```solidity
   struct CacheDataV1 {
       uint256 collateral;
       uint256 debt;
   }
   
   struct CacheDataV2 {
       uint256 collateral;
       uint256 debt;
       uint256 timestamp; // æ–°å­—æ®µ
   }
   ```

### 7. VaultLendingEngine è§„æ¨¡è¿‡å¤§ âš ï¸ **é«˜é£é™©**

#### é—®é¢˜æè¿°
æ–‡æ¡£å¼ºè°ƒæ¨¡å—åº”è¯¥"çº¯ä¸šåŠ¡é€»è¾‘"ä¸”ç®€åŒ–ï¼Œä½†å®é™…ä»£ç ä¸­ï¼š
- `VaultLendingEngine.sol` æœ‰ **1070è¡Œ**
- ç›¸æ¯” `CollateralManager.sol` (531è¡Œ) è¿‡äºåºå¤§
- è¿èƒŒäº†æ–‡æ¡£ä¸­"æç®€åŒ–"çš„è®¾è®¡åŸåˆ™

#### æ½œåœ¨é£é™©
- âŒ åˆçº¦å­—èŠ‚ç å¯èƒ½è¶…è¿‡ 24KB é™åˆ¶
- âŒ å‡çº§å’Œç»´æŠ¤å›°éš¾
- âŒ æµ‹è¯•è¦†ç›–éš¾åº¦å¢åŠ 
- âŒ ä»£ç å®¡è®¡æˆæœ¬é«˜

#### è§£å†³æ–¹æ¡ˆå»ºè®®
è€ƒè™‘å°† VaultLendingEngine æ‹†åˆ†ä¸ºæ›´å°çš„æ¨¡å—ï¼š
```
VaultLendingEngine (1070è¡Œ)
    â†“ æ‹†åˆ†ä¸º
LendingEngineCore (~400è¡Œ)     - æ ¸å¿ƒå€Ÿè´·é€»è¾‘
LendingEngineAccounting (~300è¡Œ) - å€ºåŠ¡æ ¸ç®—
LendingEngineValuation (~300è¡Œ)  - ä¼°å€¼ä¸ä¼˜é›…é™çº§
```

### 8. åŒå…¥å£é£é™© âš ï¸ **é«˜é£é™©**

#### é—®é¢˜æè¿°
æ–‡æ¡£å£°æ˜ï¼ˆç¬¬460è¡Œï¼‰ï¼š
> ç»Ÿä¸€èµ° `VaultCore` â†’ `LendingEngine` çš„è´¦æœ¬å…¥å£ï¼ˆ`onlyVaultCore`ï¼‰ï¼Œæ¶ˆé™¤åŒå…¥å£ä¸æƒé™ä¸ä¸€è‡´

ä½†åœ¨å®é™…ä»£ç ä¸­ï¼š
```solidity
// VaultLendingEngine.sol
modifier onlyVaultCore() {
    if (msg.sender != _getModuleAddress(ModuleKeys.KEY_VAULT_CORE)) {
        // ...
    }
}
```

#### é—®é¢˜ç‚¹
1. **æ¸…ç®—å¯ä»¥ç›´æ¥è°ƒç”¨** `ILendingEngineBasic.forceReduceDebt` - å­˜åœ¨ä¸ç»è¿‡ VaultCore çš„å…¥å£
2. è¿™å¯èƒ½å¯¼è‡´çŠ¶æ€ä¸ä¸€è‡´ï¼š
   - ç»•è¿‡ View å±‚ç¼“å­˜æ›´æ–°
   - äº‹ä»¶æ¨é€å¯èƒ½ä¸å®Œæ•´

#### å½±å“
- âŒ ç¼“å­˜ä¸è´¦æœ¬æ•°æ®å¯èƒ½ä¸åŒæ­¥
- âŒ é“¾ä¸‹ç›‘æ§å¯èƒ½æ¼æ‰å…³é”®äº‹ä»¶
- âŒ æƒé™æ ¡éªŒå¯èƒ½ä¸ä¸€è‡´

#### è§£å†³æ–¹æ¡ˆå»ºè®®
1. æ˜ç¡®å®šä¹‰å“ªäº›å‡½æ•°å¯ä»¥è¢«æ¸…ç®—æ¨¡å—ç›´æ¥è°ƒç”¨
2. ç¡®ä¿æ‰€æœ‰ç»•è¿‡ VaultCore çš„è·¯å¾„ä¹Ÿæ­£ç¡®æ›´æ–°ç¼“å­˜å’Œæ¨é€äº‹ä»¶
3. æ·»åŠ ç«¯åˆ°ç«¯æµ‹è¯•éªŒè¯æ‰€æœ‰å…¥å£çš„ä¸€è‡´æ€§

### 9. VaultView å‘½åè¯¯å¯¼é—®é¢˜ âš ï¸ **ä¸­é£é™©**

#### é—®é¢˜æè¿°
æ–‡æ¡£å¤šå¤„å¼ºè°ƒ View å±‚åº”è¯¥æ˜¯"åªè¯»"çš„ï¼Œä½†å®é™…ä¸Š `VaultView` å……å½“äº†**ä¸­é—´è·¯ç”±å±‚**ï¼š

```solidity
// VaultView.sol - è¿™å®é™…ä¸Šæ˜¯ä¸€ä¸ªå†™å…¥æ“ä½œ
function processUserOperation(...) external onlyAuthorizedContract {
    _distributeToModule(user, operationType, asset, amount);  // è§¦å‘ä¸šåŠ¡æ¨¡å—å†™å…¥
    _updateLocalState(user, operationType, asset, amount);    // æ›´æ–°ç¼“å­˜
}
```

#### å½±å“
- âš ï¸ å‘½åä¸ç›´è§‚ï¼Œå¯èƒ½å¯¼è‡´å¼€å‘è€…è¯¯è§£
- âš ï¸ å¦‚æœ View åˆçº¦è¢«æ”»å‡»ï¼Œå¯èƒ½å½±å“æ•´ä¸ªç³»ç»ŸçŠ¶æ€
- âš ï¸ å®‰å…¨å®¡è®¡æ—¶å¯èƒ½ä½ä¼°å…¶é£é™©

#### è§£å†³æ–¹æ¡ˆå»ºè®®
è€ƒè™‘å°† `VaultView` é‡å‘½åä¸º `VaultRouter` æˆ– `VaultCoordinator` ä»¥æ›´å‡†ç¡®åæ˜ å…¶èŒè´£ã€‚

### 10. Registry å­˜å‚¨æ§½ä½å†²çªé£é™© âš ï¸ **é«˜é£é™©**

#### é—®é¢˜æè¿°
æ–‡æ¡£è®¾è®¡ï¼ˆç¬¬876-880è¡Œï¼‰ä½¿ç”¨å›ºå®šæ§½ä½ï¼š
```solidity
bytes32 internal constant STORAGE_SLOT = keccak256("registry.storage.v1");
```

#### æ½œåœ¨é—®é¢˜
1. **ç¼ºå°‘å­˜å‚¨ç‰ˆæœ¬è¿ç§»æœºåˆ¶çš„è¯¦ç»†è¯´æ˜**: æ–‡æ¡£è™½ç„¶æåˆ°äº† `storageVersion` å’Œ `migrateVxToVy()`ï¼Œä½†æ²¡æœ‰æä¾›å…·ä½“å®ç°æŒ‡å—
2. **å…±äº«å­˜å‚¨çš„å±é™©æ€§**: å¤šä¸ªåˆçº¦å…±äº«å­˜å‚¨æ§½ä½ï¼Œä»»ä¸€å®ç°ä¸­çš„é”™è¯¯å¯èƒ½ç ´åæ•´ä¸ªæ•°æ®

#### å½±å“
- âŒ å‡çº§æ—¶å¯èƒ½ä¸¢å¤±æ•°æ®
- âŒ å­˜å‚¨å¸ƒå±€å˜æ›´å¯èƒ½å¯¼è‡´çŠ¶æ€æŸå
- âŒ å›æ»šå›°éš¾

#### è§£å†³æ–¹æ¡ˆå»ºè®®
1. æ·»åŠ å­˜å‚¨å¸ƒå±€æ ¡éªŒå·¥å…·ï¼ˆå¦‚ OpenZeppelin Upgrades æ’ä»¶ï¼‰
2. å¼ºåˆ¶åœ¨æ¯æ¬¡å‡çº§å‰è¿è¡Œ `validateStorageLayout()`
3. æä¾›è¯¦ç»†çš„è¿ç§»è„šæœ¬æ¨¡æ¿
4. åœ¨ CI ä¸­åŠ å…¥å­˜å‚¨å¸ƒå±€æ£€æŸ¥

### 11. æ¸…ç®—æµç¨‹å¤æ‚æ€§ âš ï¸ **ä¸­é£é™©**

#### é—®é¢˜æè¿°
æ–‡æ¡£ç¬¬464-496è¡Œæè¿°çš„æ¸…ç®—æµç¨‹æ¶‰åŠå¤šä¸ªæ¨¡å—ï¼š
- `VaultBusinessLogic` / `LiquidationManager`ï¼ˆç¼–æ’å…¥å£ï¼‰
- `CollateralManager.withdrawCollateral`ï¼ˆæ‰£æŠ¼æŠµæŠ¼ï¼‰
- `LendingEngine.forceReduceDebt`ï¼ˆå‡å°‘å€ºåŠ¡ï¼‰
- `LiquidatorView.pushLiquidationUpdate`ï¼ˆäº‹ä»¶æ¨é€ï¼‰

#### æ½œåœ¨é£é™©
1. **åŸå­æ€§é—®é¢˜**: å¦‚æœåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æŸæ­¥éª¤å¤±è´¥ï¼Œå¯èƒ½å¯¼è‡´éƒ¨åˆ†çŠ¶æ€æ›´æ–°
2. **æƒé™æ ¡éªŒåˆ†æ•£**: ä¸åŒæ¨¡å—å„è‡ªåšæƒé™æ ¡éªŒï¼Œå¯èƒ½å­˜åœ¨ä¸ä¸€è‡´
3. **äº‹ä»¶åŒå‘**: æ–‡æ¡£æåˆ°"é¿å…äº‹ä»¶åŒå‘"ä½†å®é™…å®ç°éœ€è¦ä»”ç»†å®¡æŸ¥

#### å½±å“
- âŒ éƒ¨åˆ†æ¸…ç®—å¯èƒ½å¯¼è‡´ç”¨æˆ·çŠ¶æ€ä¸ä¸€è‡´
- âŒ é“¾ä¸‹ç›‘æ§å¯èƒ½æ”¶åˆ°é‡å¤æˆ–é—æ¼çš„äº‹ä»¶

#### è§£å†³æ–¹æ¡ˆå»ºè®®
æ·»åŠ ç«¯åˆ°ç«¯çš„æ¸…ç®—æµ‹è¯•ï¼Œè¦†ç›–å„ç§å¤±è´¥åœºæ™¯ï¼š
- æ‰£æŠ¼æˆåŠŸä½†å‡å€ºå¤±è´¥
- å‡å€ºæˆåŠŸä½†äº‹ä»¶æ¨é€å¤±è´¥
- å¹¶å‘æ¸…ç®—åŒä¸€ç”¨æˆ·

### 12. Reward æ¨¡å—å…¥å£æ”¶ç´§éªŒè¯ âš ï¸ **ä¸­é£é™©**

#### é—®é¢˜æè¿°
æ–‡æ¡£è¦æ±‚ï¼ˆç¬¬743-748è¡Œï¼‰ï¼š
- å”¯ä¸€è·¯å¾„ï¼š`LendingEngine` â†’ `RewardManager` â†’ `RewardManagerCore`
- ç›´æ¥è°ƒç”¨ `RewardManagerCore.onLoanEvent` åº”è¯¥è§¦å‘é”™è¯¯ `RewardManagerCore__UseRewardManagerEntry`

#### éœ€è¦éªŒè¯
- [ ] æ˜¯å¦æ‰€æœ‰ Reward ç›¸å…³æµ‹è¯•éƒ½å·²æ›´æ–°
- [ ] æ˜¯å¦å­˜åœ¨é—ç•™çš„ç›´æ¥è°ƒç”¨è·¯å¾„
- [ ] æ˜¯å¦æœ‰è„šæœ¬ä»ç„¶ä½¿ç”¨æ—§å…¥å£

#### å½±å“
- âš ï¸ å¦‚æœå­˜åœ¨é—ç•™å…¥å£ï¼Œå¯èƒ½å¯¼è‡´å¥–åŠ±é‡å¤å‘æ”¾æˆ–æ¼å‘
- âš ï¸ ä¸è´¦æœ¬çŠ¶æ€ä¸åŒæ­¥

### 13. Gas ä¼°ç®—å¯èƒ½ä¸å‡†ç¡® âš ï¸ **ä½é£é™©**

#### é—®é¢˜æè¿°
æ–‡æ¡£å£°æ˜ï¼ˆç¬¬374-376è¡Œï¼‰ï¼š
| æ›´æ–°ç±»å‹ | åŒæ¶æ„æ–¹æ¡ˆ |
|----------|------------|
| æƒé™æ›´æ–° | 21,000 gas |
| ä½ç½®æ›´æ–° | 25,000 gas |

è¿™äº›ä¼°ç®—å¯èƒ½è¿‡äºä¹è§‚ï¼Œå®é™…å–å†³äºï¼š
- å­˜å‚¨æ§½çš„å†·/çƒ­çŠ¶æ€
- è·¨åˆçº¦è°ƒç”¨æ¬¡æ•°
- äº‹ä»¶æ•°æ®å¤§å°

#### è§£å†³æ–¹æ¡ˆå»ºè®®
ä½¿ç”¨å®é™…éƒ¨ç½²åçš„ gas profiling æ›´æ–°è¿™äº›æ•°æ®ã€‚

---

### 14. æƒé™å’Œå®‰å…¨æ€§é—®é¢˜ âš ï¸ **é«˜é£é™©**

#### é—®é¢˜æè¿°
æ•°æ®æ¨é€æ¥å£éœ€è¦ä¸¥æ ¼çš„æƒé™æ§åˆ¶ï¼š

```solidity
modifier onlyBusinessContract() {
    // å…è®¸ä¸šåŠ¡æ¨¡å—è°ƒç”¨
    address collateralManager = _getCachedCollateralManager();
    address lendingEngine = _getCachedLendingEngine();
    // ...
}
```

#### æ½œåœ¨é£é™©
- âŒ å¦‚æœæƒé™éªŒè¯æœ‰æ¼æ´ï¼Œæ¶æ„åˆçº¦å¯èƒ½æ¨é€é”™è¯¯æ•°æ®
- âŒ ç¼“å­˜æ•°æ®å¯èƒ½è¢«æ¶æ„ä¿®æ”¹
- âŒ å¯¼è‡´ç”¨æˆ·æŸ¥è¯¢åˆ°é”™è¯¯ä¿¡æ¯

#### è§£å†³æ–¹æ¡ˆå»ºè®®
1. **ä¸¥æ ¼æƒé™éªŒè¯**ï¼š
   ```solidity
   modifier onlyBusinessContract() {
       address collateralManager = Registry(_registryAddrVar)
           .getModuleOrRevert(ModuleKeys.KEY_CM);
       address lendingEngine = Registry(_registryAddrVar)
           .getModuleOrRevert(ModuleKeys.KEY_LE);
       
       require(
           msg.sender == collateralManager || 
           msg.sender == lendingEngine ||
           msg.sender == vaultBusinessLogic,
           "Unauthorized"
       );
       _;
   }
   ```

2. **æ•°æ®éªŒè¯**ï¼š
   - æ¨é€æ—¶éªŒè¯æ•°æ®åˆç†æ€§
   - ä¸è´¦æœ¬æ•°æ®å¯¹æ¯”éªŒè¯

### 8. æµ‹è¯•å¤æ‚åº¦é—®é¢˜ âš ï¸ **ä½é£é™©**

#### é—®é¢˜æè¿°
åŒæ¶æ„æ¨¡å¼å¢åŠ äº†æµ‹è¯•å¤æ‚åº¦ï¼š
- éœ€è¦æµ‹è¯•è´¦æœ¬å’Œç¼“å­˜çš„ä¸€è‡´æ€§
- éœ€è¦æµ‹è¯•æ¨é€å¤±è´¥åœºæ™¯
- éœ€è¦æµ‹è¯•å¹¶å‘æ›´æ–°åœºæ™¯

#### å½±å“
- âš ï¸ æµ‹è¯•ç”¨ä¾‹æ•°é‡å¢åŠ 
- âš ï¸ æµ‹è¯•æ‰§è¡Œæ—¶é—´å¢åŠ 
- âš ï¸ éœ€è¦æ›´å¤æ‚çš„æµ‹è¯•ç¯å¢ƒ

## ğŸš¨ å…³é”®æ¶æ„ç¼ºé™·ï¼ˆ2025-12-15 è¡¥å……å®¡è®¡ï¼‰

> **éªŒè¯çŠ¶æ€**ï¼šä»¥ä¸‹é—®é¢˜å·²é€šè¿‡ä»£ç çº§åˆ†æç¡®è®¤å­˜åœ¨ï¼ˆ2025-12-15 äºŒæ¬¡éªŒè¯ï¼‰

### 15. å€Ÿè´·æµç¨‹æ§åˆ¶æµæ–­è£‚ âš ï¸ **P0 é˜»æ–­æ€§é—®é¢˜** âœ… å·²éªŒè¯

#### é—®é¢˜æè¿°
æ ¹æ®æ¶æ„æ–‡æ¡£ï¼Œ`VaultCore` åº”ç»Ÿä¸€è°ƒç”¨ `LendingEngine` è¿›è¡Œè´¦æœ¬å†™å…¥ã€‚ä½†å®é™…ä»£ç è·¯å¾„å¦‚ä¸‹ï¼š
1. `VaultCore.borrow` è°ƒç”¨ `VaultView.processUserOperation`ã€‚
2. `VaultView.processUserOperation` è°ƒç”¨ `_distributeToModule`ã€‚
3. `VaultView._distributeToModule` é’ˆå¯¹ `ACTION_BORROW` **æœªæ‰§è¡Œä»»ä½•æ“ä½œ**ï¼ˆç©ºä»£ç å—ï¼‰ã€‚
4. `VaultLendingEngine.borrow` å…·æœ‰ `onlyVaultCore` ä¿®é¥°ç¬¦ï¼Œè¦æ±‚ `msg.sender` å¿…é¡»ä¸º `VaultCore`ã€‚

**ç»“æœ**ï¼šæ ‡å‡†å€Ÿè´·æµç¨‹æ— æ³•æ‰§è¡Œã€‚`VaultCore` å§”æ‰˜ç»™ `VaultView`ï¼Œä½† `VaultView` ä¸ä½œä¸ºï¼Œä¸”å³ä½¿ `VaultView` å°è¯•è°ƒç”¨ `LendingEngine`ï¼Œä¹Ÿä¼šå› æƒé™æ ¡éªŒå¤±è´¥ï¼ˆ`msg.sender` ä¸º `VaultView` è€Œé `VaultCore`ï¼‰è€Œ revertã€‚

#### ä»£ç éªŒè¯è¯æ®

**VaultCore.borrow()** (ç¬¬77-80è¡Œ)ï¼š
```solidity
function borrow(address asset, uint256 amount) external {
    require(amount > 0, "Amount must be positive");
    IVaultView(_viewContractAddr).processUserOperation(msg.sender, ActionKeys.ACTION_BORROW, asset, amount, block.timestamp);
}
```
â†’ è°ƒç”¨ `VaultView.processUserOperation()`

**VaultView._distributeToModule()** (ç¬¬261-282è¡Œ) â€” **é—®é¢˜æ‰€åœ¨**ï¼š
```solidity
function _distributeToModule(...) internal onlyValidRegistry {
    if (operationType == ActionKeys.ACTION_DEPOSIT) {
        address collateralManager = _getCachedCollateralManager();
        ICollateralManager(collateralManager).depositCollateral(user, asset, amount);
    } else if (operationType == ActionKeys.ACTION_WITHDRAW) {
        address collateralManager = _getCachedCollateralManager();
        ICollateralManager(collateralManager).withdrawCollateral(user, asset, amount);
    } else if (operationType == ActionKeys.ACTION_BORROW) {
        // è´¦æœ¬å†™å…¥ç»Ÿä¸€ç”± VaultCore æ‰§è¡Œï¼›View å±‚ä¸å†ç›´å†™è´¦æœ¬
        // <-- ç©ºä»£ç å—ï¼æ²¡æœ‰è°ƒç”¨ LendingEngine.borrow()ï¼
    } else if (operationType == ActionKeys.ACTION_REPAY) {
        // è´¦æœ¬å†™å…¥ç»Ÿä¸€ç”± VaultCore æ‰§è¡Œï¼›View å±‚ä¸å†ç›´å†™è´¦æœ¬
        // <-- ç©ºä»£ç å—ï¼æ²¡æœ‰è°ƒç”¨ LendingEngine.repay()ï¼
    }
}
```

**VaultLendingEngine.borrow()** (ç¬¬452-468è¡Œ) æƒé™é™åˆ¶ï¼š
```solidity
function borrow(...) external override onlyValidRegistry nonReentrant onlyVaultCore {
    // åªå…è®¸ VaultCore ç›´æ¥è°ƒç”¨ï¼Œä½† VaultCore ä»æœªç›´æ¥è°ƒç”¨æ­¤å‡½æ•°
}
```

#### å½±å“
- âŒ **æ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½ä¸å¯ç”¨**ï¼šå€Ÿæ¬¾å’Œè¿˜æ¬¾æ— æ³•é€šè¿‡æ ‡å‡†å…¥å£æ‰§è¡Œã€‚
- âŒ **æ¶æ„é€»è¾‘è‡ªç›¸çŸ›ç›¾**ï¼šä»£ç å®ç°ä¸"VaultCore ç»Ÿä¸€å…¥å£"çš„å£°æ˜å®Œå…¨èƒŒç¦»ã€‚

#### æ”¹è¿›å»ºè®®
- **æ–¹æ¡ˆ Aï¼ˆæ¨èï¼‰**ï¼šä¿®æ”¹ `VaultCore`ï¼Œä½¿å…¶ç›´æ¥è°ƒç”¨ `LendingEngine`ï¼ˆ`ILendingEngineBasic.borrow`ï¼‰ï¼Œä¸å†ç»è¿‡ `VaultView` è¿›è¡Œå†™æ“ä½œã€‚
- **æ–¹æ¡ˆ B**ï¼šä¿®æ”¹ `VaultLendingEngine` æƒé™ï¼Œå…è®¸ `VaultView` è°ƒç”¨ï¼Œå¹¶åœ¨ `VaultView` ä¸­è¡¥å……è°ƒç”¨é€»è¾‘ï¼ˆä¸æ¨èï¼Œè¿èƒŒ View å±‚åªè¯»åŸåˆ™ï¼‰ã€‚

---

### 16. å¥–åŠ±æ¨¡å—è§¦å‘ç¼ºå¤± âš ï¸ **P0 é˜»æ–­æ€§é—®é¢˜** âœ… å·²éªŒè¯

#### é—®é¢˜æè¿°
æ¶æ„æ–‡æ¡£è¦æ±‚â€œè´¦æœ¬è½è´¦åè§¦å‘å¥–åŠ±â€ï¼Œå¹¶æŒ‡å®šè·¯å¾„ä¸º `LendingEngine` -> `RewardManager`ã€‚
å®é™…å®¡è®¡ `VaultLendingEngine.sol` å‘ç°ï¼š
- å€Ÿè´·é€»è¾‘ï¼ˆ`borrow`/`repay`ï¼‰ä¸­æ— ä»»ä½•å¯¹ `RewardManager` çš„è°ƒç”¨ã€‚
- åŸæœ‰çš„å¥–åŠ±è§¦å‘ä»£ç è¢«æ³¨é‡Šè¯´æ˜â€œå¥–åŠ±è§¦å‘å‡½æ•°ç§»é™¤â€ã€‚
- `VaultLendingEngine` æœªç»§æ‰¿åŒ…å«å¥–åŠ±é€»è¾‘çš„åŸºç±»ã€‚

#### ä»£ç éªŒè¯è¯æ®

**VaultLendingEngine.sol** ç¬¬1009-1013è¡Œï¼š
```solidity
/// @notice é€šçŸ¥RewardManagerå¤„ç†ç§¯åˆ†å¥–åŠ±
/// @param user ç”¨æˆ·åœ°å€
/// @param amount æ“ä½œé‡‘é¢
/// @param isRepayment æ˜¯å¦ä¸ºè¿˜æ¬¾æ“ä½œ
// å¥–åŠ±è§¦å‘å‡½æ•°ç§»é™¤  <-- æ˜ç¡®æ³¨é‡Šè¯´æ˜å·²ç§»é™¤
```

**grep æœç´¢ç»“æœ**ï¼šåœ¨ `VaultLendingEngine.sol` ä¸­æœç´¢ `onLoanEvent` æ— ä»»ä½•ç»“æœã€‚

#### å½±å“
- âŒ **å¥–åŠ±ç³»ç»Ÿå¤±æ•ˆ**ï¼šç”¨æˆ·å€Ÿè´·æ— æ³•è·å¾—ä»»ä½•ç§¯åˆ†å¥–åŠ±ã€‚
- âŒ **ä¸šåŠ¡æ‰¿è¯ºæœªå…‘ç°**ï¼šç§¯åˆ†æ¿€åŠ±æœºåˆ¶å®Œå…¨æœªæ¥å…¥ã€‚

#### æ”¹è¿›å»ºè®®
- åœ¨ `VaultLendingEngine.recordBorrow` å’Œ `repay` å‡½æ•°æœ«å°¾ï¼ˆçŠ¶æ€æ›´æ–°æˆåŠŸåï¼‰ï¼Œæ¢å¤å¯¹ `RewardManager.onLoanEvent` çš„è°ƒç”¨ã€‚

---

### 17. å¥åº·çŠ¶æ€æ¨é€é™é»˜å¤±è´¥é£é™© âš ï¸ **P1 é«˜é£é™©** âœ… å·²éªŒè¯

#### é—®é¢˜æè¿°
åœ¨ `VaultLendingEngine._pushHealthStatus` ä¸­ä½¿ç”¨ä½çº§è°ƒç”¨å¹¶æ˜¾å¼å¿½ç•¥è¿”å›å€¼ã€‚

#### ä»£ç éªŒè¯è¯æ®

**VaultLendingEngine._pushHealthStatus()** ç¬¬1060-1068è¡Œï¼š
```solidity
// æ¨é€åˆ° HealthView
(bool ok, ) = hv.call(abi.encodeWithSignature(
    "pushRiskStatus(address,uint256,uint256,bool,uint256)",
    user,
    hfBps,
    minHFBps,
    under,
    block.timestamp
));
ok; // silence  <-- æ˜¾å¼å¿½ç•¥è¿”å›å€¼
```

#### å½±å“
- âš ï¸ å¦‚æœ `HealthView` é€»è¾‘é”™è¯¯æˆ– Gas ä¸è¶³ï¼Œå¥åº·å› å­æ›´æ–°å°†é™é»˜å¤±è´¥ã€‚
- âš ï¸ é“¾ä¸‹æ¸…ç®—æœºå™¨äººå¯èƒ½è¯»å–åˆ°è¿‡æ—¶çš„å¥åº·çŠ¶æ€ï¼Œå¯¼è‡´æ¸…ç®—å»¶è¿Ÿæˆ–è¯¯åˆ¤ã€‚

#### æ”¹è¿›å»ºè®®
- è‡³å°‘åº”å‘å‡º `HealthPushFailed` äº‹ä»¶ï¼Œä»¥ä¾¿é“¾ä¸‹ç›‘æ§ç³»ç»Ÿæ„ŸçŸ¥å¹¶ä»‹å…¥ã€‚

---

### 18. ä»“ä½æ¨é€å¯ç”¨æ€§é£é™© âš ï¸ **P1 é«˜é£é™©** âœ… å·²éªŒè¯

#### é—®é¢˜æè¿°
ä¸å¥åº·æ¨é€ä¸åŒï¼Œ`VaultLendingEngine._pushUserPositionToView` ä½¿ç”¨ç›´æ¥è°ƒç”¨ã€‚

#### ä»£ç éªŒè¯è¯æ®

**VaultLendingEngine._pushUserPositionToView()** ç¬¬1015-1029è¡Œï¼š
```solidity
function _pushUserPositionToView(address user, address asset) internal {
    address cm = _getModuleAddress(ModuleKeys.KEY_CM);
    address viewAddr = _resolveVaultViewAddr();

    uint256 collateral = ICollateralManager(cm).getCollateral(user, asset);
    uint256 debt = _userDebt[user][asset];

    // ç›´æ¥è°ƒç”¨ï¼Œæ—  try-catch ä¿æŠ¤
    IVaultView(viewAddr).pushUserPositionUpdate(user, asset, collateral, debt);
}
```

#### å½±å“
- âš ï¸ å¦‚æœ `VaultView` å› ä»»ä½•åŸå›  revertï¼Œæ•´ä¸ªå€Ÿè´·äº¤æ˜“å°†å¤±è´¥ã€‚
- âš ï¸ è¿™ç¬¦åˆå¼ºä¸€è‡´æ€§è¦æ±‚ï¼Œä½†è¿èƒŒ"View å±‚ä¸åº”é˜»æ–­æ ¸å¿ƒä¸šåŠ¡"çš„æŸäº›éŸ§æ€§åŸåˆ™ã€‚

#### æ”¹è¿›å»ºè®®
- è¯„ä¼°æ˜¯å¦éœ€è¦é™çº§ä¸º `try-catch` æ¨¡å¼ï¼Œæˆ–ç¡®è®¤"å¼ºä¸€è‡´æ€§"æ˜¯é¢„æœŸè¡Œä¸ºã€‚å»ºè®®åœ¨æ–‡æ¡£ä¸­æ˜ç¡®æ­¤æƒè¡¡ã€‚

---

### 19. VaultCore ç¼ºå°‘ viewContractAddrVar å…¬å¼€æ–¹æ³• âš ï¸ **P0 é˜»æ–­æ€§é—®é¢˜** ğŸ†• æ–°å‘ç°

#### é—®é¢˜æè¿°
å¤šä¸ªæ¨¡å—ï¼ˆ`VaultLendingEngine`ã€`CollateralManager`ã€`VaultBusinessLogic`ã€`LiquidationManager` ç­‰ï¼‰é€šè¿‡ä»¥ä¸‹æ–¹å¼è§£æ VaultView åœ°å€ï¼š
```solidity
address vaultCore = _getModuleAddress(ModuleKeys.KEY_VAULT_CORE);
return IVaultCoreMinimal(vaultCore).viewContractAddrVar();
```

ä½† **VaultCore.sol ä¸­æ²¡æœ‰æš´éœ² `viewContractAddrVar()` å…¬å¼€æ–¹æ³•**ã€‚

#### ä»£ç éªŒè¯è¯æ®

**VaultCore.sol** ç¬¬26-27è¡Œï¼š
```solidity
/// @notice Viewå±‚åˆçº¦åœ°å€
address private _viewContractAddr;  // <-- æ˜¯ private çš„ï¼Œæ²¡æœ‰ public getter
```

**å¤šä¸ªæ¨¡å—å°è¯•è°ƒç”¨æ­¤æ–¹æ³•**ï¼ˆgrep æœç´¢ç»“æœï¼‰ï¼š
- `VaultLendingEngine.sol:28` - å®šä¹‰ `IVaultCoreMinimal` æ¥å£åŒ…å« `viewContractAddrVar()`
- `VaultLendingEngine.sol:1034` - `return IVaultCoreMinimal(vaultCore).viewContractAddrVar();`
- `CollateralManager.sol:509` - `return IVaultCoreMinimal(vaultCore).viewContractAddrVar();`
- `VaultBusinessLogic.sol:114` - `try IVaultCoreMinimal(vaultCore).viewContractAddrVar()`
- `LiquidationManager.sol:264/291` - åŒæ ·è°ƒç”¨

#### å½±å“
- âŒ **æ¨¡å—é—´é€šä¿¡æ–­è£‚**ï¼šæ‰€æœ‰å°è¯•é€šè¿‡ VaultCore è§£æ VaultView åœ°å€çš„æ¨¡å—éƒ½ä¼šå¤±è´¥ã€‚
- âŒ **`_pushUserPositionToView` æ— æ³•å·¥ä½œ**ï¼šVaultLendingEngine è°ƒç”¨ `_resolveVaultViewAddr()` ä¼šå¤±è´¥ã€‚
- âŒ **ä¸é—®é¢˜15å åŠ **ï¼šå³ä½¿ä¿®å¤é—®é¢˜15ï¼Œä»“ä½æ¨é€ä»ç„¶æ— æ³•å·¥ä½œã€‚

#### æ”¹è¿›å»ºè®®
åœ¨ `VaultCore.sol` ä¸­æ·»åŠ å…¬å¼€ getterï¼š
```solidity
/// @notice è·å– View å±‚åˆçº¦åœ°å€
function viewContractAddrVar() external view returns (address) {
    return _viewContractAddr;
}
```


## âœ… ä¼˜åŠ¿æ€»ç»“

å°½ç®¡å­˜åœ¨ä¸Šè¿°é—®é¢˜ï¼ŒåŒæ¶æ„æ¨¡å¼ä¹Ÿæœ‰æ˜æ˜¾ä¼˜åŠ¿ï¼š

1. **æŸ¥è¯¢æ€§èƒ½**ï¼š0 gasæŸ¥è¯¢ï¼Œå“åº”é€Ÿåº¦å¿«
2. **ç”¨æˆ·ä½“éªŒ**ï¼šå‰ç«¯å¯ä»¥å¿«é€Ÿè·å–æ•°æ®
3. **AIå‹å¥½**ï¼šå®Œæ•´çš„äº‹ä»¶å†å²ä¾¿äºåˆ†æ
4. **Gasä¼˜åŒ–**ï¼šæŸ¥è¯¢å…è´¹ï¼Œåªåœ¨æ›´æ–°æ—¶æ”¯ä»˜

## ğŸ¯ æ”¹è¿›å»ºè®®ä¼˜å…ˆçº§

### ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼ˆå¿…é¡»è§£å†³ï¼‰

| åºå· | é—®é¢˜ | è¡ŒåŠ¨é¡¹ | è´£ä»»æ–¹ |
|------|------|--------|--------|
| 1 | **viewContractAddrVar å…¬å¼€æ–¹æ³•ç¼ºå¤±** ğŸ†• | åœ¨ VaultCore ä¸­æ·»åŠ  viewContractAddrVar() getter | æ ¸å¿ƒå¼€å‘ |
| 2 | **å€Ÿè´·æµç¨‹æ§åˆ¶æµæ–­è£‚** âœ… | ä¿®æ”¹ VaultCore ç›´æ¥è°ƒç”¨ LendingEngineï¼Œä¿®å¤é˜»æ–­æ€§ Bug | æ ¸å¿ƒå¼€å‘ |
| 3 | **å¥–åŠ±æ¨¡å—è§¦å‘ç¼ºå¤±** âœ… | åœ¨ LendingEngine ä¸­æ¢å¤ RewardManager è°ƒç”¨ | æ ¸å¿ƒå¼€å‘ |
| 4 | **æ›´æ–°æ–‡æ¡£ä¸­çš„ä»£ç ç¤ºä¾‹** | ç¡®ä¿ Architecture-Guide.md ä¸å®é™…å®ç°ä¸€è‡´ | æ–‡æ¡£ç»´æŠ¤ |
| 5 | **ç¼“å­˜æ•°æ®ä¸€è‡´æ€§éªŒè¯æœºåˆ¶** | æ·»åŠ ç¼“å­˜æœ‰æ•ˆæ€§æ£€æŸ¥å’Œå›é€€åˆ°è´¦æœ¬ | æ ¸å¿ƒå¼€å‘ |
| 6 | **æ‹†åˆ† VaultLendingEngine** | æ§åˆ¶å•ä¸ªåˆçº¦å¤æ‚åº¦è‡³ 500 è¡Œä»¥å†… | æ ¸å¿ƒå¼€å‘ |
| 7 | **åŠ å¼ºåŒå…¥å£ä¸€è‡´æ€§** | ç¡®ä¿æ‰€æœ‰å…¥å£è·¯å¾„éƒ½æ­£ç¡®æ›´æ–°ç¼“å­˜å’Œäº‹ä»¶ | æ ¸å¿ƒå¼€å‘ |
| 8 | **æ¨é€å¤±è´¥å¤„ç†** | è®°å½•å¤±è´¥äº‹ä»¶ï¼Œæä¾›ä¿®å¤æœºåˆ¶ | æ ¸å¿ƒå¼€å‘ |
| 9 | **æƒé™å®‰å…¨åŠ å›º** | ä¸¥æ ¼éªŒè¯æ¨é€æƒé™ | å®‰å…¨å®¡è®¡ |
| 10 | **æ·»åŠ æ¸…ç®—ç«¯åˆ°ç«¯æµ‹è¯•** | è¦†ç›–æ‰€æœ‰å¤±è´¥åœºæ™¯ | QA å›¢é˜Ÿ |

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼ˆå»ºè®®è§£å†³ï¼‰

| åºå· | é—®é¢˜ | è¡ŒåŠ¨é¡¹ | è´£ä»»æ–¹ |
|------|------|--------|--------|
| 10 | **ä¿®æ­£å‘½åè§„èŒƒ** | ç§æœ‰å˜é‡å»æ‰ `Var` åç¼€ | æ ¸å¿ƒå¼€å‘ |
| 11 | **é‡å‘½å VaultView** | æ”¹ä¸º `VaultRouter` æˆ– `VaultCoordinator` | æ ¸å¿ƒå¼€å‘ |
| 12 | **å®Œå–„å­˜å‚¨è¿ç§»æ–‡æ¡£** | æä¾›å…·ä½“å®ç°æŒ‡å—å’Œæ¨¡æ¿ | æ–‡æ¡£ç»´æŠ¤ |
| 13 | **å¹¶å‘æ›´æ–°å¤„ç†** | ä½¿ç”¨å¢é‡æ›´æ–°æˆ–ç»Ÿä¸€å…¥å£ | æ ¸å¿ƒå¼€å‘ |
| 14 | **å­˜å‚¨æˆæœ¬ä¼˜åŒ–** | é€‰æ‹©æ€§ç¼“å­˜ï¼Œå®šæœŸæ¸…ç† | æ ¸å¿ƒå¼€å‘ |
| 15 | **å‡çº§å…¼å®¹æ€§** | é¢„ç•™å­˜å‚¨æ§½ï¼Œç‰ˆæœ¬åŒ–æ•°æ®ç»“æ„ | æ ¸å¿ƒå¼€å‘ |
| 16 | **éªŒè¯ Reward æ¨¡å—å…¥å£** | ç¡®ä¿æ— é—ç•™ç›´æ¥è°ƒç”¨ | QA å›¢é˜Ÿ |
| 17 | **å¥åº·æ¨é€é™é»˜å¤±è´¥ä¼˜åŒ–** | å¢åŠ  HealthPushFailed äº‹ä»¶ | æ ¸å¿ƒå¼€å‘ |

### ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰

| åºå· | é—®é¢˜ | è¡ŒåŠ¨é¡¹ | è´£ä»»æ–¹ |
|------|------|--------|--------|
| 18 | **åŠ¨æ€è¿‡æœŸç­–ç•¥** | æ ¹æ®ç”¨æˆ·æ´»è·ƒåº¦è°ƒæ•´ | æ ¸å¿ƒå¼€å‘ |
| 19 | **æµ‹è¯•å·¥å…·å®Œå–„** | è‡ªåŠ¨åŒ–ä¸€è‡´æ€§æ£€æŸ¥ | QA å›¢é˜Ÿ |
| 20 | **é‡æ–°æµ‹é‡ Gas æ¶ˆè€—** | ä½¿ç”¨çœŸå®ç¯å¢ƒæ•°æ® | æ ¸å¿ƒå¼€å‘ |
| 21 | **æ·»åŠ å­˜å‚¨å¸ƒå±€éªŒè¯ CI æ­¥éª¤** | é˜²æ­¢å‡çº§ç ´åå­˜å‚¨ | DevOps |

---

## ğŸ“Š ä¸å…¶ä»–æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | æŸ¥è¯¢æˆæœ¬ | æ•°æ®ä¸€è‡´æ€§ | å­˜å‚¨æˆæœ¬ | å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|------|---------|-----------|---------|--------|---------|
| **æ‚¨çš„åŒæ¶æ„** | 0 gas | âš ï¸ éœ€è¦ç»´æŠ¤ | é«˜ | é«˜ | é«˜é¢‘æŸ¥è¯¢åœºæ™¯ |
| **çº¯äº‹ä»¶é©±åŠ¨** | 0 gas | âœ… å¼ºä¸€è‡´æ€§ | ä½ | ä½ | å¤§å¤šæ•°DeFié¡¹ç›® |
| **é“¾ä¸‹ç´¢å¼•** | 0 gas | âœ… å¼ºä¸€è‡´æ€§ | ä½ | ä¸­ | éœ€è¦å¤æ‚æŸ¥è¯¢ |
| **ä¼ ç»Ÿç¼“å­˜** | 0 gas | âš ï¸ éœ€è¦ç»´æŠ¤ | ä¸­ | ä¸­ | ç®€å•åœºæ™¯ |

---

## ğŸ”— å‚è€ƒé¡¹ç›®

1. **Uniswap V3** - äº‹ä»¶é©±åŠ¨ï¼Œé“¾ä¸‹ç´¢å¼•
2. **Aave** - äº‹ä»¶é©±åŠ¨ï¼ŒThe Graphç´¢å¼•
3. **MakerDAO** - é“¾ä¸Šç¼“å­˜ï¼ˆä¸»è¦ç”¨äºä»·æ ¼ï¼‰
4. **Synthetix** - é“¾ä¸Šèšåˆæ•°æ®ç¼“å­˜

---

## ğŸ“‹ é—®é¢˜æ¸…å•æ€»è§ˆ

### æŒ‰é£é™©ç­‰çº§åˆ†ç±»

| é£é™©ç­‰çº§ | é—®é¢˜æ•° | é—®é¢˜åˆ—è¡¨ |
|----------|--------|----------|
| ğŸ”´ **P0 é˜»æ–­æ€§** | 3 | **å€Ÿè´·æµç¨‹æ–­è£‚** âœ…ã€**å¥–åŠ±è§¦å‘ç¼ºå¤±** âœ…ã€**viewContractAddrVarç¼ºå¤±** ğŸ†• |
| ğŸ”´ **é«˜é£é™©** | 8 | ç¼“å­˜ä¸€è‡´æ€§ã€VaultLendingEngineè§„æ¨¡ã€åŒå…¥å£é£é™©ã€Registryå­˜å‚¨æ§½ä½ã€æƒé™å®‰å…¨ã€æ¸…ç®—åŸå­æ€§ã€å¥åº·æ¨é€å¤±è´¥ âœ…ã€ä»“ä½æ¨é€å¯ç”¨æ€§ âœ… |
| ğŸŸ¡ **ä¸­é£é™©** | 7 | æ¨é€å¤±è´¥å¤„ç†ã€å¹¶å‘æ›´æ–°ã€å‡çº§å…¼å®¹æ€§ã€VaultViewå‘½åã€æ¸…ç®—å¤æ‚æ€§ã€Rewardå…¥å£éªŒè¯ã€å­˜å‚¨æˆæœ¬ |
| ğŸŸ¢ **ä½é£é™©** | 5 | å‘½åè§„èŒƒã€ç¼“å­˜è¿‡æœŸç­–ç•¥ã€Gasä¼°ç®—ã€æµ‹è¯•å¤æ‚åº¦ã€æ–‡æ¡£ä»£ç ç¤ºä¾‹ |

> âœ… = å·²é€šè¿‡ä»£ç éªŒè¯ç¡®è®¤å­˜åœ¨ | ğŸ†• = æœ¬æ¬¡æ–°å‘ç°

### æŒ‰é—®é¢˜ç±»å‹åˆ†ç±»

| ç±»å‹ | é—®é¢˜åˆ—è¡¨ |
|------|----------|
| **æ ¸å¿ƒé€»è¾‘ç¼ºé™·** | **å€Ÿè´·æµç¨‹æ–­è£‚** âœ…ã€**å¥–åŠ±è§¦å‘ç¼ºå¤±** âœ…ã€**viewContractAddrVarç¼ºå¤±** ğŸ†• |
| **æ–‡æ¡£ä¸€è‡´æ€§** | VaultCoreä»£ç ç¤ºä¾‹ä¸ä¸€è‡´ã€å‘½åè§„èŒƒä¸ä¸€è‡´ |
| **æ¶æ„è®¾è®¡** | VaultLendingEngineè§„æ¨¡è¿‡å¤§ã€åŒå…¥å£é£é™©ã€VaultViewå‘½åè¯¯å¯¼ |
| **æ•°æ®ä¸€è‡´æ€§** | ç¼“å­˜ä¸€è‡´æ€§ã€æ¨é€å¤±è´¥å¤„ç†ã€å¹¶å‘æ›´æ–° |
| **å®‰å…¨æ€§** | æƒé™éªŒè¯ã€Registryå­˜å‚¨æ§½ä½ã€æ¸…ç®—åŸå­æ€§ã€å¥åº·æ¨é€é£é™© âœ… |
| **å¯ç»´æŠ¤æ€§** | å‡çº§å…¼å®¹æ€§ã€æµ‹è¯•å¤æ‚åº¦ã€Rewardå…¥å£éªŒè¯ |
| **æˆæœ¬ä¸æ€§èƒ½** | å­˜å‚¨æˆæœ¬ã€Gasä¼°ç®—ã€ç¼“å­˜è¿‡æœŸç­–ç•¥ |

---

## ğŸ“ ç»“è®º

æ‚¨çš„åŒæ¶æ„æ¨¡å¼æ˜¯ä¸€ä¸ª**åˆ›æ–°çš„è®¾è®¡**ï¼Œä½†åœ¨å®æ–½è¿‡ç¨‹ä¸­å‡ºç°äº†**æ ¸å¿ƒé€»è¾‘æ–­è£‚**ï¼ˆP0çº§ç¼ºé™·ï¼‰ï¼Œè¿™æ¯”ä¹‹å‰å‘ç°çš„ç¼“å­˜ä¸€è‡´æ€§é£é™©æ›´ä¸ºç´§æ€¥ã€‚

**ç´§æ€¥è¡ŒåŠ¨è®¡åˆ’**ï¼ˆæŒ‰ä¼˜å…ˆé¡ºåºï¼‰ï¼š
1. **æ·»åŠ  VaultCore.viewContractAddrVar() å…¬å¼€æ–¹æ³•**ï¼ˆé—®é¢˜19ï¼‰ï¼Œå¦åˆ™æ¨¡å—é—´é€šä¿¡å…¨éƒ¨æ–­è£‚ã€‚
2. **ä¿®å¤ VaultCore -> LendingEngine çš„è°ƒç”¨é“¾**ï¼ˆé—®é¢˜15ï¼‰ï¼Œç¡®ä¿å€Ÿè´·åŠŸèƒ½å¯ç”¨ã€‚
3. **æ¢å¤ LendingEngine ä¸­çš„ RewardManager è°ƒç”¨**ï¼ˆé—®é¢˜16ï¼‰ï¼Œç¡®ä¿æ¿€åŠ±ç³»ç»Ÿæ­£å¸¸è¿ä½œã€‚
4. **æ·»åŠ å¥åº·æ¨é€å¤±è´¥äº‹ä»¶**ï¼ˆé—®é¢˜17ï¼‰ï¼Œç¡®ä¿é“¾ä¸‹ç›‘æ§å¯æ„ŸçŸ¥å¼‚å¸¸ã€‚
5. éšåå†ç€æ‰‹å¤„ç†ç¼“å­˜ä¸€è‡´æ€§ã€æ–‡æ¡£ä¿®æ­£å’Œä»£ç è§„èŒƒç­‰é—®é¢˜ã€‚

**åŒæ¶æ„çš„ä»·å€¼ä¾ç„¶å­˜åœ¨**ï¼Œä½†åœ¨ä¿®å¤æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ä¹‹å‰ï¼Œç³»ç»Ÿçš„åŸºæœ¬åŠŸèƒ½æ˜¯ä¸å¯ç”¨çš„ã€‚

---

## ğŸ“ é™„å½•

### ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶ | ç”¨é€” | è¡Œæ•° |
|------|------|------|
| `src/Vault/VaultCore.sol` | æç®€å…¥å£åˆçº¦ | 147 |
| `src/Vault/VaultView.sol` | åŒæ¶æ„åè°ƒå™¨ | 649 |
| `src/Vault/modules/CollateralManager.sol` | æŠµæŠ¼ç®¡ç† | 531 |
| `src/Vault/modules/VaultLendingEngine.sol` | å€Ÿè´·å¼•æ“ | 1070 |
| `src/registry/Registry.sol` | æ¨¡å—æ³¨å†Œä¸­å¿ƒ | 585 |
| `docs/Architecture-Guide.md` | æ¶æ„è®¾è®¡æ–‡æ¡£ | 926 |

### ç‰ˆæœ¬å†å²

| æ—¥æœŸ | ç‰ˆæœ¬ | æ›´æ–°å†…å®¹ |
|------|------|----------|
| 2025-12-15 | v2.2 | **äºŒæ¬¡éªŒè¯**ï¼šé€šè¿‡ä»£ç çº§åˆ†æç¡®è®¤P0é—®é¢˜å­˜åœ¨ï¼Œæ–°å¢é—®é¢˜19ï¼ˆviewContractAddrVarç¼ºå¤±ï¼‰ï¼Œå…±å‘ç°3ä¸ªP0çº§é—®é¢˜ |
| 2025-12-15 | v2.1 | **ç´§æ€¥å®¡è®¡**ï¼šå‘ç°å€Ÿè´·æµç¨‹æ–­è£‚å’Œå¥–åŠ±ç¼ºå¤±ç­‰P0çº§é˜»æ–­æ€§ç¼ºé™·ï¼Œæ›´æ–°ä¼˜å…ˆçº§ |
| 2025-12-15 | v2.0 | åŸºäºæœ€æ–°æ¶æ„åˆ†ææŠ¥å‘Šå…¨é¢æ›´æ–°ï¼Œæ–°å¢10ä¸ªé—®é¢˜ç‚¹ |
| - | v1.0 | åˆå§‹ç‰ˆæœ¬ |

---

**æ³¨æ„**ï¼šæœ¬åˆ†æåŸºäºå½“å‰ä»£ç å®ç°ï¼Œå»ºè®®å®šæœŸå®¡æŸ¥å’Œæ›´æ–°ã€‚
