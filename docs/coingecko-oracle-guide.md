# ğŸ”® CoinGecko é¢„è¨€æœºç³»ç»Ÿä½¿ç”¨æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬ç³»ç»Ÿå®ç°äº†åŸºäº CoinGecko API çš„å®Œæ•´é¢„è¨€æœºè§£å†³æ–¹æ¡ˆï¼Œæ”¯æŒé“¾ä¸‹ä»·æ ¼æ³¨å…¥å’Œé“¾ä¸Šæ¸…ç®—æ‰§è¡Œï¼Œå®Œå…¨ç¬¦åˆ `docs/oracle-system.md` çš„è¦æ±‚ã€‚

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CoinGecko     â”‚    â”‚  Keeper Bot      â”‚    â”‚   Blockchain    â”‚
â”‚     API         â”‚â”€â”€â”€â–¶â”‚  (é“¾ä¸‹è„šæœ¬)       â”‚â”€â”€â”€â–¶â”‚   (é“¾ä¸Šåˆçº¦)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚                        â”‚
                              â–¼                        â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚ PriceUpdater     â”‚    â”‚ PriceOracle     â”‚
                       â”‚ (ä»·æ ¼æ›´æ–°å™¨)      â”‚    â”‚ (é¢„è¨€æœºåˆçº¦)     â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. éƒ¨ç½²é¢„è¨€æœºç³»ç»Ÿ

```bash
# éƒ¨ç½²é¢„è¨€æœºåˆçº¦
npm run deploy:oracle

# æµ‹è¯•é¢„è¨€æœºç³»ç»Ÿ
npm run test:oracle
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

åœ¨ `.env` æ–‡ä»¶ä¸­æ·»åŠ ï¼š

```env
PRICE_ORACLE_ADDRESS=0x...  # éƒ¨ç½²åçš„ PriceOracle åœ°å€
PRICE_UPDATER_ADDRESS=0x... # éƒ¨ç½²åçš„ CoinGeckoPriceUpdater åœ°å€
PRIVATE_KEY=0x...           # ç”¨äºç­¾åçš„ç§é’¥
```

### 3. å¯åŠ¨ Keeper Bot

```bash
# å¯åŠ¨æŒç»­ç›‘æ§
npm run keeper:start

# æ‰‹åŠ¨æ›´æ–°å•ä¸ªèµ„äº§ä»·æ ¼
npm run keeper:update 0x0000000000000000000000000000000000000000 50000000000 1703123456

# æŸ¥çœ‹èµ„äº§ä¿¡æ¯
npm run keeper:info 0x0000000000000000000000000000000000000000

# æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
npm run keeper:check 0x0000000000000000000000000000000000000000
```

## ğŸ“Š æ ¸å¿ƒåˆçº¦

### 1. PriceOracle.sol

**åŠŸèƒ½**: æ ¸å¿ƒé¢„è¨€æœºåˆçº¦ï¼Œå­˜å‚¨å’Œç®¡ç†ä»·æ ¼æ•°æ®

**ä¸»è¦ç‰¹æ€§**:
- âœ… æ”¯æŒå¤šèµ„äº§ä»·æ ¼ç®¡ç†
- âœ… ä»·æ ¼æœ‰æ•ˆæ€§éªŒè¯
- âœ… æƒé™æ§åˆ¶ (ç®¡ç†å‘˜ + ä»·æ ¼æ›´æ–°è€…)
- âœ… å¯å‡çº§æ¶æ„
- âœ… å®Œæ•´äº‹ä»¶è®°å½•

**å…³é”®å‡½æ•°**:
```solidity
// è·å–ä»·æ ¼
function getPrice(address asset) external view returns (uint256 price, uint256 timestamp, uint256 decimals)

// æ›´æ–°ä»·æ ¼ (ä»…ä»·æ ¼æ›´æ–°è€…)
function updatePrice(address asset, uint256 price, uint256 timestamp) external onlyRole(PRICE_UPDATER_ROLE)

// é…ç½®èµ„äº§
function configureAsset(address asset, string calldata coingeckoId, uint256 decimals, uint256 maxPriceAge) external onlyRole(DEFAULT_ADMIN_ROLE)
```

### 2. CoinGeckoPriceUpdater.sol

**åŠŸèƒ½**: ä»·æ ¼æ›´æ–°å™¨ï¼Œè¿æ¥ CoinGecko API å’Œé¢„è¨€æœº

**ä¸»è¦ç‰¹æ€§**:
- âœ… CoinGecko ID æ˜ å°„ç®¡ç†
- âœ… ä»·æ ¼éªŒè¯å’Œç¼“å­˜
- âœ… æ‰¹é‡æ›´æ–°æ”¯æŒ
- âœ… å¤±è´¥é‡è¯•æœºåˆ¶
- âœ… è‡ªåŠ¨æ›´æ–°æ§åˆ¶

**å…³é”®å‡½æ•°**:
```solidity
// æ›´æ–°å•ä¸ªèµ„äº§ä»·æ ¼
function updateAssetPrice(address asset, uint256 price, uint256 timestamp) external onlyRole(PRICE_UPDATER_ROLE)

// æ‰¹é‡æ›´æ–°ä»·æ ¼
function updateAssetPrices(address[] calldata assets, uint256[] calldata prices, uint256[] calldata timestamps) external onlyRole(PRICE_UPDATER_ROLE)

// é…ç½®èµ„äº§
function configureAsset(address asset, string calldata coingeckoId) external onlyRole(DEFAULT_ADMIN_ROLE)
```

### 3. ValuationOracleAdapter.sol

**åŠŸèƒ½**: ç»Ÿä¸€ä»·æ ¼æŸ¥è¯¢é€‚é…å™¨ï¼Œæ”¯æŒå¤šé‡é¢„è¨€æœº

**ä¸»è¦ç‰¹æ€§**:
- âœ… å¤šé‡é¢„è¨€æœºæ”¯æŒ
- âœ… ä»·æ ¼ç¼“å­˜æœºåˆ¶
- âœ… ç»Ÿä¸€æŸ¥è¯¢æ¥å£
- âœ… æ•…éšœè½¬ç§»æœºåˆ¶

## ğŸ”§ é…ç½®è¯´æ˜

### é»˜è®¤èµ„äº§é…ç½®

ç³»ç»Ÿé¢„é…ç½®äº†ä»¥ä¸‹èµ„äº§ï¼š

| èµ„äº§ | åœ°å€ | CoinGecko ID | ç²¾åº¦ |
|------|------|--------------|------|
| ETH | 0x0000...0000 | ethereum | 18 |
| WBTC | 0x2260...599 | wrapped-bitcoin | 8 |
| USDC | 0xA0b8...C8C8 | usd-coin | 6 |

### ä»·æ ¼æ›´æ–°å‚æ•°

- **æ›´æ–°é—´éš”**: 5åˆ†é’Ÿ (300ç§’)
- **ä»·æ ¼ç²¾åº¦**: 8ä½å°æ•°
- **æœ€å¤§ä»·æ ¼å¹´é¾„**: 1å°æ—¶ (3600ç§’)
- **ä»·æ ¼åå·®é˜ˆå€¼**: 10% (é˜²æ­¢å¼‚å¸¸ä»·æ ¼)

## ğŸ“ˆ ä½¿ç”¨æµç¨‹

### 1. éƒ¨ç½²é˜¶æ®µ

```bash
# 1. ç¼–è¯‘åˆçº¦
npm run compile

# 2. éƒ¨ç½²é¢„è¨€æœºç³»ç»Ÿ
npm run deploy:oracle

# 3. æµ‹è¯•ç³»ç»ŸåŠŸèƒ½
npm run test:oracle
```

### 2. é…ç½®é˜¶æ®µ

```bash
# 1. è®¾ç½®ç¯å¢ƒå˜é‡
echo "PRICE_ORACLE_ADDRESS=0x..." >> .env
echo "PRICE_UPDATER_ADDRESS=0x..." >> .env

# 2. é…ç½®èµ„äº§ (é€šè¿‡åˆçº¦è°ƒç”¨)
# ä½¿ç”¨ configureAsset å‡½æ•°é…ç½®æ”¯æŒçš„èµ„äº§
```

### 3. è¿è¡Œé˜¶æ®µ

```bash
# å¯åŠ¨ Keeper Bot
npm run keeper:start

# ç›‘æ§æ—¥å¿—è¾“å‡º
# ç³»ç»Ÿä¼šè‡ªåŠ¨ä» CoinGecko è·å–ä»·æ ¼å¹¶æ›´æ–°é¢„è¨€æœº
```

## ğŸ” ç›‘æ§å’Œè°ƒè¯•

### 1. æŸ¥çœ‹ä»·æ ¼æ•°æ®

```solidity
// è·å–å•ä¸ªèµ„äº§ä»·æ ¼
const priceData = await priceOracle.getPrice(assetAddress);
console.log(`ä»·æ ¼: $${priceData.price / 100000000}`);

// æ£€æŸ¥ä»·æ ¼æœ‰æ•ˆæ€§
const isValid = await priceOracle.isPriceValid(assetAddress);
console.log(`ä»·æ ¼æœ‰æ•ˆ: ${isValid}`);
```

### 2. æŸ¥çœ‹æ›´æ–°çŠ¶æ€

```solidity
// æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
const needsUpdate = await priceUpdater.needsUpdate(assetAddress);
console.log(`éœ€è¦æ›´æ–°: ${needsUpdate}`);

// è·å–èµ„äº§ä¿¡æ¯
const info = await priceUpdater.getAssetInfo(assetAddress);
console.log(`CoinGecko ID: ${info.coingeckoId}`);
console.log(`æœ€åæ›´æ–°: ${new Date(info.lastUpdate * 1000)}`);
```

### 3. äº‹ä»¶ç›‘å¬

ç³»ç»Ÿä¼šå‘å‡ºä»¥ä¸‹äº‹ä»¶ï¼š

```solidity
// ä»·æ ¼æ›´æ–°æˆåŠŸ
event PriceUpdateSuccess(address indexed asset, string indexed coingeckoId, uint256 price, uint256 timestamp);

// ä»·æ ¼æ›´æ–°å¤±è´¥
event PriceUpdateFailure(address indexed asset, string indexed coingeckoId, string reason);

// ä»·æ ¼éªŒè¯å¤±è´¥
event PriceValidationFailure(address indexed asset, uint256 price, string reason);
```

## ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§

### 1. æƒé™æ§åˆ¶

- **ç®¡ç†å‘˜**: é…ç½®èµ„äº§ã€å‡çº§åˆçº¦
- **ä»·æ ¼æ›´æ–°è€…**: æ›´æ–°ä»·æ ¼æ•°æ®
- **æ²»ç†è§’è‰²**: ç®¡ç†é¢„è¨€æœºå‚æ•°

### 2. ä»·æ ¼éªŒè¯

- **åå·®æ£€æŸ¥**: é˜²æ­¢ä»·æ ¼å¼‚å¸¸æ³¢åŠ¨
- **æ—¶é—´æˆ³éªŒè¯**: ç¡®ä¿ä»·æ ¼æ—¶æ•ˆæ€§
- **é›¶ä»·æ ¼ä¿æŠ¤**: æ‹’ç»æ— æ•ˆä»·æ ¼

### 3. æ•…éšœå¤„ç†

- **é‡è¯•æœºåˆ¶**: è‡ªåŠ¨é‡è¯•å¤±è´¥çš„æ›´æ–°
- **é™çº§æ¨¡å¼**: é¢„è¨€æœºæ•…éšœæ—¶çš„å¤‡ç”¨æ–¹æ¡ˆ
- **äº‹ä»¶è®°å½•**: å®Œæ•´çš„æ“ä½œæ—¥å¿—

## ğŸ”§ é«˜çº§é…ç½®

### 1. è‡ªå®šä¹‰èµ„äº§

```solidity
// æ·»åŠ æ–°èµ„äº§
await priceUpdater.configureAsset(
    "0x1234...5678",  // èµ„äº§åœ°å€
    "bitcoin"          // CoinGecko ID
);
```

### 2. è°ƒæ•´æ›´æ–°å‚æ•°

```solidity
// ä¿®æ”¹æ›´æ–°é—´éš” (éœ€è¦é‡æ–°éƒ¨ç½²)
uint256 public constant UPDATE_INTERVAL = 600; // 10åˆ†é’Ÿ

// ä¿®æ”¹ä»·æ ¼åå·®é˜ˆå€¼
uint256 public constant MAX_PRICE_DEVIATION = 500; // 5%
```

### 3. å¤šé¢„è¨€æœºæ”¯æŒ

```solidity
// ä¸ºç‰¹å®šèµ„äº§è®¾ç½®ä¸“ç”¨é¢„è¨€æœº
await priceUpdater.setOracle(assetAddress, oracleAddress);
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. Gas ä¼˜åŒ–

- **æ‰¹é‡æ›´æ–°**: ä¸€æ¬¡äº¤æ˜“æ›´æ–°å¤šä¸ªèµ„äº§
- **ç¼“å­˜æœºåˆ¶**: å‡å°‘é‡å¤æŸ¥è¯¢
- **äº‹ä»¶ä¼˜åŒ–**: æœ€å°åŒ–äº‹ä»¶æ•°æ®

### 2. ç½‘ç»œä¼˜åŒ–

- **API é™æµ**: éµå®ˆ CoinGecko API é™åˆ¶
- **é”™è¯¯é‡è¯•**: æ™ºèƒ½é‡è¯•æœºåˆ¶
- **è¿æ¥æ± **: å¤ç”¨ HTTP è¿æ¥

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **ä»·æ ¼æ›´æ–°å¤±è´¥**
   - æ£€æŸ¥ç½‘ç»œè¿æ¥
   - éªŒè¯ API å¯†é’¥
   - ç¡®è®¤èµ„äº§é…ç½®

2. **æƒé™é”™è¯¯**
   - ç¡®è®¤è´¦æˆ·è§’è‰²
   - æ£€æŸ¥åˆçº¦æƒé™è®¾ç½®

3. **ä»·æ ¼éªŒè¯å¤±è´¥**
   - æ£€æŸ¥ä»·æ ¼åå·®è®¾ç½®
   - éªŒè¯æ—¶é—´æˆ³

### è°ƒè¯•å‘½ä»¤

```bash
# æŸ¥çœ‹åˆçº¦çŠ¶æ€
npm run test:oracle

# æ‰‹åŠ¨æ›´æ–°ä»·æ ¼
npm run keeper:update <asset> <price> <timestamp>

# æ£€æŸ¥æ›´æ–°éœ€æ±‚
npm run keeper:check <asset>
```

## ğŸ“ˆ æ‰©å±•åŠŸèƒ½

### 1. å¤šæ•°æ®æºæ”¯æŒ

å¯ä»¥æ‰©å±•æ”¯æŒå…¶ä»–ä»·æ ¼æ•°æ®æºï¼š
- CoinMarketCap API
- Binance API
- Chainlink Price Feeds

### 2. é«˜çº§ç›‘æ§

- ä»·æ ¼å¼‚å¸¸å‘Šè­¦
- è‡ªåŠ¨æ¸…ç®—è§¦å‘
- æ€§èƒ½æŒ‡æ ‡ç›‘æ§

### 3. æ²»ç†åŠŸèƒ½

- å‚æ•°æŠ•ç¥¨æœºåˆ¶
- ç´§æ€¥æš‚åœåŠŸèƒ½
- å¤šç­¾ç®¡ç†

---

## ğŸ¯ æ€»ç»“

æœ¬ CoinGecko é¢„è¨€æœºç³»ç»Ÿå®Œå…¨å®ç°äº†æ–‡æ¡£è¦æ±‚çš„åŠŸèƒ½ï¼š

âœ… **é“¾ä¸‹ä»·æ ¼æ³¨å…¥**: Keeper Bot ä» CoinGecko API è·å–ä»·æ ¼  
âœ… **é“¾ä¸Šæ¸…ç®—æ‰§è¡Œ**: é¢„è¨€æœºåˆçº¦æä¾›å¯é çš„ä»·æ ¼æ•°æ®  
âœ… **Gas ä¼˜åŒ–**: æ‰¹é‡æ›´æ–°å’Œç¼“å­˜æœºåˆ¶  
âœ… **å®‰å…¨æ€§**: å®Œæ•´çš„æƒé™æ§åˆ¶å’Œä»·æ ¼éªŒè¯  
âœ… **å¯æ‰©å±•æ€§**: æ”¯æŒå¤šèµ„äº§å’Œå¤šé¢„è¨€æœº  
âœ… **ç›‘æ§æ€§**: å®Œæ•´çš„äº‹ä»¶è®°å½•å’ŒçŠ¶æ€æŸ¥è¯¢  

ç³»ç»Ÿå·²å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥ç«‹å³éƒ¨ç½²å’Œä½¿ç”¨ï¼ 