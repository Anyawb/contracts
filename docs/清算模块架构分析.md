# æ¸…ç®—æ¨¡å—æ¶æ„åˆ†æä¸é“¾ä¸Šè¿è¡Œæµç¨‹

## ğŸ“ æ–‡ä»¶ç»“æ„æ¦‚è§ˆ

æ¸…ç®—æ¨¡å—ä½äº `src/Vault/liquidation/`ï¼Œé‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œåˆ†ä¸ºä¸‰ä¸ªä¸»è¦ç›®å½•ï¼š

```
src/Vault/liquidation/
â”œâ”€â”€ types/                          # ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ LiquidationTypes.sol       # æ¸…ç®—ç›¸å…³ç±»å‹ã€äº‹ä»¶ã€å¸¸é‡å®šä¹‰
â”‚   â””â”€â”€ [REMOVED] LiquidationBase.sol  # å·²ç§»é™¤ï¼šå†å²é—ç•™â€œoracle/settlementToken/vaultStorage + safeCall*â€åº•åº§ï¼Œæ˜“å¯¼è‡´ä¼°å€¼è·¯å¾„åˆ†å‰
â”‚
â”œâ”€â”€ libraries/                      # åŠŸèƒ½åº“ï¼ˆå½“å‰å®ç°ï¼š5 ä¸ªï¼‰
â”‚   â”œâ”€â”€ LiquidationAccessControl.sol        # æƒé™æ§åˆ¶ï¼ˆACM ç»Ÿä¸€æƒé™ï¼‰
â”‚   â”œâ”€â”€ LiquidationValidationLibrary.sol    # å‚æ•°/æ•°ç»„æ ¡éªŒï¼ˆæ— ä¸šåŠ¡å£å¾„ï¼‰
â”‚   â”œâ”€â”€ LiquidationRiskLib.sol              # é£é™©/å¥åº·å› å­æ ¸å¿ƒè®¡ç®—ï¼ˆbps å£å¾„ï¼‰
â”‚   â”œâ”€â”€ LiquidationRiskQueryLib.sol         # é£é™©æŸ¥è¯¢èšåˆï¼ˆä» View/LE/CM best-effort æ‹‰å–ï¼‰
â”‚   â””â”€â”€ ModuleCache.sol                     # Registry æ¨¡å—åœ°å€ç¼“å­˜ï¼ˆA-class cacheï¼‰
â”‚
â””â”€â”€ modules/                        # æ ¸å¿ƒæ¨¡å—ï¼ˆå½“å‰å®ç°ï¼š7 ä¸ªï¼‰
    â”œâ”€â”€ SettlementManager.sol               # â­ å”¯ä¸€å¯¹å¤–å†™å…¥å£ï¼ˆSSOTï¼‰ï¼šç»“ç®—/æ¸…ç®—çŠ¶æ€æœº
    â”œâ”€â”€ LiquidationManager.sol              # â­ æ¸…ç®—æ‰§è¡Œå™¨ï¼ˆå†…éƒ¨è¢« SettlementManager è°ƒç”¨ï¼›ä¹Ÿä¿ç•™æ˜¾å¼å‚æ•°åº”æ€¥å…¥å£ï¼‰
    â”œâ”€â”€ LiquidationRiskManager.sol          # é£æ§åªè¯»èšåˆ/ç¼“å­˜ï¼ˆå¥åº·å› å­ã€é£é™©åˆ†æ•° 0-100ï¼‰
    â”œâ”€â”€ LiquidationCalculator.sol           # æ¸…ç®—è®¡ç®—/é¢„è§ˆï¼ˆåªè¯»ï¼‰
    â”œâ”€â”€ LiquidationConfigManager.sol        # é…ç½®åŸºç±»ï¼ˆmodule cache + access control + refreshï¼‰
    â”œâ”€â”€ LiquidationConfigModule.sol         # é…ç½® SSOTï¼šé˜ˆå€¼/æœ€å°å¥åº·å› å­ç­‰å‚æ•°
    â””â”€â”€ LiquidationPayoutManager.sol        # æ®‹å€¼åˆ†é… SSOTï¼šrecipients/rates & åˆ†è´¦è®¡ç®—
```

---

## ğŸ—ï¸ æ ¸å¿ƒæ¶æ„è®¾è®¡

### 1. æ¶æ„æ¨¡å¼ï¼š**ç›´è¾¾è´¦æœ¬ + å•ç‚¹æ¨é€**

æ ¹æ®æ¶æ„æŒ‡å—ï¼Œå½“å‰å®ç°é‡‡ç”¨**æ–¹æ¡ˆA**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             æ¸…ç®—ç³»ç»Ÿæ¶æ„ï¼ˆç›´è¾¾è´¦æœ¬æ¨¡å¼ï¼‰                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Registryï¼ˆæ¨¡å—æ³¨å†Œä¸­å¿ƒï¼‰
â”œâ”€â”€ KEY_SETTLEMENT_MANAGER â†’ SettlementManagerï¼ˆå”¯ä¸€å¯¹å¤–å†™å…¥å£ï¼ŒSSOTï¼Œè§ Architecture-Guide.mdï¼‰
â”œâ”€â”€ KEY_LIQUIDATION_MANAGER â†’ LiquidationManagerï¼ˆæ¸…ç®—æ‰§è¡Œå™¨ï¼šç”± SettlementManager åœ¨æ¸…ç®—åˆ†æ”¯å†…éƒ¨è°ƒç”¨ï¼‰
â”œâ”€â”€ KEY_CM â†’ CollateralManagerï¼ˆæŠµæŠ¼ç‰©æ‰˜ç®¡ï¼‰
â”œâ”€â”€ KEY_LE â†’ LendingEngineï¼ˆå€ºåŠ¡æ‰˜ç®¡ï¼‰
â”œâ”€â”€ KEY_LIQUIDATION_VIEW â†’ LiquidatorViewï¼ˆåªè¯»/äº‹ä»¶æŸ¥è¯¢ + DataPush å•ç‚¹ï¼‰
â”œâ”€â”€ KEY_HEALTH_VIEW â†’ HealthViewï¼ˆå¥åº·å› å­ç¼“å­˜ï¼‰
â””â”€â”€ KEY_LIQUIDATION_RISK_MANAGER â†’ LiquidationRiskManagerï¼ˆé£é™©è¯„ä¼°ï¼‰

å†™è·¯å¾„æµç¨‹ï¼ˆå¯¹é½ Architecture-Guide.mdï¼šå”¯ä¸€å¯¹å¤–å†™å…¥å£ä¸º SettlementManagerï¼‰ï¼š
ã€Keeper/æœºå™¨äººå…¥å£ï¼ˆSSOTï¼‰ã€‘SettlementManager.settleOrLiquidate(orderId)
  â””â”€â†’ ã€å†…éƒ¨æ¸…ç®—åˆ†æ”¯ã€‘LiquidationManager.liquidateFromSettlementManager()
  â”œâ”€â†’ CM.withdrawCollateralTo()      [ç›´è¾¾è´¦æœ¬ï¼šæ‰£æŠ¼æŠµæŠ¼]
  â”œâ”€â†’ LE.forceReduceDebt()            [ç›´è¾¾è´¦æœ¬ï¼šå‡å°‘å€ºåŠ¡]
  â””â”€â†’ LiquidatorView.pushLiquidationUpdate()  [å•ç‚¹æ¨é€ï¼šæœ€ä½³åŠªåŠ›]

ã€ç”¨æˆ·å…¥å£ã€‘SettlementManager.repayAndSettle(user, debtAsset, repayAmount, orderId)
  â””â”€â†’ ç»“ç®—åˆ†æ”¯æˆ–æ¸…ç®—åˆ†æ”¯ï¼ˆæ ¹æ®è®¢å•çŠ¶æ€è‡ªåŠ¨åˆ¤å®šï¼‰
```

### 2. æ ¸å¿ƒæ¨¡å—èŒè´£

#### â­ **SettlementManager**ï¼ˆå”¯ä¸€å¯¹å¤–å†™å…¥å£ï¼ŒSSOTï¼‰
- **ä½ç½®**ï¼š`modules/SettlementManager.sol`
- **èŒè´£**ï¼š
  - å¯¹å¤–å”¯ä¸€å†™å…¥å£ï¼šç»Ÿä¸€æ‰¿æ¥ **è¿˜æ¬¾ç»“ç®—** ä¸ **è¢«åŠ¨æ¸…ç®—/å¼ºåˆ¶å¤„ç½®** åˆ†æ”¯ï¼ˆçŠ¶æ€æœºï¼‰
  - keeper æ¨èå…¥å£ï¼š`settleOrLiquidate(orderId)`ï¼ˆå†…éƒ¨è‡ªåŠ¨è®¡ç®—æ¸…ç®—å‚æ•°ï¼Œé¿å…â€œå‚æ•°è®¡ç®—/æƒé™/èµ„é‡‘å»å‘â€åˆ†å‰ï¼‰
  - ç”¨æˆ·è¿˜æ¬¾å…¥å£ï¼ˆç”± `VaultCore` ä»£ç†è°ƒç”¨ï¼‰ï¼š`repayAndSettle(user, debtAsset, repayAmount, orderId)`
  - æ¸…ç®—åˆ†æ”¯ï¼šå¯å†…éƒ¨è°ƒç”¨ `LiquidationManager.liquidateFromSettlementManager(...)`ï¼ˆä¿ç•™ keeper ä½œä¸º liquidatorï¼‰

#### â­ **LiquidationManager**ï¼ˆæ¸…ç®—æ‰§è¡Œå™¨ï¼šå†…éƒ¨è°ƒç”¨ + æ˜¾å¼å‚æ•°åº”æ€¥å…¥å£ï¼‰
- **ä½ç½®**ï¼š`modules/LiquidationManager.sol`
- **èŒè´£**ï¼š
  - æ¸…ç®—æ‰§è¡Œï¼š**ç›´è¾¾è´¦æœ¬å†™å…¥**ï¼ˆ`KEY_CM.withdrawCollateralTo` æ‰£æŠ¼/åˆ†é…ï¼›`KEY_LE.forceReduceDebt` å‡å€ºï¼‰
  - æ®‹å€¼åˆ†é… SSOTï¼šé€šè¿‡ `KEY_LIQUIDATION_PAYOUT_MANAGER â†’ LiquidationPayoutManager` è¯»å– recipients/rates å¹¶è®¡ç®— shares
  - å•ç‚¹æ¨é€ï¼šbest-effort è°ƒç”¨ `KEY_LIQUIDATION_VIEW â†’ LiquidatorView.push*`ï¼›å¤±è´¥å‘ `CacheUpdateFailed`ï¼Œä¸å›æ»šè´¦æœ¬å†™å…¥
  - å…¥å£å®šä½ï¼š`liquidate/batchLiquidate` ä¸º role-gated æ˜¾å¼å‚æ•°å…¥å£ï¼ˆæµ‹è¯•/åº”æ€¥/æ‰‹å·¥å¤„ç½®ï¼‰

#### **LiquidationRiskManager**ï¼ˆé£æ§åªè¯»èšåˆ/ç¼“å­˜ï¼‰
- **ä½ç½®**ï¼š`modules/LiquidationRiskManager.sol`
- **èŒè´£**ï¼š
  - é£é™©è¯„ä¼°ï¼šå¥åº·å› å­ï¼ˆbpsï¼‰ã€é£é™©åˆ†æ•°ï¼ˆ0-100ï¼‰ã€æ˜¯å¦å¯æ¸…ç®—
  - æ‰¹é‡æŸ¥è¯¢ï¼šå— `maxBatchSizeVar` çº¦æŸï¼Œé¿å… DoS
  - å£å¾„ç»Ÿä¸€ï¼šæ ¸å¿ƒè®¡ç®—å§”æ‰˜ `LiquidationRiskLib`ï¼›å–å€¼èšåˆå§”æ‰˜ `LiquidationRiskQueryLib`ï¼ˆä¸ç›´æ¥è®¿é—® Oracle/GDï¼‰

#### **LiquidationCalculator**ï¼ˆåªè¯»è®¡ç®—/é¢„è§ˆï¼‰
- **ä½ç½®**ï¼š`modules/LiquidationCalculator.sol`
- **èŒè´£**ï¼šæä¾›åªè¯»é¢„è§ˆä¸æ´¾ç”Ÿè®¡ç®—ï¼ˆå¯¹é½ `LiquidationRiskLib` çš„ bps/0-100 å£å¾„ï¼‰ï¼Œä¸æ‰¿è½½å†™å…¥æ”¾è¡Œã€‚

#### **LiquidationConfigModule**ï¼ˆæ¸…ç®—é…ç½® SSOTï¼‰
- **ä½ç½®**ï¼š`modules/LiquidationConfigModule.sol`
- **èŒè´£**ï¼šé˜ˆå€¼/æœ€å°å¥åº·å› å­ç­‰å‚æ•°çš„å”¯ä¸€æƒå¨å†™å…¥ä¸äº‹ä»¶ï¼ˆç”± `LiquidationRiskManager` é€ä¼ è¯»å–ï¼‰ã€‚

#### **LiquidationPayoutManager**ï¼ˆæ®‹å€¼åˆ†é… SSOTï¼‰
- **ä½ç½®**ï¼š`modules/LiquidationPayoutManager.sol`
- **èŒè´£**ï¼šæ®‹å€¼ recipients/rates é…ç½® + shares è®¡ç®—ï¼›ä¾› `LiquidationManager` æ‰§è¡Œæ‰£æŠ¼ååˆ†é…ä½¿ç”¨ã€‚

---

## ğŸ”„ é“¾ä¸Šè¿è¡Œæµç¨‹

### é˜¶æ®µ1ï¼šéƒ¨ç½²ä¸åˆå§‹åŒ–

#### 1.1 éƒ¨ç½²é¡ºåºï¼ˆå‚è€ƒ `scripts/deploy/deploylocal.ts`ï¼‰

å»ºè®®ä»¥éƒ¨ç½²è„šæœ¬ä¸ºå‡†ï¼ˆæœ¬èŠ‚åªç»™å‡ºâ€œæ¨¡å—ä¸æƒé™â€é¡ºåºå£å¾„ï¼‰ï¼š

- **Registry/ACM**ï¼šå…ˆéƒ¨ç½²å¹¶é…ç½®åŸºç¡€æ²»ç†ä¸æƒé™ï¼ˆ`ActionKeys`ï¼‰ã€‚
- **Payout SSOT**ï¼šéƒ¨ç½²å¹¶æ³¨å†Œ `LiquidationPayoutManager`ï¼ˆ`ModuleKeys.KEY_LIQUIDATION_PAYOUT_MANAGER`ï¼‰ã€‚
- **æ¸…ç®—æ‰§è¡Œå™¨**ï¼šéƒ¨ç½²å¹¶æ³¨å†Œ `LiquidationManager`ï¼ˆ`ModuleKeys.KEY_LIQUIDATION_MANAGER`ï¼‰ã€‚
- **é£æ§åªè¯»**ï¼šéƒ¨ç½²å¹¶æ³¨å†Œ `LiquidationRiskManager`ï¼ˆ`ModuleKeys.KEY_LIQUIDATION_RISK_MANAGER`ï¼‰ã€‚
- **æ¸…ç®—é…ç½® SSOT**ï¼šéƒ¨ç½²å¹¶æ³¨å†Œ `LiquidationConfigModule`ï¼ˆç”± `LiquidationConfigManager` åŸºç±»æ‰¿è½½ç¼“å­˜/åˆ·æ–°èƒ½åŠ›ï¼‰ã€‚
- **å”¯ä¸€å¯¹å¤–å†™å…¥å£ï¼ˆSSOTï¼‰**ï¼šéƒ¨ç½²å¹¶æ³¨å†Œ `SettlementManager`ï¼ˆ`ModuleKeys.KEY_SETTLEMENT_MANAGER`ï¼‰ã€‚
- **å•ç‚¹æ¨é€/View**ï¼šéƒ¨ç½²å¹¶æ³¨å†Œ `LiquidatorView`ï¼ˆ`ModuleKeys.KEY_LIQUIDATION_VIEW`ï¼‰ã€‚

#### 1.2 æ¨¡å—æ³¨å†Œï¼ˆRegistryï¼‰

æ‰€æœ‰æ¸…ç®—ç›¸å…³æ¨¡å—é€šè¿‡ `ModuleKeys` æ³¨å†Œï¼š

- **å…¥å£/æ‰§è¡Œå™¨/æ¨é€**
  - `KEY_SETTLEMENT_MANAGER` â†’ `SettlementManager`ï¼ˆå”¯ä¸€å¯¹å¤–å†™å…¥å£ï¼ŒSSOTï¼‰
  - `KEY_LIQUIDATION_MANAGER` â†’ `LiquidationManager`ï¼ˆæ¸…ç®—æ‰§è¡Œå™¨ï¼‰
  - `KEY_LIQUIDATION_PAYOUT_MANAGER` â†’ `LiquidationPayoutManager`ï¼ˆæ®‹å€¼åˆ†é… SSOTï¼‰
  - `KEY_LIQUIDATION_VIEW` â†’ `LiquidatorView`ï¼ˆDataPush å•ç‚¹ï¼‰
  - `KEY_LIQUIDATION_RISK_MANAGER` â†’ `LiquidationRiskManager`ï¼ˆé£æ§åªè¯»ï¼‰
- **è´¦æœ¬/ä¼°å€¼/å¥åº·**
  - `KEY_CM` â†’ `CollateralManager`
  - `KEY_LE` â†’ `VaultLendingEngine`ï¼ˆæˆ– `LendingEngine`ï¼‰
  - `KEY_POSITION_VIEW` â†’ `PositionView`ï¼ˆä¼°å€¼ SSOTï¼‰
  - `KEY_HEALTH_VIEW` â†’ `HealthView`ï¼ˆç¼“å­˜/æ¨é€ï¼‰
- **ç”¨æˆ·/keeper å…¥å£**
  - `KEY_VAULT_CORE` â†’ `VaultCore`ï¼ˆç”¨æˆ·ä¾§ç»Ÿä¸€å…¥å£ï¼‰
  - `KEY_ORDER_ENGINE` â†’ `OrderEngine`ï¼ˆorderId ä¸»é”®è¯»å–/è¿˜æ¬¾ï¼‰

---

### é˜¶æ®µ2ï¼šæ¸…ç®—æ‰§è¡Œæµç¨‹

#### 2.1 æ¸…ç®—å‰å‡†å¤‡ï¼ˆé“¾ä¸‹/åªè¯»ï¼‰

```solidity
// 1. æŸ¥è¯¢å¥åº·å› å­ï¼ˆé€šè¿‡ LiquidationRiskManager æˆ– HealthViewï¼‰
LiquidationRiskManager.assessLiquidationRisk(user) 
  â†’ returns (LiquidationRiskAssessment)

// 2. è®¡ç®—æ¸…ç®—å‚æ•°ï¼ˆé“¾ä¸‹è®¡ç®—ï¼‰
// - collateralAmount: å¯æ¸…ç®—æŠµæŠ¼ç‰©æ•°é‡
// - debtAmount: å¯æ¸…ç®—å€ºåŠ¡æ•°é‡
// - bonus: æ¸…ç®—å¥–åŠ±ï¼ˆç”± keeper è®¡ç®—ï¼‰
```

#### 2.2 æ¸…ç®—æ‰§è¡Œï¼ˆå†™è·¯å¾„ï¼‰

> âš ï¸ **é‡è¦**ï¼šæ ¹æ® Architecture-Guide.md è¦æ±‚ï¼Œ**keeper/æœºå™¨äººçš„ä¸»å…¥å£å¿…é¡»æ˜¯ `SettlementManager.settleOrLiquidate(orderId)`**ï¼Œè€Œä¸æ˜¯ç›´æ¥è°ƒç”¨ `LiquidationManager.liquidate`ã€‚

```solidity
// ã€æ¨èã€‘Keeper/æœºå™¨äººå…¥å£ï¼ˆSSOTï¼Œç»Ÿä¸€å…¥å£ï¼‰
SettlementManager.settleOrLiquidate(orderId)
  // SettlementManager å†…éƒ¨ä¼šè‡ªåŠ¨ï¼š
  // 1. è¯»å–è®¢å•çŠ¶æ€ï¼ˆåˆ°æœŸã€å¥åº·å› å­ç­‰ï¼‰
  // 2. åˆ¤å®šæ˜¯å¦å¯æ¸…ç®—
  // 3. è®¡ç®—æ¸…ç®—å‚æ•°ï¼ˆé€‰æ‹©æœ€é«˜ä»·å€¼æŠµæŠ¼èµ„äº§ã€è®¡ç®—æ‰€éœ€æŠµæŠ¼æ•°é‡ï¼‰
  // 4. è°ƒç”¨ LiquidationManager.liquidateFromSettlementManager() æ‰§è¡Œæ¸…ç®—

// ã€å…¼å®¹/æµ‹è¯•/åº”æ€¥ã€‘æ˜¾å¼å‚æ•°æ¸…ç®—æ‰§è¡Œå™¨å…¥å£ï¼ˆrole-gatedï¼Œä¸å»ºè®®ä½œä¸ºå¸¸æ€å…¥å£ï¼‰
// ä»…ç”¨äºæµ‹è¯•ã€åº”æ€¥æˆ–æ‰‹å·¥æ¸…ç®—åœºæ™¯ï¼Œéœ€è¦ ACTION_LIQUIDATE æƒé™
LiquidationManager.liquidate(
    targetUser,
    collateralAsset,
    debtAsset,
    collateralAmount,
    debtAmount,
    bonus
)
```

**SettlementManager.settleOrLiquidate(orderId) å†…éƒ¨æ‰§è¡Œæµç¨‹**ï¼š

```
1. æƒé™æ ¡éªŒ
   â””â”€> AccessControlManager.requireRole(ACTION_LIQUIDATE, msg.sender)
       â””â”€> æ£€æŸ¥è°ƒç”¨è€…ï¼ˆkeeper/æœºå™¨äººï¼‰æ˜¯å¦æœ‰æ¸…ç®—æƒé™

2. è®¢å•çŠ¶æ€è¯»å–ä¸åˆ¤å®š
   â””â”€> é€šè¿‡ orderId è¯»å–è®¢å•ä¿¡æ¯ï¼ˆborrower, debtAsset, maturity ç­‰ï¼‰
   â””â”€> åˆ¤å®šæ˜¯å¦å¯æ¸…ç®—ï¼š
       â”œâ”€> åˆ°æœŸæœªè¿˜ï¼ˆoverdueï¼‰
       â””â”€> æˆ–é£é™©å¯æ¸…ç®—ï¼ˆLiquidationRiskManager.isLiquidatableï¼‰

3. æ¸…ç®—å‚æ•°è®¡ç®—ï¼ˆSettlementManager å†…éƒ¨ï¼‰
   â””â”€> é€‰æ‹©æœ€é«˜ä»·å€¼æŠµæŠ¼èµ„äº§
   â””â”€> è®¡ç®—æ‰€éœ€æŠµæŠ¼æ•°é‡ï¼ˆåŸºäºå€ºåŠ¡ä»·å€¼ + æ¸…ç®—é˜ˆå€¼ï¼‰
   â””â”€> è®¡ç®—æ¸…ç®—å¥–åŠ±ï¼ˆbonusï¼‰

4. è°ƒç”¨æ¸…ç®—æ‰§è¡Œå™¨
   â””â”€> LiquidationManager.liquidateFromSettlementManager(
           msg.sender,  // ä¿ç•™ keeper åœ°å€ä½œä¸º liquidator
           targetUser,
           collateralAsset,
           debtAsset,
           collateralAmount,
           debtAmount,
           bonus
       )

5. æ¸…ç®—æ‰§è¡Œå™¨å†…éƒ¨æµç¨‹ï¼ˆLiquidationManagerï¼‰
   â”œâ”€> æƒé™æ ¡éªŒï¼ˆä»… SettlementManager å¯è°ƒç”¨ï¼‰
   â”œâ”€> æ‰£æŠ¼æŠµæŠ¼ç‰©ï¼ˆç›´è¾¾è´¦æœ¬ï¼‰
   â”‚   â””â”€> CollateralManager.withdrawCollateralTo(...)
   â”‚       â””â”€> å†…éƒ¨ä¼šæ ¡éªŒ ACTION_LIQUIDATE æƒé™
   â”œâ”€> å‡å°‘å€ºåŠ¡ï¼ˆç›´è¾¾è´¦æœ¬ï¼‰
   â”‚   â””â”€> LendingEngine.forceReduceDebt(...)
   â”‚       â””â”€> å†…éƒ¨ä¼šæ ¡éªŒ ACTION_LIQUIDATE æƒé™
   â””â”€> å•ç‚¹æ¨é€ï¼ˆæœ€ä½³åŠªåŠ›ï¼Œå¤±è´¥ä¸å›æ»šï¼‰
       â””â”€> LiquidatorView.pushLiquidationUpdate(...)
           â””â”€> å¦‚æœå¤±è´¥ï¼Œå‘å‡º CacheUpdateFailed äº‹ä»¶ä¾›é“¾ä¸‹é‡è¯•
```

#### 2.3 æ‰¹é‡æ¸…ç®—

```solidity
LiquidationManager.batchLiquidate(
    targetUsers[],
    collateralAssets[],
    debtAssets[],
    collateralAmounts[],
    debtAmounts[],
    bonuses[]
)
```

**æ‰¹é‡æµç¨‹**ï¼š
- å¾ªç¯æ‰§è¡Œå•ç¬”æ¸…ç®—é€»è¾‘ï¼ˆæ‰£æŠ¼ + å‡å€ºï¼‰
- æœ€åç»Ÿä¸€è°ƒç”¨ `LiquidatorView.pushBatchLiquidationUpdate()`

---

### é˜¶æ®µ3ï¼šäº‹ä»¶ä¸æ•°æ®æ¨é€

#### 3.1 äº‹ä»¶æµ

```solidity
// 1. è´¦æœ¬å±‚äº‹ä»¶ï¼ˆç”± CM/LE å‘å‡ºï¼‰
CollateralManager.CollateralWithdrawn(...)
LendingEngine.DebtReduced(...)

// 2. DataPushï¼ˆç”± LiquidatorView å•ç‚¹å‘å‡ºï¼‰
// DataPushLibrary._emitData(DATA_TYPE_LIQUIDATION_UPDATE / DATA_TYPE_LIQUIDATION_BATCH_UPDATE, ...)

// 3. å¤±è´¥äº‹ä»¶ï¼ˆå¦‚æœæ¨é€å¤±è´¥ï¼‰
LiquidationManager.CacheUpdateFailed(
    user, asset, viewAddr,
    collateral, debt, reason
)
```

#### 3.2 æ•°æ®æ¨é€æœºåˆ¶

- **æ¨é€ç›®æ ‡**: `LiquidatorView`ï¼ˆé€šè¿‡ `KEY_LIQUIDATION_VIEW` è·å–ï¼‰
- **æ¨é€æ–¹å¼**: 
  - å•ç¬”: `pushLiquidationUpdate()`
  - æ‰¹é‡: `pushBatchLiquidationUpdate()`
- **å®¹é”™æœºåˆ¶**: 
  - å¦‚æœ View åˆçº¦ä¸å­˜åœ¨æˆ–è°ƒç”¨å¤±è´¥ï¼Œå‘å‡º `CacheUpdateFailed` äº‹ä»¶
  - **ä¸å›æ»šè´¦æœ¬å†™å…¥**ï¼ˆbest-effort åŸåˆ™ï¼‰

---

## ğŸ” æƒé™æ§åˆ¶

### æƒé™é”®ï¼ˆActionKeysï¼‰

æœ¬ä»“åº“ç»Ÿä¸€ä»¥ `ActionKeys` å¸¸é‡ä¸ºå‡†ï¼ˆä¸è¦åœ¨æ–‡æ¡£é‡Œæ‰‹å†™ `keccak256(...)`ï¼Œé¿å…å£å¾„æ¼‚ç§»ï¼‰ï¼š

- `ActionKeys.ACTION_LIQUIDATE`ï¼škeeper/æœºå™¨äººè§¦å‘æ¸…ç®—åˆ†æ”¯ï¼ˆè°ƒç”¨ `SettlementManager.settleOrLiquidate`ï¼‰
- `ActionKeys.ACTION_UPGRADE_MODULE`ï¼šæ¨¡å—å‡çº§ï¼ˆUUPSï¼‰

### æƒé™æˆäºˆæµç¨‹

```solidity
// 1. æˆäºˆ SettlementManager æ¸…ç®—æƒé™ï¼ˆç”¨äºå†…éƒ¨è°ƒç”¨ LiquidationManager æ‰§è¡Œå™¨å…¥å£ï¼‰
AccessControlManager.grantRole(ActionKeys.ACTION_LIQUIDATE, SettlementManager)

// 2. æˆäºˆå¤–éƒ¨æ¸…ç®—äººï¼ˆkeeper/æœºå™¨äººï¼Œç”¨äºè°ƒç”¨ SettlementManager.settleOrLiquidateï¼‰
AccessControlManager.grantRole(ActionKeys.ACTION_LIQUIDATE, keeperAddress)

// 3. æ¸…ç®—æ—¶æ ¡éªŒï¼ˆSettlementManager.settleOrLiquidateï¼‰
SettlementManager.settleOrLiquidate(orderId)
  â†’ requireRole(ActionKeys.ACTION_LIQUIDATE, msg.sender)  // æ ¡éªŒ keeper æƒé™ï¼ˆACMï¼‰
  â†’ å†…éƒ¨è°ƒç”¨ LiquidationManager.liquidateFromSettlementManager()
     â†’ æ ¡éªŒ caller == SettlementManagerï¼ˆå†…éƒ¨æƒé™æ ¡éªŒï¼‰
```

---

## ğŸ“Š æ•°æ®æµä¸çŠ¶æ€å˜æ›´

### æ¸…ç®—å‰çŠ¶æ€

```
ç”¨æˆ·è´¦æˆ·çŠ¶æ€ï¼š
â”œâ”€â”€ CollateralManager: æŠµæŠ¼ç‰©ä½™é¢ = 100 USDC
â””â”€â”€ LendingEngine: å€ºåŠ¡ä½™é¢ = 60 USDC

å¥åº·å› å­ = (æŠµæŠ¼ç‰©ä»·å€¼ / å€ºåŠ¡ä»·å€¼) = 100/60 = 166.67% > 105%ï¼ˆå®‰å…¨ï¼‰
```

### æ¸…ç®—æ‰§è¡Œ

```
1. æ‰£æŠ¼æŠµæŠ¼ç‰©: 100 USDC â†’ æ¸…ç®—äºº
   CollateralManager.withdrawCollateralTo(user, USDC, 100, liquidator)
   
2. å‡å°‘å€ºåŠ¡: 60 USDC
   LendingEngine.forceReduceDebt(user, USDC, 60)
```

### æ¸…ç®—åçŠ¶æ€

```
ç”¨æˆ·è´¦æˆ·çŠ¶æ€ï¼š
â”œâ”€â”€ CollateralManager: æŠµæŠ¼ç‰©ä½™é¢ = 0 USDC
â””â”€â”€ LendingEngine: å€ºåŠ¡ä½™é¢ = 0 USDC

æ¸…ç®—äººè·å¾—: 100 USDCï¼ˆåŒ…å« bonusï¼‰
```

---

## ğŸ› ï¸ å…³é”®åº“æ–‡ä»¶è¯´æ˜

### [REMOVED] LiquidationCoreOperations.solï¼ˆæ—§æ¨¡å—æ—ï¼‰
- **çŠ¶æ€**ï¼šå·²ç§»é™¤
- **åŸå› **ï¼šæ—§æ¨¡å—æ—æŠŠâ€œå†™å…¥æ‰§è¡Œ/æŸ¥è¯¢é¢„è§ˆ/å£å¾„è®¡ç®—â€æ··åœ¨ä¸€èµ·ï¼Œå®¹æ˜“é€ æˆèŒè´£è¾¹ç•Œä¸å£å¾„åˆ†å‰ã€‚
- **æ›¿ä»£æ–¹æ¡ˆï¼ˆSSOTï¼‰**ï¼š
  - **å†™å…¥å…¥å£ï¼ˆSSOTï¼‰**ï¼š`SettlementManager`
  - **æ‰§è¡Œå™¨**ï¼š`LiquidationManager`ï¼ˆç›´è¾¾è´¦æœ¬å†™å…¥ + å•ç‚¹æ¨é€ï¼‰
  - **é£é™©è®¡ç®—ï¼ˆçº¯å‡½æ•°ï¼‰**ï¼š`LiquidationRiskLib`ï¼ˆå¥åº·å› å­ bpsã€é£é™©åˆ†æ•° 0-100ï¼‰
  - **åªè¯»èšåˆå–å€¼**ï¼š`LiquidationRiskQueryLib`ï¼ˆä» `KEY_LE` + `KEY_POSITION_VIEW` èšåˆå€ºåŠ¡/æŠµæŠ¼ä»·å€¼ï¼‰

### LiquidationRiskLib.sol
- **åŠŸèƒ½**: é£é™©è¯„ä¼°è®¡ç®—
- **åŒ…å«**: å¥åº·å› å­è®¡ç®—ã€é£é™©ç­‰çº§åˆ¤å®šã€å®‰å…¨è¾¹é™…è®¡ç®—

### LiquidationRiskQueryLib.sol
- **åŠŸèƒ½**ï¼šåªè¯»èšåˆå–å€¼
- **åŒ…å«**ï¼šä» `Registry` è§£æä¾èµ–æ¨¡å—å¹¶ best-effort æ‹‰å–ä¼°å€¼/å€ºåŠ¡æ•°æ®ï¼ˆä¸ç›´æ¥è®¿é—® Oracle/GDï¼‰

### ModuleCache.sol
- **åŠŸèƒ½**: æ¨¡å—åœ°å€ç¼“å­˜
- **ä¼˜åŒ–**: å‡å°‘ Registry æŸ¥è¯¢ï¼Œæå‡ Gas æ•ˆç‡

### [REMOVED] LiquidationViewLibrary.sol
- **çŠ¶æ€**: å·²ç§»é™¤ï¼ˆè§ git å˜æ›´ï¼‰
- **åŸå› **: è¯¥åº“å†å²å®ç°åŒ…å«ä¸å½“å‰æ¶æ„æŒ‡å—ä¸ä¸€è‡´çš„å£å¾„ä¸èŒè´£è¾¹ç•Œï¼ˆä¾‹å¦‚æ—§çš„ 1e18 å¥åº·å› å­ã€0-1000 é£é™©åˆ†æ•°ã€ä»¥åŠâ€œé¢„è§ˆ/æŸ¥è¯¢â€æ··æ‚çš„é€»è¾‘ï¼‰ï¼Œå®¹æ˜“é€ æˆé‡å¤å®ç°ä¸é“¾ä¸‹å£å¾„åˆ†å‰ã€‚
- **æ›¿ä»£æ–¹æ¡ˆï¼ˆSSOTï¼‰**ï¼š
  - **é£é™©è®¡ç®—ï¼ˆçº¯å‡½æ•°ï¼‰**ï¼š`LiquidationRiskLib`ï¼ˆå¥åº·å› å­ bpsã€é£é™©åˆ†æ•° 0-100ï¼‰
  - **åªè¯»èšåˆå–å€¼**ï¼š`LiquidationRiskQueryLib`ï¼ˆä» `KEY_LE` + `KEY_POSITION_VIEW` èšåˆå€ºåŠ¡/æŠµæŠ¼ä»·å€¼ï¼›ä¸ç›´æ¥è®¿é—® Oracle/GDï¼‰
  - **åªè¯»/ç¼“å­˜/äº‹ä»¶èšåˆ**ï¼šä¼˜å…ˆä½¿ç”¨å„ä¸“å± Viewï¼ˆå¦‚ `LiquidatorView`ã€`RiskView`ã€`HealthView` ç­‰ï¼‰

---

## ğŸ”„ å‡çº§æœºåˆ¶

æ‰€æœ‰æ¸…ç®—æ¨¡å—é‡‡ç”¨ **UUPS Proxy** æ¨¡å¼ï¼š

```solidity
// å‡çº§æµç¨‹
1. éƒ¨ç½²æ–°å®ç°åˆçº¦
2. è°ƒç”¨ upgradeTo(newImplementation)
   â””â”€> éœ€è¦ ACTION_UPGRADE_MODULE æƒé™
3. æ–°å®ç°è‡ªåŠ¨ç”Ÿæ•ˆ
```

---

## ğŸ“ ç±»å‹å®šä¹‰ï¼ˆLiquidationTypes.solï¼‰

### æ ¸å¿ƒç»“æ„ä½“

```solidity
// æ¸…ç®—å‚æ•°
struct LiquidationParams {
    address user;
    address collateralAsset;
    address debtAsset;
    uint256 collateralAmount;
    uint256 debtAmount;
    address liquidator;
}

// æ¸…ç®—ç»“æœ
struct LiquidationResult {
    uint256 seizedCollateral;
    uint256 reducedDebt;
    uint256 residualValue;
    ResidualAllocation allocation;
}

// é£é™©è¯„ä¼°
struct LiquidationRiskAssessment {
    bool liquidatable;
    uint256 riskScore;
    uint256 healthFactor;
    uint256 riskLevel;
    uint256 safetyMargin;
}
```

### å¸¸é‡

```solidity
DEFAULT_LIQUIDATION_THRESHOLD = 10_500  // 105% (åŸºç‚¹)
DEFAULT_LIQUIDATION_BONUS = 1_000      // 10% (åŸºç‚¹)
MIN_LIQUIDATION_THRESHOLD = 10_000      // 100%
MAX_LIQUIDATION_THRESHOLD = 15_000     // 150%
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. æ¸…ç®—å‰æ£€æŸ¥
- ä½¿ç”¨ `LiquidationRiskManager` æˆ– `HealthView` æŸ¥è¯¢å¥åº·å› å­
- ç¡®è®¤ç”¨æˆ·å¯æ¸…ç®—ï¼ˆ`healthFactor < liquidationThreshold`ï¼‰

### 2. æ¸…ç®—æ‰§è¡Œ
- **Keeper/æœºå™¨äººå…¥å£ï¼ˆæ¨èï¼‰**ï¼šé€šè¿‡ `SettlementManager.settleOrLiquidate(orderId)` ä½œä¸ºä¸»å…¥å£ï¼ˆSSOTï¼‰
- **å…¼å®¹/æµ‹è¯•å…¥å£ï¼ˆä¸æ¨èä½œä¸ºå¸¸æ€ï¼‰**ï¼š`LiquidationManager.liquidate(...)` ä»…ç”¨äºæµ‹è¯•/åº”æ€¥/æ‰‹å·¥æ¸…ç®—ï¼Œéœ€è¦æ˜¾å¼å‚æ•°
- ä¸è¦ç›´æ¥è°ƒç”¨ `CollateralManager` æˆ– `LendingEngine`

### 3. é”™è¯¯å¤„ç†
- ç›‘å¬ `CacheUpdateFailed` äº‹ä»¶ï¼Œå®ç°é“¾ä¸‹é‡è¯•æœºåˆ¶
- è´¦æœ¬å†™å…¥å¤±è´¥ä¼š revertï¼Œä½† View æ¨é€å¤±è´¥ä¸ä¼šå›æ»š

### 4. Gas ä¼˜åŒ–
- æ‰¹é‡æ¸…ç®— `batchLiquidate()` å±äº **æ˜¾å¼å‚æ•°æ‰§è¡Œå™¨å…¥å£**ï¼ˆrole-gatedï¼‰ï¼Œå¯ç”¨äºæµ‹è¯•/åº”æ€¥æ‰¹å¤„ç†ï¼›
  keeper å¸¸æ€ä¸»å…¥å£ä»åº”ä¸º `SettlementManager.settleOrLiquidate(orderId)`ï¼ˆSSOTï¼‰ï¼Œé¿å…å‚æ•°è®¡ç®—/æƒé™å£å¾„åˆ†å‰ã€‚
- åˆ©ç”¨ `ModuleCache` ç¼“å­˜æ¨¡å—åœ°å€

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- **æ¶æ„æŒ‡å—**: `docs/Architecture-Guide.md`
- **æ¸…ç®—æœºåˆ¶**: `docs/Usage-Guide/Liquidation/Liquidation-Mechanism-Logic.md`
- **å®Œæ•´é€»è¾‘**: `docs/Usage-Guide/Liquidation/liquidation-complete-logic.md`
- **æœ¯è¯­è¯´æ˜**: `docs/Architecture-Liquidation-DirectLedger-Terminology.md`

---

## ğŸ“Œ æ€»ç»“

æ¸…ç®—æ¨¡å—é‡‡ç”¨**æ¨¡å—åŒ–ã€å¯å‡çº§ã€ç›´è¾¾è´¦æœ¬**çš„è®¾è®¡ï¼š

1. **å”¯ä¸€å¯¹å¤–å†™å…¥å£ï¼ˆSSOTï¼‰**: `SettlementManager.settleOrLiquidate(orderId)` ä½œä¸º keeper/æœºå™¨äººçš„ä¸»å…¥å£
2. **æ¸…ç®—æ‰§è¡Œå™¨**: `LiquidationManager` ä½œä¸ºå†…éƒ¨æ¸…ç®—æ‰§è¡Œå™¨ï¼ˆç”± SettlementManager åœ¨æ¸…ç®—åˆ†æ”¯è°ƒç”¨ï¼‰
3. **ç›´è¾¾è´¦æœ¬**: ç›´æ¥è°ƒç”¨ `CollateralManager` å’Œ `LendingEngine`
4. **å•ç‚¹æ¨é€**: æˆåŠŸåæ¨é€åˆ° `LiquidatorView`ï¼ˆbest-effortï¼‰
5. **åªè¯»åˆ†ç¦»**: é£é™©è¯„ä¼°å’ŒæŸ¥è¯¢é€šè¿‡ `LiquidationRiskManager` å’Œ View å±‚
6. **æƒé™æ§åˆ¶**: é€šè¿‡ `AccessControlManager` ç»Ÿä¸€ç®¡ç†
7. **å¯å‡çº§æ€§**: æ‰€æœ‰æ¨¡å—æ”¯æŒ UUPS Proxy å‡çº§

è¿™ç§è®¾è®¡ç¡®ä¿äº†**èŒè´£æ¸…æ™°ã€Gas é«˜æ•ˆã€æ˜“äºç»´æŠ¤å’Œå‡çº§**ï¼Œå¹¶ç¬¦åˆ Architecture-Guide.md çš„ç»Ÿä¸€å…¥å£è¦æ±‚ã€‚
