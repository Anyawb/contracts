# æ¸…ç®—æ¨¡å—æ¶æ„åˆ†æä¸é“¾ä¸Šè¿è¡Œæµç¨‹

## ğŸ“ æ–‡ä»¶ç»“æ„æ¦‚è§ˆ

æ¸…ç®—æ¨¡å—ä½äº `src/Vault/liquidation/`ï¼Œé‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œåˆ†ä¸ºä¸‰ä¸ªä¸»è¦ç›®å½•ï¼š

```
src/Vault/liquidation/
â”œâ”€â”€ types/                          # ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ LiquidationTypes.sol       # æ¸…ç®—ç›¸å…³ç±»å‹ã€äº‹ä»¶ã€å¸¸é‡å®šä¹‰
â”‚   â””â”€â”€ LiquidationBase.sol        # åŸºç¡€åº“ï¼Œæä¾›å…¬å…±å­˜å‚¨ã€äº‹ä»¶ã€è¾…åŠ©å‡½æ•°
â”‚
â”œâ”€â”€ libraries/                      # åŠŸèƒ½åº“ï¼ˆ14ä¸ªåº“æ–‡ä»¶ï¼‰
â”‚   â”œâ”€â”€ LiquidationCoreOperations.sol      # æ ¸å¿ƒæ¸…ç®—æ“ä½œåº“ï¼ˆ910è¡Œï¼‰
â”‚   â”œâ”€â”€ LiquidationAccessControl.sol        # æƒé™æ§åˆ¶åº“ï¼ˆ497è¡Œï¼‰
â”‚   â”œâ”€â”€ LiquidationValidationLibrary.sol   # éªŒè¯åº“ï¼ˆ413è¡Œï¼‰
â”‚   â”œâ”€â”€ LiquidationViewLibrary.sol         # æŸ¥è¯¢åº“ï¼ˆ462è¡Œï¼‰
â”‚   â”œâ”€â”€ LiquidationInterfaceLibrary.sol    # æ¥å£å®ç°åº“ï¼ˆ690è¡Œï¼‰
â”‚   â”œâ”€â”€ LiquidationEventLibrary.sol        # äº‹ä»¶ç®¡ç†åº“ï¼ˆ886è¡Œï¼‰
â”‚   â”œâ”€â”€ LiquidationTokenLibrary.sol        # ä»£å¸æ“ä½œåº“ï¼ˆ478è¡Œï¼‰
â”‚   â”œâ”€â”€ LiquidationUtilityLibrary.sol       # é€šç”¨å·¥å…·åº“ï¼ˆ559è¡Œï¼‰
â”‚   â”œâ”€â”€ LiquidationRiskLib.sol              # é£é™©è®¡ç®—åº“
â”‚   â”œâ”€â”€ LiquidationRiskBatchLib.sol          # æ‰¹é‡é£é™©æŸ¥è¯¢åº“
â”‚   â”œâ”€â”€ LiquidationRiskCacheLib.sol         # é£é™©ç¼“å­˜åº“
â”‚   â”œâ”€â”€ LiquidationRiskQueryLib.sol         # é£é™©æŸ¥è¯¢åº“
â”‚   â”œâ”€â”€ LiquidationRegistryOpsLib.sol       # Registryæ“ä½œåº“
â”‚   â””â”€â”€ ModuleCache.sol                     # æ¨¡å—ç¼“å­˜åº“ï¼ˆ835è¡Œï¼‰
â”‚
â””â”€â”€ modules/                        # æ ¸å¿ƒæ¨¡å—ï¼ˆ13ä¸ªæ¨¡å—ï¼‰
    â”œâ”€â”€ LiquidationManager.sol              # â­ æ ¸å¿ƒï¼šå”¯ä¸€æ¸…ç®—å…¥å£
    â”œâ”€â”€ LiquidationRiskManager.sol          # é£é™©ç®¡ç†å™¨ï¼ˆé£é™©è¯„ä¼°ã€å¥åº·å› å­ï¼‰
    â”œâ”€â”€ LiquidationCollateralManager.sol     # æŠµæŠ¼ç‰©ç®¡ç†å™¨
    â”œâ”€â”€ LiquidationDebtManager.sol           # å€ºåŠ¡ç®¡ç†å™¨
    â”œâ”€â”€ LiquidationCalculator.sol            # æ¸…ç®—è®¡ç®—å™¨
    â”œâ”€â”€ LiquidationConfigManager.sol          # é…ç½®ç®¡ç†å™¨
    â”œâ”€â”€ LiquidationRecordManager.sol         # è®°å½•ç®¡ç†å™¨
    â”œâ”€â”€ LiquidationDebtRecordManager.sol     # å€ºåŠ¡è®°å½•ç®¡ç†å™¨
    â”œâ”€â”€ LiquidationRewardManager.sol         # å¥–åŠ±ç®¡ç†å™¨
    â”œâ”€â”€ LiquidationRewardDistributor.sol     # å¥–åŠ±åˆ†é…å™¨
    â”œâ”€â”€ LiquidationProfitStatsManager.sol    # åˆ©æ¶¦ç»Ÿè®¡ç®¡ç†å™¨
    â”œâ”€â”€ LiquidationGuaranteeManager.sol      # ä¿è¯é‡‘ç®¡ç†å™¨
    â””â”€â”€ LiquidationBatchQueryManager.sol     # æ‰¹é‡æŸ¥è¯¢ç®¡ç†å™¨
```

---

## ğŸ—ï¸ æ ¸å¿ƒæ¶æ„è®¾è®¡

### 1. æ¶æ„æ¨¡å¼ï¼š**ç›´è¾¾è´¦æœ¬ + å•ç‚¹æ¨é€**

æ ¹æ®æ¶æ„æŒ‡å—ï¼Œå½“å‰å®ç°é‡‡ç”¨**æ–¹æ¡ˆA**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             æ¸…ç®—ç³»ç»Ÿæ¶æ„ï¼ˆç›´è¾¾è´¦æœ¬æ¨¡å¼ï¼‰                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Registryï¼ˆæ¨¡å—æ³¨å†Œä¸­å¿ƒï¼‰
â”œâ”€â”€ KEY_LIQUIDATION_MANAGER â†’ LiquidationManagerï¼ˆå”¯ä¸€æ¸…ç®—å…¥å£ï¼‰
â”œâ”€â”€ KEY_CM â†’ CollateralManagerï¼ˆæŠµæŠ¼ç‰©æ‰˜ç®¡ï¼‰
â”œâ”€â”€ KEY_LE â†’ LendingEngineï¼ˆå€ºåŠ¡æ‰˜ç®¡ï¼‰
â”œâ”€â”€ KEY_LIQUIDATION_VIEW â†’ LiquidationViewï¼ˆåªè¯»è§†å›¾ + æ•°æ®æ¨é€ï¼‰
â”œâ”€â”€ KEY_HEALTH_VIEW â†’ HealthViewï¼ˆå¥åº·å› å­ç¼“å­˜ï¼‰
â””â”€â”€ KEY_LIQUIDATION_RISK_MANAGER â†’ LiquidationRiskManagerï¼ˆé£é™©è¯„ä¼°ï¼‰

å†™è·¯å¾„æµç¨‹ï¼š
LiquidationManager.liquidate()
  â”œâ”€â†’ CM.withdrawCollateralTo()      [ç›´è¾¾è´¦æœ¬ï¼šæ‰£æŠ¼æŠµæŠ¼]
  â”œâ”€â†’ LE.forceReduceDebt()            [ç›´è¾¾è´¦æœ¬ï¼šå‡å°‘å€ºåŠ¡]
  â””â”€â†’ LiquidationView.pushLiquidationUpdate()  [å•ç‚¹æ¨é€ï¼šæœ€ä½³åŠªåŠ›]
```

### 2. æ ¸å¿ƒæ¨¡å—èŒè´£

#### â­ **LiquidationManager**ï¼ˆå”¯ä¸€æ¸…ç®—å…¥å£ï¼‰
- **ä½ç½®**: `modules/LiquidationManager.sol`
- **èŒè´£**:
  - å”¯ä¸€æ¸…ç®—å†™å…¥å£ï¼Œä¸æ‰¿æ‹…åªè¯»èšåˆ
  - å‚æ•°éªŒè¯å’Œæƒé™æ ¡éªŒï¼ˆ`ACTION_LIQUIDATE`ï¼‰
  - ç›´æ¥è°ƒç”¨è´¦æœ¬å±‚ï¼ˆCM/LEï¼‰æ‰§è¡Œæ¸…ç®—
  - æˆåŠŸåå•ç‚¹æ¨é€åˆ° `LiquidationView`ï¼ˆbest-effortï¼Œå¤±è´¥ä¸å›æ»šï¼‰
- **å…³é”®æ–¹æ³•**:
  ```solidity
  function liquidate(
      address targetUser,
      address collateralAsset,
      address debtAsset,
      uint256 collateralAmount,
      uint256 debtAmount,
      uint256 bonus
  ) external
  
  function batchLiquidate(...) external  // æ‰¹é‡æ¸…ç®—
  ```

#### **LiquidationRiskManager**ï¼ˆé£é™©è¯„ä¼°ï¼‰
- **ä½ç½®**: `modules/LiquidationRiskManager.sol`
- **èŒè´£**:
  - å¥åº·å› å­è®¡ç®—å’Œé£é™©è¯„ä¼°
  - æ‰¹é‡é£é™©æŸ¥è¯¢å’Œç¼“å­˜ç®¡ç†
  - æ¸…ç®—é¢„è§ˆåŠŸèƒ½
- **ä¾èµ–åº“**: `LiquidationRiskLib`, `LiquidationRiskBatchLib`, `LiquidationRiskCacheLib`

#### **LiquidationCollateralManager**ï¼ˆæŠµæŠ¼ç‰©ç®¡ç†ï¼‰
- **ä½ç½®**: `modules/LiquidationCollateralManager.sol`
- **èŒè´£**: æŠµæŠ¼ç‰©æ‰£æŠ¼ã€è½¬ç§»ã€æŸ¥è¯¢ï¼ˆç²¾ç®€ç‰ˆï¼Œçº¦400è¡Œï¼‰

#### **LiquidationDebtManager**ï¼ˆå€ºåŠ¡ç®¡ç†ï¼‰
- **ä½ç½®**: `modules/LiquidationDebtManager.sol`
- **èŒè´£**: å€ºåŠ¡å‡å°‘ã€è®°å½•ã€æŸ¥è¯¢

---

## ğŸ”„ é“¾ä¸Šè¿è¡Œæµç¨‹

### é˜¶æ®µ1ï¼šéƒ¨ç½²ä¸åˆå§‹åŒ–

#### 1.1 éƒ¨ç½²é¡ºåºï¼ˆå‚è€ƒ `scripts/deploy/deploylocal.ts`ï¼‰

```typescript
// 1. éƒ¨ç½² LiquidationManagerï¼ˆUUPS Proxyï¼‰
deployed.LiquidationManager = await deployProxy('LiquidationManager', [
    deployed.Registry
]);

// 2. æˆæƒ ACTION_LIQUIDATE æƒé™
const acm = await ethers.getContractAt('AccessControlManager', deployed.AccessControlManager);
await acm.grantRole(ACTION_LIQUIDATE, deployed.LiquidationManager);

// 3. æ³¨å†Œåˆ° Registry
await registry.setModule(KEY_LIQUIDATION_MANAGER, deployed.LiquidationManager);

// 4. ï¼ˆå¯é€‰ï¼‰éƒ¨ç½² LiquidationRiskManagerï¼ˆéœ€è¦å…ˆéƒ¨ç½²åº“ï¼‰
const riskLib = await deployLibrary('LiquidationRiskLib');
const riskBatchLib = await deployLibrary('LiquidationRiskBatchLib');
const lrm = await deployProxy('LiquidationRiskManager', [
    deployed.Registry,
    initialMaxCacheDuration,
    initialMaxBatchSize
], {
    libraries: {
        LiquidationRiskLib: riskLib,
        LiquidationRiskBatchLib: riskBatchLib
    }
});
```

#### 1.2 æ¨¡å—æ³¨å†Œï¼ˆRegistryï¼‰

æ‰€æœ‰æ¸…ç®—ç›¸å…³æ¨¡å—é€šè¿‡ `ModuleKeys` æ³¨å†Œï¼š

```solidity
// æ ¸å¿ƒæ¨¡å—é”®
KEY_LIQUIDATION_MANAGER = keccak256("LIQUIDATION_MANAGER")
KEY_LIQUIDATION_RISK_MANAGER = keccak256("LIQUIDATION_RISK_MANAGER")
KEY_LIQUIDATION_VIEW = keccak256("LIQUIDATION_VIEW")
KEY_CM = keccak256("CM")  // CollateralManager
KEY_LE = keccak256("LE")  // LendingEngine
```

---

### é˜¶æ®µ2ï¼šæ¸…ç®—æ‰§è¡Œæµç¨‹

#### 2.1 æ¸…ç®—å‰å‡†å¤‡ï¼ˆé“¾ä¸‹/åªè¯»ï¼‰

```solidity
// 1. æŸ¥è¯¢å¥åº·å› å­ï¼ˆé€šè¿‡ LiquidationRiskManager æˆ– HealthViewï¼‰
LiquidationRiskManager.assessLiquidationRisk(user) 
  â†’ returns (LiquidationRiskAssessment)

// 2. è®¡ç®—æ¸…ç®—å‚æ•°ï¼ˆé“¾ä¸‹è®¡ç®—ï¼‰
// - collateralAmount: å¯æ¸…ç®—æŠµæŠ¼ç‰©æ•°é‡
// - debtAmount: å¯æ¸…ç®—å€ºåŠ¡æ•°é‡
// - bonus: æ¸…ç®—å¥–åŠ±ï¼ˆç”± keeper è®¡ç®—ï¼‰
```

#### 2.2 æ¸…ç®—æ‰§è¡Œï¼ˆå†™è·¯å¾„ï¼‰

```solidity
// è°ƒç”¨å…¥å£
LiquidationManager.liquidate(
    targetUser,
    collateralAsset,
    debtAsset,
    collateralAmount,
    debtAmount,
    bonus
)
```

**å†…éƒ¨æ‰§è¡Œæµç¨‹**ï¼š

```
1. æƒé™æ ¡éªŒ
   â””â”€> AccessControlManager.requireRole(ACTION_LIQUIDATE, msg.sender)
       â””â”€> æ£€æŸ¥è°ƒç”¨è€…æ˜¯å¦æœ‰æ¸…ç®—æƒé™

2. å‚æ•°éªŒè¯
   â””â”€> æ£€æŸ¥åœ°å€éé›¶ã€é‡‘é¢éé›¶

3. è·å–æ¨¡å—åœ°å€ï¼ˆé€šè¿‡ Registryï¼‰
   â”œâ”€> CM = Registry.getModuleOrRevert(KEY_CM)
   â””â”€> LE = Registry.getModuleOrRevert(KEY_LE)

4. æ‰£æŠ¼æŠµæŠ¼ç‰©ï¼ˆç›´è¾¾è´¦æœ¬ï¼‰
   â””â”€> CollateralManager.withdrawCollateralTo(
           targetUser,
           collateralAsset,
           collateralAmount,
           msg.sender  // æ¸…ç®—äººæ¥æ”¶æŠµæŠ¼ç‰©
       )
       â””â”€> å†…éƒ¨ä¼šæ ¡éªŒ ACTION_LIQUIDATE æƒé™ï¼ˆcaller = LiquidationManagerï¼‰

5. å‡å°‘å€ºåŠ¡ï¼ˆç›´è¾¾è´¦æœ¬ï¼‰
   â””â”€> LendingEngine.forceReduceDebt(
           targetUser,
           debtAsset,
           debtAmount
       )
       â””â”€> å†…éƒ¨ä¼šæ ¡éªŒ ACTION_LIQUIDATE æƒé™

6. å•ç‚¹æ¨é€ï¼ˆæœ€ä½³åŠªåŠ›ï¼Œå¤±è´¥ä¸å›æ»šï¼‰
   â””â”€> LiquidationView.pushLiquidationUpdate(
           user, collateralAsset, debtAsset,
           collateralAmount, debtAmount,
           liquidator, bonus, timestamp
       )
       â””â”€> å¦‚æœå¤±è´¥ï¼Œå‘å‡º CacheUpdateFailed äº‹ä»¶ä¾›é“¾ä¸‹é‡è¯•
```

#### 2.3 æ‰¹é‡æ¸…ç®—

```solidity
LiquidationManager.batchLiquidate(
    targetUsers[],
    collateralAssets[],
    debtAssets[],
    collateralAmounts[],
    debtAmounts[],
    bonuses[]
)
```

**æ‰¹é‡æµç¨‹**ï¼š
- å¾ªç¯æ‰§è¡Œå•ç¬”æ¸…ç®—é€»è¾‘ï¼ˆæ‰£æŠ¼ + å‡å€ºï¼‰
- æœ€åç»Ÿä¸€è°ƒç”¨ `LiquidationView.pushBatchLiquidationUpdate()`

---

### é˜¶æ®µ3ï¼šäº‹ä»¶ä¸æ•°æ®æ¨é€

#### 3.1 äº‹ä»¶æµ

```solidity
// 1. è´¦æœ¬å±‚äº‹ä»¶ï¼ˆç”± CM/LE å‘å‡ºï¼‰
CollateralManager.CollateralWithdrawn(...)
LendingEngine.DebtReduced(...)

// 2. æ¸…ç®—äº‹ä»¶ï¼ˆç”± LiquidationView å‘å‡ºï¼‰
LiquidationView.LiquidationExecuted(
    liquidator,
    user,
    collateralAsset,
    debtAsset,
    collateralAmount,
    debtAmount,
    bonus,
    timestamp
)

// 3. å¤±è´¥äº‹ä»¶ï¼ˆå¦‚æœæ¨é€å¤±è´¥ï¼‰
LiquidationManager.CacheUpdateFailed(
    user, asset, viewAddr,
    collateral, debt, reason
)
```

#### 3.2 æ•°æ®æ¨é€æœºåˆ¶

- **æ¨é€ç›®æ ‡**: `LiquidationView`ï¼ˆé€šè¿‡ `KEY_LIQUIDATION_VIEW` è·å–ï¼‰
- **æ¨é€æ–¹å¼**: 
  - å•ç¬”: `pushLiquidationUpdate()`
  - æ‰¹é‡: `pushBatchLiquidationUpdate()`
- **å®¹é”™æœºåˆ¶**: 
  - å¦‚æœ View åˆçº¦ä¸å­˜åœ¨æˆ–è°ƒç”¨å¤±è´¥ï¼Œå‘å‡º `CacheUpdateFailed` äº‹ä»¶
  - **ä¸å›æ»šè´¦æœ¬å†™å…¥**ï¼ˆbest-effort åŸåˆ™ï¼‰

---

## ğŸ” æƒé™æ§åˆ¶

### æƒé™é”®ï¼ˆActionKeysï¼‰

```solidity
ACTION_LIQUIDATE = keccak256("LIQUIDATE")           // æ¸…ç®—æƒé™
ACTION_LIQUIDATE_PARTIAL = keccak256("LIQUIDATE_PARTIAL")  // éƒ¨åˆ†æ¸…ç®—
ACTION_ADMIN = keccak256("ADMIN")                   // ç®¡ç†å‘˜æƒé™
ACTION_UPGRADE_MODULE = keccak256("UPGRADE_MODULE") // å‡çº§æƒé™
```

### æƒé™æˆäºˆæµç¨‹

```solidity
// 1. æˆäºˆ LiquidationManager æ¸…ç®—æƒé™ï¼ˆéƒ¨ç½²æ—¶ï¼‰
AccessControlManager.grantRole(ACTION_LIQUIDATE, LiquidationManager)

// 2. æˆäºˆå¤–éƒ¨æ¸…ç®—äººï¼ˆkeeper/æœºå™¨äººï¼‰
AccessControlManager.grantRole(ACTION_LIQUIDATE, liquidatorAddress)

// 3. æ¸…ç®—æ—¶æ ¡éªŒ
LiquidationManager.liquidate() 
  â†’ _requireRole(ACTION_LIQUIDATE, msg.sender)
  â†’ AccessControlManager.requireRole(ACTION_LIQUIDATE, msg.sender)
```

---

## ğŸ“Š æ•°æ®æµä¸çŠ¶æ€å˜æ›´

### æ¸…ç®—å‰çŠ¶æ€

```
ç”¨æˆ·è´¦æˆ·çŠ¶æ€ï¼š
â”œâ”€â”€ CollateralManager: æŠµæŠ¼ç‰©ä½™é¢ = 100 USDC
â””â”€â”€ LendingEngine: å€ºåŠ¡ä½™é¢ = 60 USDC

å¥åº·å› å­ = (æŠµæŠ¼ç‰©ä»·å€¼ / å€ºåŠ¡ä»·å€¼) = 100/60 = 166.67% > 105%ï¼ˆå®‰å…¨ï¼‰
```

### æ¸…ç®—æ‰§è¡Œ

```
1. æ‰£æŠ¼æŠµæŠ¼ç‰©: 100 USDC â†’ æ¸…ç®—äºº
   CollateralManager.withdrawCollateralTo(user, USDC, 100, liquidator)
   
2. å‡å°‘å€ºåŠ¡: 60 USDC
   LendingEngine.forceReduceDebt(user, USDC, 60)
```

### æ¸…ç®—åçŠ¶æ€

```
ç”¨æˆ·è´¦æˆ·çŠ¶æ€ï¼š
â”œâ”€â”€ CollateralManager: æŠµæŠ¼ç‰©ä½™é¢ = 0 USDC
â””â”€â”€ LendingEngine: å€ºåŠ¡ä½™é¢ = 0 USDC

æ¸…ç®—äººè·å¾—: 100 USDCï¼ˆåŒ…å« bonusï¼‰
```

---

## ğŸ› ï¸ å…³é”®åº“æ–‡ä»¶è¯´æ˜

### LiquidationCoreOperations.sol
- **åŠŸèƒ½**: æ ¸å¿ƒæ¸…ç®—æ“ä½œ
- **åŒ…å«**: å¥åº·å› å­è®¡ç®—ã€é£é™©è¯„åˆ†ã€æ¸…ç®—æ£€æŸ¥ã€å¥–åŠ±è®¡ç®—

### LiquidationRiskLib.sol
- **åŠŸèƒ½**: é£é™©è¯„ä¼°è®¡ç®—
- **åŒ…å«**: å¥åº·å› å­è®¡ç®—ã€é£é™©ç­‰çº§åˆ¤å®šã€å®‰å…¨è¾¹é™…è®¡ç®—

### ModuleCache.sol
- **åŠŸèƒ½**: æ¨¡å—åœ°å€ç¼“å­˜
- **ä¼˜åŒ–**: å‡å°‘ Registry æŸ¥è¯¢ï¼Œæå‡ Gas æ•ˆç‡

### LiquidationViewLibrary.sol
- **åŠŸèƒ½**: åªè¯»æŸ¥è¯¢
- **åŒ…å«**: å¥åº·å› å­æŸ¥è¯¢ã€æŠµæŠ¼ç‰©æŸ¥è¯¢ã€å€ºåŠ¡æŸ¥è¯¢ã€é¢„è§ˆåŠŸèƒ½

---

## ğŸ”„ å‡çº§æœºåˆ¶

æ‰€æœ‰æ¸…ç®—æ¨¡å—é‡‡ç”¨ **UUPS Proxy** æ¨¡å¼ï¼š

```solidity
// å‡çº§æµç¨‹
1. éƒ¨ç½²æ–°å®ç°åˆçº¦
2. è°ƒç”¨ upgradeTo(newImplementation)
   â””â”€> éœ€è¦ ACTION_UPGRADE_MODULE æƒé™
3. æ–°å®ç°è‡ªåŠ¨ç”Ÿæ•ˆ
```

---

## ğŸ“ ç±»å‹å®šä¹‰ï¼ˆLiquidationTypes.solï¼‰

### æ ¸å¿ƒç»“æ„ä½“

```solidity
// æ¸…ç®—å‚æ•°
struct LiquidationParams {
    address user;
    address collateralAsset;
    address debtAsset;
    uint256 collateralAmount;
    uint256 debtAmount;
    address liquidator;
}

// æ¸…ç®—ç»“æœ
struct LiquidationResult {
    uint256 seizedCollateral;
    uint256 reducedDebt;
    uint256 residualValue;
    ResidualAllocation allocation;
}

// é£é™©è¯„ä¼°
struct LiquidationRiskAssessment {
    bool liquidatable;
    uint256 riskScore;
    uint256 healthFactor;
    uint256 riskLevel;
    uint256 safetyMargin;
}
```

### å¸¸é‡

```solidity
DEFAULT_LIQUIDATION_THRESHOLD = 10_500  // 105% (åŸºç‚¹)
DEFAULT_LIQUIDATION_BONUS = 1_000      // 10% (åŸºç‚¹)
MIN_LIQUIDATION_THRESHOLD = 10_000      // 100%
MAX_LIQUIDATION_THRESHOLD = 15_000     // 150%
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. æ¸…ç®—å‰æ£€æŸ¥
- ä½¿ç”¨ `LiquidationRiskManager` æˆ– `HealthView` æŸ¥è¯¢å¥åº·å› å­
- ç¡®è®¤ç”¨æˆ·å¯æ¸…ç®—ï¼ˆ`healthFactor < liquidationThreshold`ï¼‰

### 2. æ¸…ç®—æ‰§è¡Œ
- é€šè¿‡ `LiquidationManager` ä½œä¸ºå”¯ä¸€å…¥å£
- ä¸è¦ç›´æ¥è°ƒç”¨ `CollateralManager` æˆ– `LendingEngine`

### 3. é”™è¯¯å¤„ç†
- ç›‘å¬ `CacheUpdateFailed` äº‹ä»¶ï¼Œå®ç°é“¾ä¸‹é‡è¯•æœºåˆ¶
- è´¦æœ¬å†™å…¥å¤±è´¥ä¼š revertï¼Œä½† View æ¨é€å¤±è´¥ä¸ä¼šå›æ»š

### 4. Gas ä¼˜åŒ–
- ä½¿ç”¨æ‰¹é‡æ¸…ç®— `batchLiquidate()` å‡å°‘äº¤æ˜“æ¬¡æ•°
- åˆ©ç”¨ `ModuleCache` ç¼“å­˜æ¨¡å—åœ°å€

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- **æ¶æ„æŒ‡å—**: `docs/Architecture-Guide.md`
- **æ¸…ç®—æœºåˆ¶**: `docs/Usage-Guide/Liquidation/Liquidation-Mechanism-Logic.md`
- **å®Œæ•´é€»è¾‘**: `docs/Usage-Guide/Liquidation/liquidation-complete-logic.md`
- **æœ¯è¯­è¯´æ˜**: `docs/Architecture-Liquidation-DirectLedger-Terminology.md`

---

## ğŸ“Œ æ€»ç»“

æ¸…ç®—æ¨¡å—é‡‡ç”¨**æ¨¡å—åŒ–ã€å¯å‡çº§ã€ç›´è¾¾è´¦æœ¬**çš„è®¾è®¡ï¼š

1. **å”¯ä¸€å…¥å£**: `LiquidationManager` ä½œä¸ºæ¸…ç®—å†™å…¥å£
2. **ç›´è¾¾è´¦æœ¬**: ç›´æ¥è°ƒç”¨ `CollateralManager` å’Œ `LendingEngine`
3. **å•ç‚¹æ¨é€**: æˆåŠŸåæ¨é€åˆ° `LiquidationView`ï¼ˆbest-effortï¼‰
4. **åªè¯»åˆ†ç¦»**: é£é™©è¯„ä¼°å’ŒæŸ¥è¯¢é€šè¿‡ `LiquidationRiskManager` å’Œ View å±‚
5. **æƒé™æ§åˆ¶**: é€šè¿‡ `AccessControlManager` ç»Ÿä¸€ç®¡ç†
6. **å¯å‡çº§æ€§**: æ‰€æœ‰æ¨¡å—æ”¯æŒ UUPS Proxy å‡çº§

è¿™ç§è®¾è®¡ç¡®ä¿äº†**èŒè´£æ¸…æ™°ã€Gas é«˜æ•ˆã€æ˜“äºç»´æŠ¤å’Œå‡çº§**ã€‚
